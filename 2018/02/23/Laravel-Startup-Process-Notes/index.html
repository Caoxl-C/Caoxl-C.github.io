<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>laravel 执行流程 | Keep It Simple And Stupid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="Laravel">
  
  
  
  
  <meta name="description" content="分析Laravel执行流程.">
<meta name="keywords" content="Laravel">
<meta property="og:type" content="article">
<meta property="og:title" content="Laravel 执行流程">
<meta property="og:url" content="http://blog.caoxl.com/2018/02/23/Laravel-Startup-Process-Notes/index.html">
<meta property="og:site_name" content="Keep It Simple And Stupid">
<meta property="og:description" content="分析Laravel执行流程.">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201506/18/1795/JTaL9Qxyp9.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201506/18/1795/yqHs8C9jDt.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201509/25/1795/R8XmO21d3w.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201509/25/1795/YyxYu1Zwgt.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/03/1795/7pnmO6Voq1.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/03/1795/drL6WHCQ7W.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/03/1795/sx1BrfDkn7.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/03/1795/rOP6CGGP48.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/10/1795/NdBLrcYpC9.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/10/1795/EIAGw7jAmf.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/10/1795/pj8Sx0TxlN.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/Ciz5dr12oy.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/WmnBG5Ev0F.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/XL9V5n1Beo.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/8NQoEW5bJL.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/ZqwZwsOT1R.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/yxp8OFpGgg.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/bNksZTr6dg.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/S6Hb7woErL.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/aOLf1dKNUM.png">
<meta property="og:image" content="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/ZOBmtPpgVQ.png">
<meta property="og:updated_time" content="2019-08-22T03:55:34.293Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Laravel 执行流程">
<meta name="twitter:description" content="分析Laravel执行流程.">
<meta name="twitter:image" content="https://dn-phphub.qbox.me/uploads/images/201506/18/1795/JTaL9Qxyp9.png">
  
    <link rel="alternate" href="/atom.xml" title="Keep It Simple And Stupid" type="application/atom+xml">
  

  

  <link rel="icon" href="http://caoxl.com/imgs/we-min.jpg">
  <link rel="apple-touch-icon" href="/http://caoxl.com/imgs/we-min.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">

  
    <link rel="stylesheet" href="/css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css">
  

  
  
  

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="http://caoxl.com/imgs/we-min.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">分类</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-Laravel-Startup-Process-Notes" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      Laravel 执行流程
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/02/23/Laravel-Startup-Process-Notes/" class="article-date">
	  <time datetime="2018-02-23T02:47:55.000Z" itemprop="datePublished">2018-02-23</time>
	</a>

      
    <a class="article-category-link" href="/categories/Laravel-Lumen/">Laravel / Lumen</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>

    <div class="article-entry" itemprop="articleBody">
      
        
        
          <p>分析Laravel执行流程.</p>
<a id="more"></a>
<h1 id="一、自动加载"><a href="#一、自动加载" class="headerlink" title="一、自动加载"></a>一、自动加载</h1><h2 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h2><blockquote>
<ul>
<li>从 <code>public/index.php</code> 定位到 <code>bootstrap/autoload.php</code></li>
<li>从 <code>bootstrap/autoload.php</code> 定位到 <code>_vendor/autoload.php</code></li>
<li>从 <code>vendor/autoload.php</code> 定位到 <code>__DIR__ . &#39;/composer&#39; . &#39;/autoload_real.php&#39;;</code></li>
</ul>
</blockquote>
<p>定位完毕, 你会看到这样的代码:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> ComposerAutoloaderInitda859f5bf8329e41e463c784e73d3cdf::getLoader();</span><br></pre></td></tr></table></figure>
<p><strong>ComposerAutoloaderInitda859f5bf8329e41e463c784e73d3cdf</strong> 简称<strong>本类</strong></p>
<p>那我们就从 <code>getLoader()</code> 方法入手。</p>
<h2 id="getLoader"><a href="#getLoader" class="headerlink" title="getLoader()"></a><code>getLoader()</code></h2><p>文件位于： <code>__DIR__ . &#39;/composer&#39; . &#39;/autoload_real.php&#39;</code>;</p>
<p>逻辑顺序：</p>
<p>一、如果静态变量 <code>$loader</code> 不为空则返回 <code>$loader</code>,</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (null !== <span class="keyword">self</span>::<span class="variable">$loader</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>::<span class="variable">$loader</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>二、注册一个自动加载程序，加载程序为本类的 <code>loadClassLoader()</code> 方法,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spl_autoload_register(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInitda859f5bf8329e41e463c784e73d3cdf'</span>, <span class="string">'loadClassLoader'</span>), <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</span><br></pre></td></tr></table></figure>
<p><strong><code>[loadClassLoader 方法逻辑]</code></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClassLoader</span><span class="params">($class)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'Composer\Autoload\ClassLoader'</span> === $class) &#123;</span><br><span class="line">        <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/ClassLoader.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>静态方法，含有一个 <code>$class</code> 参数，判断如果 <code>$class</code> 等于 <code>Composer\Autoload\ClassLoader</code>，则载入当前目录下 的 <code>ClassLoader.php</code> 文件，实际上是在为这句代码工作：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>::<span class="variable">$loader</span> = <span class="variable">$loader</span> = new \Composer\Autoload\ClassLoader();</span><br></pre></td></tr></table></figure>
<p>三、<code>$loader</code> 得到 <code>ClassLoader</code> 类（<code>\Composer\Autoload\ClassLoader</code>）的一个实例，卸载自动加载程序 <code>loadClassLoader</code>，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</span><br><span class="line"></span><br><span class="line">spl_autoload_unregister(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit022a3829915a6a8f070076dbcb34819c'</span>, <span class="string">'loadClassLoader'</span>));</span><br></pre></td></tr></table></figure>
<p>四、载入路径信息，设置路径信息，</p>
<p>五、载入一些 <code>autoload_x.php</code> 形式的文件，</p>
<p>分别有:</p>
<ul>
<li><code>autoload_namespaces.php</code></li>
<li><code>autoload_psr4.php</code></li>
<li><code>autoload_classmap.php</code></li>
</ul>
<p>并进行各自的循环 set 操作，如 </p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$loader</span>-&gt;set(<span class="variable">$namespace</span>, <span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$loader</span>-&gt;setPsr4(<span class="variable">$namespace</span>, <span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$loader</span>-&gt;addClassMap(<span class="variable">$classMap</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>【set 函数】2个参数，<code>一个前缀</code>，<code>一个路径</code>。如果前缀非真，将 <code>paths</code> 转为数组类型赋值给类成员变量<code>fallbackDirsPsr0</code>，如果前缀为真，则将路径赋值给 <code>$this-&gt;prefixesPsr0[$prefix[0]][$prefix]</code> ，这个写法的意思等同于字母索引，比如 <code>phpDocumentor</code> ，则数组就图所示：</p>
</blockquote>
<p> <img src="https://dn-phphub.qbox.me/uploads/images/201506/18/1795/JTaL9Qxyp9.png" alt></p>
<p> 六、执行一个 <code>$loader-&gt;register(true);</code>,</p>
<p><strong>[register 方法逻辑]</strong></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$loader</span>-&gt;register(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<p>一个布尔值参数，将传给 <code>spl_autoload_register</code> 第三个参数中。 而自动加载程序为：<code>array($this, &#39;loadClass&#39;)</code>，也就是本类的 <code>loadClass()</code> 方法。</p>
<p><strong>[loadClass 方法逻辑]</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClass</span><span class="params">($class)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($file = <span class="keyword">$this</span>-&gt;findFile($class)) &#123;</span><br><span class="line">        includeFile($file);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个 <code>$class</code> 参数，用了 <code>findFile()</code> 方法判断文件是否存在，存在则调用函数 <code>includeFile()</code> 载入文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">includeFile</span><span class="params">($file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">include</span> $file;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>七、还载入了一个<code>autoload_files.php</code>，而里面也是一组文件数组，貌似预加载一些函数库文件吧，没有继续深入这里了。</p>
<ul>
<li><code>verdor/composer/autoload_files.php</code></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($useStaticLoader) &#123;</span><br><span class="line">    $includeFiles = Composer\Autoload\ComposerStaticInit022a3829915a6a8f070076dbcb34819c::$files;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $includeFiles = <span class="keyword">require</span> __DIR_<span class="number">_</span> . <span class="string">'/autoload_files.php'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>八、最后返回一个 <code>$loader</code> 变量，也就是 <code>ClassLoader</code> 类的实例。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> ($includeFiles <span class="keyword">as</span> $fileIdentifier =&gt; $file) &#123;</span><br><span class="line">    composerRequire022a3829915a6a8f070076dbcb34819c($fileIdentifier, $file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $loader;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">composerRequire022a3829915a6a8f070076dbcb34819c</span><span class="params">($fileIdentifier, $file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($GLOBALS[<span class="string">'__composer_autoload_files'</span>][$fileIdentifier])) &#123;</span><br><span class="line">        <span class="keyword">require</span> $file;</span><br><span class="line"></span><br><span class="line">        $GLOBALS[<span class="string">'__composer_autoload_files'</span>][$fileIdentifier] = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好了，现在看看 <code>$loader</code> 这个实例到此拥有些什么？部分截图所示：</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201506/18/1795/yqHs8C9jDt.png" alt="$loader"></p>
<p>可以看出类属性包含了具有字母索引的一些命名空间，文件路径等信息。这和刚才载入那几个文件进行 <code>set</code> 操作有关，想起来了吗？</p>
<p>到此 <code>getLoader()</code> 方法逻辑结束。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>实现<strong>自动化</strong>的关键代码是 <code>vendor/autoload.php</code> 的 <code>::getLoader()</code> 静态方法， 利用此方法内部的 <code>$loader-&gt;register(true)</code>; 方法<strong>注册自动化载入方法</strong>，这样，当 <code>new</code> 对象的时候自动触发 <code>loadClass()</code> 了，而上面提到的 <code>set</code> 一些路径信息，正是自动化的必备条.</p>
<p>如有兴趣可以自行查看 <code>vendor/composer/ClassLoader.php</code> 的 <code>loadClass()</code> 方法代码细节。</p>
<blockquote>
<p>上面如果没懂的，请打开文件代码，跟着慢慢走，慢慢看，一定能懂。</p>
</blockquote>
<p>再返回到 <code>vendor/autoload.php</code>，再把 <code>return $loader</code> 返回到上一层。 即 <code>bootstrap/autoload.php</code>， </p>
<p>这行的代码 <code>require __DIR__.&#39;/../vendor/autoload.php</code>‘; </p>
<p>我们 <code>var_dump()</code> 下 <code>require</code> 的返回值，和刚才 <code>$loader</code> 的部分截图完全一致。 其实有从 <code>aotuload_real.php</code> 文件开始，我尝试过删除 <code>return</code>，也没有任何报错，不知道这里的 <code>return</code> 意义为何</p>
<p>再看 <code>index.php</code> 定位到了 <code>bootstrap/app.php</code> 打开就看到第一个</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</span><br><span class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>下面来详细介绍:</p>
<h1 id="Container-类"><a href="#Container-类" class="headerlink" title="Container 类"></a>Container 类</h1><h2 id="定位-1"><a href="#定位-1" class="headerlink" title="定位"></a>定位</h2><ul>
<li>来到 <code>bootstrap/app.php</code></li>
</ul>
<p>发现一段英文注释:</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">| Create The Application</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">|</span><br><span class="line">| The first thing we will do is create a<span class="built_in"> new </span>Laravel application instance</span><br><span class="line">| which serves as the <span class="string">"glue"</span> for all the components of Laravel,<span class="built_in"> and </span>is</span><br><span class="line">| the IoC container for the<span class="keyword"> system</span> binding all of the various parts.</span><br><span class="line">|</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>翻译过来:</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/ *</span><br><span class="line"><span class="string">| --------------------------------------------------------------------------</span></span><br><span class="line"><span class="string">|创建应用程序</span></span><br><span class="line"><span class="string">| --------------------------------------------------------------------------</span></span><br><span class="line"><span class="string">|</span></span><br><span class="line"><span class="string">|我们首先要做的是创建一个新的 laravel 应用实例</span></span><br><span class="line"><span class="string">|作为“胶水”用于 laravel 的所有组件，并</span></span><br><span class="line"><span class="string">|为系统结合各种零件的 IOC 容器。</span></span><br><span class="line"><span class="string">|</span></span><br><span class="line">* /</span><br></pre></td></tr></table></figure>
<blockquote>
<p>换句话说，把这个<strong>对象实例</strong>作为一个可依靠稳固的<strong>地基</strong>，来存放各种<strong>“建筑物（组件）”</strong>，So <strong>地基= IOC 容器？</strong> 好复杂有木有，不管它了，读代码去吧，读代码就像聊天，得用心倾听别人的心声。</p>
</blockquote>
<p>紧接着 <code>new</code> 了一个对象。 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</span><br><span class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><code>new Illuminate\Foundation\Application()</code> 构造函数做了什么？</p>
<p><code>Application</code> 类还传入了当前 laravel 根目录的地址这样一个参数。如 <code>“D:\webSite\Laravel”</code> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($basePath = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($basePath) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setBasePath($basePath);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerBaseBindings();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerBaseServiceProviders();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerCoreContainerAliases();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>命名空间 <code>Illuminate</code> 的具体文件路径位于 <code>Vendor/laravel/framework/src/Illuminate</code>。</p>
<p>打开文件: <code>Vendor/laravel/framework/src/Illuminate/Application.php</code></p>
<p>到这里: <code>class Application extends Container implements ApplicationContract, HttpKernelInterface</code></p>
<p>继承 <code>Container</code> 类，对应上面的use：<code>use Illuminate\Container\Container</code>; 并且要实现2个接口: <code>ApplicationContract</code>，<code>HttpKernelInterface</code></p>
<p> 咱们先看看这个 <code>Container</code> 类到底是什么。 怎么找具体文件上面已经说过了，下面就直接略过，直接打开 <code>Container.php</code>。</p>
<h2 id="Container-类-1"><a href="#Container-类-1" class="headerlink" title="Container 类"></a><code>Container</code> 类</h2><ul>
<li><code>Vendor/laravel/framework/src/Illuminate/Container/Container.php</code></li>
</ul>
<p><code>The ArrayAccess interface</code> 数据访问接口，PHP5的一个新接口，<strong>接口提供访问对象数组</strong>。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="symbol">Container</span> <span class="symbol">implements</span> <span class="symbol">ArrayAccess, <span class="symbol">ContainerContract</span></span></span><br></pre></td></tr></table></figure>
<p>需要实现四个方法:</p>
<ul>
<li><code>abstract public boolean offsetExists ( mixed $offset )</code></li>
<li><code>abstract public mixed offsetGet ( mixed $offset )</code></li>
<li><code>abstract public void offsetSet ( mixed $offset , mixed $value )</code></li>
<li><code>abstract public void offsetUnset ( mixed $offset )</code></li>
</ul>
<p>先不用懂这4个方法是什么意思，看看 <code>Container</code> 类怎么实现的就懂了。</p>
<h3 id="offsetExists"><a href="#offsetExists" class="headerlink" title="offsetExists"></a><code>offsetExists</code></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetExists</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bound($key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bound</span><span class="params">($abstract)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;bindings[$abstract]) ||</span><br><span class="line">           <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract]) ||</span><br><span class="line">           <span class="keyword">$this</span>-&gt;isAlias($abstract);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当外部使用 <code>isset()</code> 函数时触发此方法，而方法内部则也是使用一个 <code>isset</code> 来判断返回一个 <code>bool</code> 值。这个 <code>bindings</code> 先不管，我们主要知道这个方法做了什么事情。</p>
<h3 id="offsetGet"><a href="#offsetGet" class="headerlink" title="offsetGet"></a><code>offsetGet</code></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetGet</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;make($key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当外部尝试获取 <code>$key</code> 的时候，如 <code>echo</code> ,<code>print_r</code>,<code>var_dump</code>，赋值等。 就会触发此方法，而方法内部也是直接一个 <code>reutrn</code>，简单！</p>
<h3 id="offsetSet"><a href="#offsetSet" class="headerlink" title="offsetSet"></a><code>offsetSet</code></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetSet</span><span class="params">($key, $value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;bind($key, $value <span class="keyword">instanceof</span> Closure ? $value : <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $value;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当外部尝试赋值的时候，则触发此方法。 此方法内部先进行一个 <code>instanceof</code> 判断 如果 <code>value</code> 参数不是一个闭包，则将 <code>$value</code> 封装成一个闭包，而闭包函数的内部直接一个 <code>return</code>。</p>
<h3 id="offsetUnset"><a href="#offsetUnset" class="headerlink" title="offsetUnset"></a><code>offsetUnset</code></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetUnset</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;bindings[$key], <span class="keyword">$this</span>-&gt;instances[$key], <span class="keyword">$this</span>-&gt;resolved[$key]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当外部尝试使用 <code>unset</code> 函数的时候触发此方法， 方法内部是一个 <code>unset</code> 函数，那些变量看不懂，先不管。</p>
<p>这就是 <code>ArrayAccess</code>，一个类实现它的4个方法，在<strong>不同操作时触发4个方法</strong>，知道这些就够了，具体调用的示例这里我没有举出来，PHP 官网有，请自行翻阅,锻炼下动手能力。</p>
<p>好吧继续往下看;</p>
<ul>
<li><code>ReflectionMethod</code> 针对类方法</li>
<li><code>ReflectionFunction</code> 针对普通函数</li>
<li><code>ReflectionParameter</code> 针对函数的参数</li>
</ul>
<p>具体代码演示如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/* ReflectionMethod 示例</span><br><span class="line"><span class="variable">$a</span> = new ReflectionMethod(<span class="string">'index\index'</span>,<span class="string">'a'</span>);</span><br><span class="line">var_dump(<span class="variable">$a</span>-&gt;isAbstract()); //<span class="literal">false</span></span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">/* ReflectionParameter 示例</span><br><span class="line"><span class="variable">$a</span> = new ReflectionParameter(<span class="string">'index\b'</span>,2);</span><br><span class="line">var_dump(<span class="variable">$a</span>-&gt;getName()); //string(1) <span class="string">"d"</span></span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">/* ReflectionFunction 示例</span><br><span class="line"><span class="variable">$a</span> = new ReflectionFunction(<span class="string">'index\b'</span>);</span><br><span class="line">var_dump(<span class="variable">$a</span>-&gt;getParameters());</span><br><span class="line">array(3) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  &amp;object(ReflectionParameter)<span class="comment">#2 (1) &#123;</span></span><br><span class="line">    [<span class="string">"name"</span>]=&gt;</span><br><span class="line">    string(1) <span class="string">"b"</span></span><br><span class="line">  &#125;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  &amp;object(ReflectionParameter)<span class="comment">#3 (1) &#123;</span></span><br><span class="line">    [<span class="string">"name"</span>]=&gt;</span><br><span class="line">    string(1) <span class="string">"c"</span></span><br><span class="line">  &#125;</span><br><span class="line">  [2]=&gt;</span><br><span class="line">  &amp;object(ReflectionParameter)<span class="comment">#4 (1) &#123;</span></span><br><span class="line">    [<span class="string">"name"</span>]=&gt;</span><br><span class="line">    string(1) <span class="string">"d"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>然后看到 <code>Container</code> 类还实现这个接口 <code>ContainerContract</code>。</p>
<p>对应 <code>use Illuminate\Contracts\Container\Container as ContainerContract</code>;</p>
<p>提示：<code>Contracts</code> 翻译 <em>“合同、契约”</em>。</p>
<p>接口里面的方法有兴趣可自行查看，我们主要看 <code>Container</code> 的实现这些方法的细节。</p>
<blockquote>
<p>最后我们简述下 Contracts 作为本章结束语： 我的理解是一系列组件服务的接口集合</p>
</blockquote>
<h1 id="探索-Application-构造函数"><a href="#探索-Application-构造函数" class="headerlink" title="探索 Application 构造函数"></a>探索 Application 构造函数</h1><h2 id="定位-2"><a href="#定位-2" class="headerlink" title="定位"></a>定位</h2><ul>
<li>OK，从入口地址 <code>public/index.php</code> 看到如下代码：</li>
</ul>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">|<span class="comment">--------------------------------------------------------------------------</span></span><br><span class="line">| Turn On The Lights</span><br><span class="line">|<span class="comment">--------------------------------------------------------------------------</span></span><br><span class="line">|</span><br><span class="line">| We need <span class="keyword">to</span> illuminate PHP development, so let us turn <span class="keyword">on</span> <span class="keyword">the</span> lights.</span><br><span class="line">| This bootstraps <span class="keyword">the</span> framework <span class="keyword">and</span> gets <span class="keyword">it</span> ready <span class="keyword">for</span> use, <span class="keyword">then</span> <span class="keyword">it</span></span><br><span class="line">| will load up this <span class="built_in">application</span> so <span class="keyword">that</span> we can <span class="built_in">run</span> <span class="keyword">it</span> <span class="keyword">and</span> send</span><br><span class="line">| <span class="keyword">the</span> responses <span class="keyword">back</span> <span class="keyword">to</span> <span class="keyword">the</span> browser <span class="keyword">and</span> delight our users.</span><br><span class="line">|</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">$app = require_once __DIR__.'/../bootstrap/app.php';</span><br></pre></td></tr></table></figure>
<p><strong>翻译:</strong></p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201509/25/1795/R8XmO21d3w.png" alt></p>
<p>注释很有趣，翻译凑合看吧。 则现在我们打开 <code>bootstarp/app.php</code> 文件，因为这是 <code>$app</code> 这个玩意儿的出生地。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| Create The Application</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| The first thing we will do is create a new Laravel application instance</span></span><br><span class="line"><span class="comment">| which serves as the "glue" for all the components of Laravel, and is</span></span><br><span class="line"><span class="comment">| the IoC container for the system binding all of the various parts.</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</span><br><span class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><strong>翻译:</strong></p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201509/25/1795/YyxYu1Zwgt.png" alt></p>
<h2 id="Application-php"><a href="#Application-php" class="headerlink" title="Application.php"></a><code>Application.php</code></h2><p>咱们就从在这里摸索一下构造函数里面发生了什么，打开 <code>Application.php</code> 文件。</p>
<p>打开的 <code>Application.php</code> 是位于 <code>vendor/laravel/framework/src/Illuminate/Foundation/Application.php</code>，而命名空间是 <code>Illuminate\Foundation</code></p>
<p><code>Application</code>类的构造函数如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($basePath = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($basePath) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setBasePath($basePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerBaseBindings();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerBaseServiceProviders();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerCoreContainerAliases();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为代码量真的很多，如果每一点都要说，不仅会看得云里雾里，还不一定能理解，所以，我这里以总结的方式概述，特别值得学习的地方再单独提出来说。</p>
<h3 id="一、registerBaseBindings"><a href="#一、registerBaseBindings" class="headerlink" title="一、registerBaseBindings()"></a>一、<code>registerBaseBindings()</code></h3><blockquote>
<p>注册一些基本的绑定到容器中。</p>
</blockquote>
<p>简单点说，此方法内部进行<code>3</code>次赋值，赋值后的变量及变量内容形式如下：</p>
<blockquote>
<ul>
<li><code>static::setInstance($this);</code></li>
<li><code>$this-&gt;instance(&#39;app&#39;, $this);</code></li>
<li><code>$this-&gt;instance(Container::class, $this);</code></li>
</ul>
</blockquote>
<p><strong>借鉴:</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Container::$instance = $<span class="keyword">this</span></span><br><span class="line"></span><br><span class="line">$<span class="keyword">this</span>-&gt;instances[<span class="string">'app'</span>] = $<span class="keyword">this</span></span><br><span class="line"></span><br><span class="line">$<span class="keyword">this</span>-&gt;instances[<span class="string">'Illuminate\Container\Container'</span>] = $<span class="keyword">this</span></span><br></pre></td></tr></table></figure>
<p>变量名具体含义:</p>
<p><code>$this</code>，也就是 <code>Application</code> 类。</p>
<p>static::setInstance，之前说过 <code>Application</code> 是 <code>Container</code> 的子类，而 <code>$instance</code> 静态变量是在 <code>Container</code> 类中已经定义好的,：</p>
<ul>
<li><code>Application.php</code></li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Container</span> <span class="title">implements</span> <span class="title">ApplicationContract</span>, <span class="title">HttpKernelInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Container.php</code></li>
</ul>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="symbol">Container</span> <span class="symbol">implements</span> <span class="symbol">ArrayAccess, <span class="symbol">ContainerContract</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">protected</span> static $instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>$this-&gt;instances</code>，也是在<code>Container</code> 中定义的，含义为存放容器的共享实例,</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * The container's shared instances.</span><br><span class="line"> *</span><br><span class="line"> * @var array</span><br><span class="line"> */</span><br><span class="line">protected $instances = [];</span><br></pre></td></tr></table></figure>
<p>你可以在 <code>registerBaseBindings</code> 方法的最后面打印如下3个变量进行检测，得到的都是 <code>application object</code>，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseBindings</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span>::setInstance(<span class="keyword">$this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'app'</span>, <span class="keyword">$this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(Container::class, <span class="keyword">$this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(PackageManifest::class, <span class="keyword">new</span> PackageManifest(</span><br><span class="line">        <span class="keyword">new</span> Filesystem, <span class="keyword">$this</span>-&gt;basePath(), <span class="keyword">$this</span>-&gt;getCachedPackagesPath()</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    print_r(<span class="keyword">static</span>::$instance);<span class="keyword">die</span>;</span><br><span class="line">    print_r(<span class="keyword">$this</span>-&gt;instances);<span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此，所谓的基本绑定结束，还是云里雾里的，英文不好只能看代码了，反正你记住父类的2个成员属性已经得到了 <code>application</code> 对象。</p>
<h3 id="二、registerBaseServiceProviders"><a href="#二、registerBaseServiceProviders" class="headerlink" title="二、registerBaseServiceProviders()"></a>二、<code>registerBaseServiceProviders()</code></h3><blockquote>
<p>注册所有的基础服务提供商。</p>
</blockquote>
<p>好吧，第二章提过的 <code>ioc 容器=地基</code>，开始买材料准备施工，找几个最基础的供应商商来进行合作，搞水泥的啊，砌砖的啊，以后有更多的需求，根据自己的需求在去找供应商谈。<code>Laravel</code> 现在注册了<code>3</code>个提供商，<strong>一个事件</strong>，<strong>一个是路由</strong>, <strong>一个日志</strong>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseServiceProviders</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;register(<span class="keyword">new</span> EventServiceProvider(<span class="keyword">$this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;register(<span class="keyword">new</span> LogServiceProvider(<span class="keyword">$this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;register(<span class="keyword">new</span> RoutingServiceProvider(<span class="keyword">$this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们先意淫一下大概的意思，找到了供应商，准备合作签合同( <code>register</code> )，先和搞水泥的签( <code>event</code> )，在和砌砖的签( <code>routing</code> )，和谁签？I’m the boss( <code>$this</code> )。 既然我是老板，合同条款肯定得看清楚了，咱们去看看合同先( <code>register</code>方法 ) 嗯！合同说的很清楚，首先确定我和供应商是否签过合同了，签过了( <code>getProvider()</code> 来判断)就滚蛋，浪费时间；虽然我是老板，但不是法人，你打个电话叫他过来，名字叫狗蛋（<code>resolveProvider</code> 方法，如果 <code>$provider</code> 为 <code>string</code> 类型，则根据提供的类名帮供应商实例化并 <code>return</code>），如:</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveProvider</span><span class="params">($provider)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> $provider(<span class="keyword">$this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>OK，差不多，狗蛋把字一签( <code>$provider-&gt;register()</code> )，供应商算是正式入驻施工团队了，当然了，合同还说明以后要是有其他要改的地方，直接填一份声明即可，<code>$options</code> 是 <code>register</code>方法 的第二个参数。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($provider, $options = [], $force = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (($registered = <span class="keyword">$this</span>-&gt;getProvider($provider)) &amp;&amp; ! $force) &#123;</span><br><span class="line">        <span class="keyword">return</span> $registered;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the given "provider" is a string, we will resolve it, passing in the</span></span><br><span class="line">    <span class="comment">// application instance automatically for the developer. This is simply</span></span><br><span class="line">    <span class="comment">// a more convenient way of specifying your service provider classes.</span></span><br><span class="line">    <span class="keyword">if</span> (is_string($provider)) &#123;</span><br><span class="line">        $provider = <span class="keyword">$this</span>-&gt;resolveProvider($provider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method_exists($provider, <span class="string">'register'</span>)) &#123;</span><br><span class="line">        $provider-&gt;register();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;markAsRegistered($provider);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the application has already booted, we will call this boot method on</span></span><br><span class="line">    <span class="comment">// the provider class so it has an opportunity to do its boot logic and</span></span><br><span class="line">    <span class="comment">// will be ready for any usage by this developer's application logic.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;booted) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bootProvider($provider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $provider;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>既然签了合同，就要如公司档案，狗蛋屁颠屁颠的跑去档案室了（<code>$this-&gt;markAsRegistered($provider)</code> ）标记为已注册；好，大功告成( <code>return $provider</code> )。</p>
</blockquote>
<h3 id="三、registerCoreContainerAliases"><a href="#三、registerCoreContainerAliases" class="headerlink" title="三、registerCoreContainerAliases()"></a>三、<code>registerCoreContainerAliases()</code></h3><blockquote>
<p>注册核心容器的别名。</p>
</blockquote>
<p>嗯，这个简单的多，还有啥好说的呢，定义容器里面一些核心类的别名，有兴趣直接去看这个方法就行。</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public function registerCoreContainerAliases()</span><br><span class="line">&#123;</span><br><span class="line">    foreach ([</span><br><span class="line">        'app'                  =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\F</span>oundation<span class="symbol">\A</span>pplication::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\C</span>ontainer<span class="symbol">\C</span>ontainer::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\F</span>oundation<span class="symbol">\A</span>pplication::class,  <span class="symbol">\P</span>sr<span class="symbol">\C</span>ontainer<span class="symbol">\C</span>ontainerInterface::class],</span><br><span class="line">        'auth'                 =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\A</span>uth<span class="symbol">\A</span>uthManager::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\A</span>uth<span class="symbol">\F</span>actory::class],</span><br><span class="line">        'auth.driver'          =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\A</span>uth<span class="symbol">\G</span>uard::class],</span><br><span class="line">        'blade.compiler'       =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\V</span>iew<span class="symbol">\C</span>ompilers<span class="symbol">\B</span>ladeCompiler::class],</span><br><span class="line">        'cache'                =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ache<span class="symbol">\C</span>acheManager::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\C</span>ache<span class="symbol">\F</span>actory::class],</span><br><span class="line">        'cache.store'          =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ache<span class="symbol">\R</span>epository::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\C</span>ache<span class="symbol">\R</span>epository::class],</span><br><span class="line">        'config'               =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\C</span>onfig<span class="symbol">\R</span>epository::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\C</span>onfig<span class="symbol">\R</span>epository::class],</span><br><span class="line">        'cookie'               =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ookie<span class="symbol">\C</span>ookieJar::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\C</span>ookie<span class="symbol">\F</span>actory::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\C</span>ookie<span class="symbol">\Q</span>ueueingFactory::class],</span><br><span class="line">        'encrypter'            =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\E</span>ncryption<span class="symbol">\E</span>ncrypter::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\E</span>ncryption<span class="symbol">\E</span>ncrypter::class],</span><br><span class="line">        'db'                   =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\D</span>atabase<span class="symbol">\D</span>atabaseManager::class],</span><br><span class="line">        'db.connection'        =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\D</span>atabase<span class="symbol">\C</span>onnection::class, <span class="symbol">\I</span>lluminate<span class="symbol">\D</span>atabase<span class="symbol">\C</span>onnectionInterface::class],</span><br><span class="line">        'events'               =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\E</span>vents<span class="symbol">\D</span>ispatcher::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\E</span>vents<span class="symbol">\D</span>ispatcher::class],</span><br><span class="line">        'files'                =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\F</span>ilesystem<span class="symbol">\F</span>ilesystem::class],</span><br><span class="line">        'filesystem'           =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\F</span>ilesystem<span class="symbol">\F</span>ilesystemManager::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\F</span>ilesystem<span class="symbol">\F</span>actory::class],</span><br><span class="line">        'filesystem.disk'      =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\F</span>ilesystem<span class="symbol">\F</span>ilesystem::class],</span><br><span class="line">        'filesystem.cloud'     =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\F</span>ilesystem<span class="symbol">\C</span>loud::class],</span><br><span class="line">        'hash'                 =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\H</span>ashing<span class="symbol">\H</span>asher::class],</span><br><span class="line">        'translator'           =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\T</span>ranslation<span class="symbol">\T</span>ranslator::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\T</span>ranslation<span class="symbol">\T</span>ranslator::class],</span><br><span class="line">        'log'                  =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\L</span>og<span class="symbol">\W</span>riter::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\L</span>ogging<span class="symbol">\L</span>og::class, <span class="symbol">\P</span>sr<span class="symbol">\L</span>og<span class="symbol">\L</span>oggerInterface::class],</span><br><span class="line">        'mailer'               =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\M</span>ail<span class="symbol">\M</span>ailer::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\M</span>ail<span class="symbol">\M</span>ailer::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\M</span>ail<span class="symbol">\M</span>ailQueue::class],</span><br><span class="line">        'auth.password'        =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\A</span>uth<span class="symbol">\P</span>asswords<span class="symbol">\P</span>asswordBrokerManager::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\A</span>uth<span class="symbol">\P</span>asswordBrokerFactory::class],</span><br><span class="line">        'auth.password.broker' =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\A</span>uth<span class="symbol">\P</span>asswords<span class="symbol">\P</span>asswordBroker::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\A</span>uth<span class="symbol">\P</span>asswordBroker::class],</span><br><span class="line">        'queue'                =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\Q</span>ueue<span class="symbol">\Q</span>ueueManager::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\Q</span>ueue<span class="symbol">\F</span>actory::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\Q</span>ueue<span class="symbol">\M</span>onitor::class],</span><br><span class="line">        'queue.connection'     =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\Q</span>ueue<span class="symbol">\Q</span>ueue::class],</span><br><span class="line">        'queue.failer'         =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\Q</span>ueue<span class="symbol">\F</span>ailed<span class="symbol">\F</span>ailedJobProviderInterface::class],</span><br><span class="line">        'redirect'             =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\R</span>outing<span class="symbol">\R</span>edirector::class],</span><br><span class="line">        'redis'                =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\R</span>edis<span class="symbol">\R</span>edisManager::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\R</span>edis<span class="symbol">\F</span>actory::class],</span><br><span class="line">        'request'              =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\H</span>ttp<span class="symbol">\R</span>equest::class, <span class="symbol">\S</span>ymfony<span class="symbol">\C</span>omponent<span class="symbol">\H</span>ttpFoundation<span class="symbol">\R</span>equest::class],</span><br><span class="line">        'router'               =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\R</span>outing<span class="symbol">\R</span>outer::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\R</span>outing<span class="symbol">\R</span>egistrar::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\R</span>outing<span class="symbol">\B</span>indingRegistrar::class],</span><br><span class="line">        'session'              =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\S</span>ession<span class="symbol">\S</span>essionManager::class],</span><br><span class="line">        'session.store'        =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\S</span>ession<span class="symbol">\S</span>tore::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\S</span>ession<span class="symbol">\S</span>ession::class],</span><br><span class="line">        'url'                  =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\R</span>outing<span class="symbol">\U</span>rlGenerator::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\R</span>outing<span class="symbol">\U</span>rlGenerator::class],</span><br><span class="line">        'validator'            =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\V</span>alidation<span class="symbol">\F</span>actory::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\V</span>alidation<span class="symbol">\F</span>actory::class],</span><br><span class="line">        'view'                 =&gt; [<span class="symbol">\I</span>lluminate<span class="symbol">\V</span>iew<span class="symbol">\F</span>actory::class, <span class="symbol">\I</span>lluminate<span class="symbol">\C</span>ontracts<span class="symbol">\V</span>iew<span class="symbol">\F</span>actory::class],</span><br><span class="line">    ] as <span class="keyword">$key =&gt; $aliases) &#123;</span></span><br><span class="line"><span class="keyword">        foreach </span>(<span class="keyword">$aliases as $alias) &#123;</span></span><br><span class="line"><span class="keyword">            $this-&gt;alias</span>(<span class="keyword">$key, $alias);</span></span><br><span class="line"><span class="keyword">        &#125;</span></span><br><span class="line"><span class="keyword">    &#125;</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure>
<p>当然了最后是存放在 <code>$aliases</code> 这个数组里面哟，在 <code>container</code> 定义的成员属性。</p>
<h3 id="四、setBasePath"><a href="#四、setBasePath" class="headerlink" title="四、setBasePath()"></a>四、<code>setBasePath()</code></h3><blockquote>
<p>设置基本路径</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setBasePath</span><span class="params">($basePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;basePath = rtrim($basePath, <span class="string">'\/'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;bindPathsInContainer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bindPathsInContainer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path'</span>, <span class="keyword">$this</span>-&gt;path());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.base'</span>, <span class="keyword">$this</span>-&gt;basePath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.lang'</span>, <span class="keyword">$this</span>-&gt;langPath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.config'</span>, <span class="keyword">$this</span>-&gt;configPath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.public'</span>, <span class="keyword">$this</span>-&gt;publicPath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.storage'</span>, <span class="keyword">$this</span>-&gt;storagePath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.database'</span>, <span class="keyword">$this</span>-&gt;databasePath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.resources'</span>, <span class="keyword">$this</span>-&gt;resourcePath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.bootstrap'</span>, <span class="keyword">$this</span>-&gt;bootstrapPath());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $basePath;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">path</span><span class="params">($path = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;basePath.DIRECTORY_SEPARATOR.<span class="string">'app'</span>.($path ? DIRECTORY_SEPARATOR.$path : $path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个更简单了，这就是前面说 <code>$app</code> 出生地的地方，传了一个路径参数,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</span><br><span class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>至此，<code>$app</code> 终于生出来了，绑定了 <code>application</code> 对象，和<code>3</code>个供应商签了合同，给一些<code>核心类起了别名</code>，配置了 <code>laravel</code> 根目录地址</p>
<h1 id="认识-Bind"><a href="#认识-Bind" class="headerlink" title="认识 Bind"></a>认识 <code>Bind</code></h1><p>第三章的探索相信有很多学友只是知道一些基本流程，并未真正意义上知道其所以然，不过学习还需要循序渐进，先了解，在深入，最后总结，本章，咱们将要探秘 <code>bind()</code> 方法。</p>
<ul>
<li><code>Bind</code>方法位于<code>Container.php</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Register a binding with the container.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string|array  $abstract</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  \Closure|string|null  $concrete</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  bool  $shared</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">($abstract, $concrete = null, $shared = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Bind 第一次被使用是在 EventServiceProvider 类的 register() 方法里</p>
<ul>
<li><code>vendor/laravel/framework/src/Illuminate/Events/EventServiceProvider.php</code></li>
</ul>
<p>第三章说到注册3个基本的服务提供商，分别是事件( event )和路由( route )还有日志(Log),都分别执行了各自的 $provider-&gt;register()。</p>
<p>首先看第一次执行 <code>bind()</code> 的代码上下文：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Register the service provider.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;app-&gt;singleton(<span class="string">'events'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> Dispatcher($app))-&gt;setQueueResolver(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($app)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $app-&gt;make(QueueFactoryContract::class);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>$this-&gt;app</code> 怎么来的？这个成员属性是在抽象类 <code>ServiceProvider</code> 中定义好的，并在其构造函数中进行赋值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The application instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Contracts\Foundation\Application</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $app;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new service provider instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Foundation\Application  $app</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($app)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app = $app;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大家可以查阅，所有的服务提供商都继承于这个类，而在 <code>application</code> 类中的 <code>registerBaseServiceProviders()</code> 传入了这个参数 <code>$this</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$<span class="keyword">this</span>-&gt;<span class="keyword">register</span>(<span class="keyword">new</span> EventServiceProvider($<span class="keyword">this</span>));</span><br></pre></td></tr></table></figure>
<p>接下来我们看见的是 <code>singleton</code> 并非 <code>bind</code> 方法，而 <code>singleton</code> 意为单例，在方法内部调用如下：</p>
<ul>
<li>vendor/laravel/framework/src/Illmiunate/Container/Container.php</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Register a shared binding in the container.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string|array  $abstract</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  \Closure|string|null  $concrete</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">singleton</span><span class="params">($abstract, $concrete = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;bind($abstract, $concrete, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只不过是把 <code>bind</code> 的第三个参数设置为共享状态。</p>
<p>好，结合现在的情况，在分析下参数，给了一个 <code>events</code> 字符串，还有一个闭包函数，闭包需要传入一个参数 <code>$app</code> ，这个参数无非就是 <code>application</code> 的实例。</p>
<p>好，把这个来龙去脉弄清楚了，我们才能更清晰的分析 <code>bind</code> 内部逻辑。</p>
<p>Bind 开头进行了一个数组判断，为了大家看的清楚，我简单的举了个例子：</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/03/1795/7pnmO6Voq1.png" alt></p>
<p><code>extractAlias</code> 方法只是返回了这样一个数组：</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/03/1795/drL6WHCQ7W.png" alt></p>
<p>很简单吧，提取后在重组别名：</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/03/1795/sx1BrfDkn7.png" alt></p>
<p>代码带来的功能就是这样，具体的意义，我把注释翻译，大家尽量去理解：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// If no concrete type was given, we will simply <span class="built_in">set</span> the concrete type <span class="keyword">to</span> the</span><br><span class="line">// abstract type. After that, the concrete type <span class="keyword">to</span> be registered as shared</span><br><span class="line">// without being forced <span class="keyword">to</span> <span class="keyword">state</span> their classes <span class="keyword">in</span> both of the parameters.</span><br><span class="line"></span><br><span class="line">// 如果没有具体类型(<span class="variable">$concrete</span>), 我们将简单的将具体类型设置为抽象类型 (也就是<span class="variable">$concrete</span> = <span class="variable">$abstract</span>)</span><br><span class="line">// 这将允许具体的类型被注册为共享, 而无需在两个参数(<span class="variable">$concrete</span>, <span class="variable">$abstract</span>)中说明其类.</span><br><span class="line"></span><br><span class="line">// 删除旧的实例</span><br><span class="line"><span class="variable">$this</span>-&gt;dropStaleInstances(<span class="variable">$abstract</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>dropStaleInstances</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dropStaleInstances</span><span class="params">($abstract)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract], <span class="keyword">$this</span>-&gt;aliases[$abstract]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>删除以后，判断了如下：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (is_null(<span class="symbol">$co</span>ncrete)) &#123;</span><br><span class="line">    <span class="symbol">$co</span>ncrete = <span class="symbol">$a</span>bstract;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了把这里弄懂，我们现在假设 <code>$concrete</code> 确实为 <code>null</code>，然后看往下是怎么发展的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If the factory is not a Closure, it means it is just a class name which is</span></span><br><span class="line"><span class="comment">// bound into this container to the abstract type and we will just wrap it</span></span><br><span class="line"><span class="comment">// up inside its own Closure to give us more convenience when extending.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (! $concrete <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">    $concrete = <span class="keyword">$this</span>-&gt;getClosure($abstract, $concrete);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 <code>$concrete</code> 不是一个<code>闭包</code>，就封装成一个<code>闭包</code>，刚才我们假设了为 <code>null</code>，并且 <code>$concrete</code> = <code>$abstract</code>，那么在看一下 <code>getClosure</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getClosure</span><span class="params">($abstract, $concrete)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($container, $parameters = [])</span> <span class="title">use</span> <span class="params">($abstract, $concrete)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($abstract == $concrete) &#123;</span><br><span class="line">            <span class="keyword">return</span> $container-&gt;build($concrete);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $container-&gt;make($concrete, $parameters);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们以刚才的假设来虚拟场景，<code>$concrete = $abstract</code>,所以 <code>$method=build</code>，并且执行 <code>$container-&gt;build($concrete)</code> 方法，</p>
<p>接下来要认识一个新数组 <code>bindings</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$this</span>-&gt;bindings[<span class="variable">$abstract</span>] = compact(<span class="string">'concrete'</span>, <span class="string">'shared'</span>);</span><br></pre></td></tr></table></figure>
<p><code>Compact</code> 创建一个由参数所带变量组成的数组。如果参数中存在数组，该数组中变量的值也会被获取，这里我们知道 <code>$conrete</code> 被封装成一个闭包了，而 <code>$shared</code> 是在 <code>singleton</code> 方法中传的 <code>true</code>，也就是<code>1</code>。所以现在<code>bindings</code> 数组形式如下：</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/03/1795/rOP6CGGP48.png" alt="bindings 数组形式"></p>
<p>这里有部分人可能会纠结，你刚才不是说 <code>$concrete</code> 为 <code>null</code>，怎么又变成了一个闭包对象；刚才仅仅只是用假设，来弄懂一个环节，所以正常来说这里就是这样。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If the abstract type was already resolved in this container we'll fire the</span></span><br><span class="line"><span class="comment">// rebound listener so that any objects which have already gotten resolved</span></span><br><span class="line"><span class="comment">// can have their copy of the object updated via the listener callbacks.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果$abstract 已经解析的话, 则反弹给监听者, 那么任何一个已经解析的对象 就能通过监听者的回调函数进行更新</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;resolved($<span class="keyword">abstract</span>)) &#123;</span><br><span class="line">    $<span class="keyword">this</span>-&gt;rebound($<span class="keyword">abstract</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Events</code> 肯定没有解析过，所以这里的 <code>rebound</code> 反弹暂时不能过多讲解。</p>
<p>到现在为止，闭包内的代码依然没有执行，而 <code>bind</code> 方法也到此为止了。</p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p><code>Bind</code> 方法不仅可以<strong>智能的创建快捷方式</strong>，还可以<strong>封装闭包函数</strong>，并<strong>把所有的对应绑定都存入到 <code>bindings</code> 数组中</strong>，如果一旦某个对象解析过了依然调用 <code>bind</code> 方法，那么就会 <code>rebound</code> 反弹，<strong>通过监听者的回调函数更新对象</strong>。</p>
<h1 id="认识-Make"><a href="#认识-Make" class="headerlink" title="认识 Make"></a>认识 <code>Make</code></h1><p>上一章了解了 <code>bind</code>，<code>bind</code> 封装了一个闭包到数组 <code>bindings</code>，那绑定完了总需要使用吧，就好像生产零件，先规定了怎么生产( <code>bind</code> )，然后再生产( <code>make</code> )所以 <code>make</code> 出来了，咱们一起看看，<code>make</code> 在容器里面起到什么作用。</p>
<p>还是老办法，先找出第一次调用 <code>make</code> 的地方，之前第三章探索 <code>application</code> 构造函数还是很有必要的，因为若干的第一次 <code>work</code>，以及认识这些关键的方法都包含在内，如果对以下所说的方法比较模糊，自行回顾第三章，并打开代码走一遍。</p>
<p>我们知道 <code>application</code> 构造函数里面调用了 <code>registerBaseServiceProviders</code> （注册基本的服务提供商），内部调用了 <code>register</code> 方法，<code>register</code> 方法内部又调用了 <code>markAsRegistered</code> （标记为已注册），咱们现在看 <code>markAsRegistered</code> 方法：</p>
<ul>
<li><code>Application.php@markAsRegistered</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">markAsRegistered</span><span class="params">($provider)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;serviceProviders[] = $provider;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadedProviders[get_class($provider)] = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_class</span> <span class="params">($object = null)</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="正确执行-Make"><a href="#正确执行-Make" class="headerlink" title="正确执行 Make"></a>正确执行 Make</h2><blockquote>
<p><code>vendor/laravel/framework/src/Illuminate/Container@offsetGet</code></p>
</blockquote>
<ul>
<li><code>offsetGet</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetGet</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;make($key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>make</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract, array $parameters = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resolve($abstract, $parameters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>resolve</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolve</span><span class="params">($abstract, $parameters = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先是获取正确的别名 <code>getAlias</code>。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$abstract</span> = <span class="variable">$this</span>-&gt;getAlias(<span class="variable">$abstract</span>);</span><br></pre></td></tr></table></figure>
<p>接下来也是一个单例的判断，如果当前 <code>instances</code> 数组包含此类型，则直接 <code>return</code> 此单元。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract]) &amp;&amp; ! $needsContextualBuild) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;instances[$abstract];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着执行了一个新玩意 <code>getConcrete</code> 并将结果赋值给 <code>$concrete</code>，咱们在跳过去看看 <code>getConcrete</code> ，这个方法的大概意思是得到一个给定的抽象的具体类型。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$concrete</span> = <span class="variable">$this</span>-&gt;getConcrete(<span class="variable">$abstract</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>getConcrete</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getConcrete</span><span class="params">($abstract)</span></span></span><br><span class="line"><span class="function">     </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (! is_null($concrete = <span class="keyword">$this</span>-&gt;getContextualConcrete($abstract))) &#123;</span><br><span class="line">             <span class="keyword">return</span> $concrete;</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         <span class="comment">// If we don't have a registered resolver or concrete for the type, we'll just</span></span><br><span class="line">         <span class="comment">// assume each type is a concrete name and will attempt to resolve it as is</span></span><br><span class="line">         <span class="comment">// since the container should be able to resolve concretes automatically.</span></span><br><span class="line">         <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;bindings[$abstract])) &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bindings[$abstract][<span class="string">'concrete'</span>];</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         <span class="keyword">return</span> $abstract;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>先是来了个看不懂的方法 <code>getContextualConcrete</code> 不明觉厉:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getContextualConcrete</span><span class="params">($abstract)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! is_null($binding = <span class="keyword">$this</span>-&gt;findInContextualBindings($abstract))) &#123;</span><br><span class="line">        <span class="keyword">return</span> $binding;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next we need to see if a contextual binding might be bound under an alias of the</span></span><br><span class="line">    <span class="comment">// given abstract type. So, we will need to check if any aliases exist with this</span></span><br><span class="line">    <span class="comment">// type and then spin through them and check for contextual bindings on these.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;abstractAliases[$abstract])) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;abstractAliases[$abstract] <span class="keyword">as</span> $alias) &#123;</span><br><span class="line">        <span class="keyword">if</span> (! is_null($binding = <span class="keyword">$this</span>-&gt;findInContextualBindings($alias))) &#123;</span><br><span class="line">            <span class="keyword">return</span> $binding;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>findInContextualBindings</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">findInContextualBindings</span><span class="params">($abstract)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;contextual[end(<span class="keyword">$this</span>-&gt;buildStack)][$abstract])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;contextual[end(<span class="keyword">$this</span>-&gt;buildStack)][$abstract];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们暂时还没看到 <code>contextual</code> 数组用过的地方，大家先看看就好。 并且输出 <code>contextual</code> 现在还是空数组，所以回到 <code>getConcrete</code>方法，判断不成立，继续往下走。</p>
<p>接着，判断我们上一章学过的 <code>bindings</code> 数组，我们知道数组已经包含了 <code>events</code> 这个单元了，</p>
<p>什么时候包含的？</p>
<p>是在 <code>application</code> 类的 <code>register</code> 方法内执行的 <code>$provider-&gt;register()</code> ，而 <code>events</code> 服务商类的 <code>register</code> 方法执行了 <code>$this-&gt;app-&gt;singleton</code>，而 <code>singleton</code> 其实在执行 <code>bind</code>，只不过是<strong>共享绑定</strong>而已，我们再复习一遍吧。</p>
<p>那也就是说，这里判断不成立，<code>events</code> 已经绑定好了，直接跳过 <code>if</code> 块，最后直接</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isset($<span class="keyword">this</span>-&gt;bindings[$<span class="keyword">abstract</span>])) &#123;</span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;bindings[$<span class="keyword">abstract</span>][<span class="string">'concrete'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们知道，这里的 <code>concrete</code> 在 <code>events</code> 单元内是一个闭包对象，在把上一章的截图重发一下</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/10/1795/NdBLrcYpC9.png" alt></p>
<p>到此为止，<code>getConcrete</code> 理论上已经结束了，但是为了在弄清楚一点，我们继续把刚才 <code>if</code> 内没有执行的代码说一下：</p>
<p>咱们找到第一次能够执行此场景的代码，在入口文件 <code>index.php</code> ：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::<span class="class"><span class="keyword">class</span>);</span></span><br></pre></td></tr></table></figure>
<p>首先通过 <code>getAlias</code> 方法，知道现在 <code>$abstract</code> 参数是 <code>app\Http\Kernel</code>，<code>app\Http\Kernel</code> 到目前为止是没有经过 <code>bind</code>，所以判断成立，走 <code>if</code> 里面。</p>
<ul>
<li><code>make</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract, array $parameters = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resolve($abstract, $parameters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>resolve</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolve</span><span class="params">($abstract, $parameters = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</span><br><span class="line"></span><br><span class="line">    $needsContextualBuild = ! <span class="keyword">empty</span>($parameters) || ! is_null(</span><br><span class="line">        <span class="keyword">$this</span>-&gt;getContextualConcrete($abstract)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If an instance of the type is currently being managed as a singleton we'll</span></span><br><span class="line">    <span class="comment">// just return an existing instance instead of instantiating new instances</span></span><br><span class="line">    <span class="comment">// so the developer can keep using the same objects instance every time.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract]) &amp;&amp; ! $needsContextualBuild) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;instances[$abstract];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;with[] = $parameters;</span><br><span class="line"></span><br><span class="line">    $concrete = <span class="keyword">$this</span>-&gt;getConcrete($abstract);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We're ready to instantiate an instance of the concrete type registered for</span></span><br><span class="line">    <span class="comment">// the binding. This will instantiate the types, as well as resolve any of</span></span><br><span class="line">    <span class="comment">// its "nested" dependencies recursively until all have gotten resolved.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isBuildable($concrete, $abstract)) &#123;</span><br><span class="line">        $object = <span class="keyword">$this</span>-&gt;build($concrete);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $object = <span class="keyword">$this</span>-&gt;make($concrete);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we defined any extenders for this type, we'll need to spin through them</span></span><br><span class="line">    <span class="comment">// and apply them to the object being built. This allows for the extension</span></span><br><span class="line">    <span class="comment">// of services, such as changing configuration or decorating the object.</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getExtenders($abstract) <span class="keyword">as</span> $extender) &#123;</span><br><span class="line">        $object = $extender($object, <span class="keyword">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the requested type is registered as a singleton we'll want to cache off</span></span><br><span class="line">    <span class="comment">// the instances in "memory" so we can return it later without creating an</span></span><br><span class="line">    <span class="comment">// entirely new instance of an object on each subsequent request for it.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isShared($abstract) &amp;&amp; ! $needsContextualBuild) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;instances[$abstract] = $object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;fireResolvingCallbacks($abstract, $object);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before returning, we will also set the resolved flag to "true" and pop off</span></span><br><span class="line">    <span class="comment">// the parameter overrides for this build. After those two things are done</span></span><br><span class="line">    <span class="comment">// we will be ready to return back the fully constructed class instance.</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">$this</span>-&gt;resolved[$abstract] = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    array_pop(<span class="keyword">$this</span>-&gt;with);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有3个知识点，<code>isBuildable</code> , <code>build</code> ,还有一个 <code>make</code> 的递归。</p>
<ul>
<li><ul>
<li><code>isBuildable</code>，确定给定的具体物是可信赖的。</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isBuildable</span><span class="params">($concrete, $abstract)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $concrete === $abstract || $concrete <span class="keyword">instanceof</span> Closure;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要么具体物和抽象类型相等，要么具体物就是个闭包方法，至少要满足一样。</p>
<p>好，如果满足其中一样，我们现在场景的 <code>events</code> 是一个闭包，满足了，执行 <code>build</code></p>
<ul>
<li><ul>
<li><code>Build</code> 方法注释大概的意思：为给定的类型实例化一个具体物的实例。</li>
</ul>
</li>
</ul>
<p>方法开头直接:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($concrete <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">    <span class="keyword">return</span> $concrete(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;getLastParameterOverride());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>终于露出你的庐山真面目了，<code>events</code> 闭包原型，我们在截图确认一下：</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/10/1795/EIAGw7jAmf.png" alt></p>
<p>嗯哼，<code>$this</code> 参数相当于闭包函数中的参数 <code>$app</code>，要注意的是 <code>$this</code> 是 <code>application</code> 类，不要认为是在 <code>container</code> 类定义的方法 <code>$this</code> 就是 <code>container</code>，它们是继承关系，而 <code>new</code> 的是 <code>application</code> 类，所以 <code>$this</code> 属于谁应该很清楚了。</p>
<p>然而就这样执行了闭包，里面的肯定是组件的一些功能，这也不是本章主题，所以略过。</p>
<p>至于这个 <code>make</code> 递归，暂时还不知道，等用到的时候在说，目前为止 <code>$object</code> 是一个实例了，我们截图看看是哪个类的实例即可，因为这些都是刚才闭包内执行的结果。</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/10/1795/pj8Sx0TxlN.png" alt></p>
<p>这个很简单，就是判断 <code>bindings</code> 数组单元内 <code>shared</code> 如果为共享状态（也就是1），则将 <code>$object</code> 进行赋值。</p>
<p>接下来有个 <code>fireResolvingCallbacks</code> 方法，我的理解是<strong>启动“具有解析过程”回调函数</strong>，目前没有执行到，我们也就不去说了，还是那句话，用的时候在具体来分析，更好理解。</p>
<p><code>Make</code> 方法最后：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$<span class="keyword">this</span>-&gt;resolved[$<span class="keyword">abstract</span>] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">array_pop($<span class="keyword">this</span>-&gt;with);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $<span class="keyword">object</span>;</span><br></pre></td></tr></table></figure>
<p>将 <code>true</code> 赋值到 <code>resolved</code> ,意为已经解析过的，最后 <code>return $object</code>,  make 结束。</p>
<h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><p>就目前为止，我们知道， <code>make</code> 会借用 <code>bindings</code>(bind而来) 来<strong>获取具体的闭包对象</strong>，然后用 <code>build</code> 方法来<strong>调用闭包函数</strong>，所以说 <code>bind</code> 和 <code>make</code> 是具有紧密的联系的</p>
<h1 id="启动-kernel"><a href="#启动-kernel" class="headerlink" title="启动 kernel"></a>启动 <code>kernel</code></h1><p>前两章初步认识了 <code>bind</code> 和 <code>make</code> 使我们明白生成一个实例的步骤，接下来，我们要认识 <code>kernel</code>，这是与用户交互的关键，咱们打开入口文件</p>
<ul>
<li>原文:</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| Run The Application</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| Once we have the application, we can handle the incoming request</span></span><br><span class="line"><span class="comment">| through the kernel, and send the associated response back to</span></span><br><span class="line"><span class="comment">| the client's browser allowing them to enjoy the creative</span></span><br><span class="line"><span class="comment">| and wonderful application we have prepared for them.</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ul>
<li>翻译:</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| 运行 应用程序</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| 一旦我们有了应用程序, 我们就可以 通过内核来处理传入的请求.</span></span><br><span class="line"><span class="comment">| 并将相关的响应发送到客户端的浏览器</span></span><br><span class="line"><span class="comment">| 让他们可以享受我们为他们准备的创意和精彩的应用程序</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>咱们根据这行代码和这个参数，具体来捋一捋 <code>$kernel</code> 是如何生成的，也当复习。</p>
<p><code>$app</code> 这个不用解释即 <code>application</code> 类，之前说的 <code>make</code> 方法是位于 <code>container</code> 类中，其实 <code>application</code> 类中也有 <code>make</code> 方法，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract, array $parameters = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;deferredServices[$abstract]) &amp;&amp; ! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract])) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;loadDeferredProvider($abstract);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">parent</span>::make($abstract, $parameters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们现在还不知道具体的用意在哪，不过我们看见了内部调用了父类( <code>container</code> )的 <code>make</code> 方法，</p>
<p>所以执行过程是先通过子类的 <code>make</code> 调用到父类的 <code>make</code> ，根据参数咱们继续往下看，这里只传了一个 <code>Illuminate\Contracts\Http\Kernel</code> 参数，所以 <code>$parameters</code> 可以无视了。</p>
<p>在继续分析父类 <code>make</code> 方法之前，我们要知道，在 <code>bootstrap/app.php</code> 里进行了3次 <code>singleton</code> 操作， <code>singleton</code> 前面也说过，也就是调用 bind 方法，如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Http\Kernel::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">    App\Http\Kernel::<span class="class"><span class="keyword">class</span></span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Console\Kernel::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">    App\Console\Kernel::<span class="class"><span class="keyword">class</span></span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Debug\ExceptionHandler::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">    App\Exceptions\Handler::<span class="class"><span class="keyword">class</span></span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>我们看见第一个 <code>singleton</code> 一目了然，对应了我们今天要说的类，不过后面多了一个参数（<code>app\Http\Kernel</code> ），这个参数原型名字是 <code>$concrete</code> ，即具体物。</p>
<p>了解以上这些，我们才正式分析父类的 <code>make</code> 方法：</p>
<p><code>Make</code> 方法前一章单独说过了，所以略过没有执行到的代码。</p>
<p>这里我们知道，<code>Illuminate\Contracts\Http\Kernel</code> 还没有生成实例，只是<strong>绑定</strong>了而已，说到绑定，不知道大家还记得 <code>bind</code> 方法是怎么执行的吗？其中有一步是判断如果 <code>$concrete</code> 这个参数不是一个闭包的，则调用 <code>getClosure</code> 方法来强制生成一个闭包给 <code>$concrete</code> ，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getClosure</span><span class="params">($abstract, $concrete)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($container, $parameters = [])</span> <span class="title">use</span> <span class="params">($abstract, $concrete)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($abstract == $concrete) &#123;</span><br><span class="line">            <span class="keyword">return</span> $container-&gt;build($concrete);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $container-&gt;make($concrete, $parameters);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>咱们继续看 <code>container</code> 类的 <code>make</code> 方法。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$concrete</span> = <span class="variable">$this</span>-&gt;getConcrete(<span class="variable">$abstract</span>);</span><br></pre></td></tr></table></figure>
<p>我们知道这个方法只能返回2种参数，<strong>一个是闭包对象，一个字符参数</strong>，这里 <code>$concrete</code> 自然是得到一个闭包对象，因为已经绑定过了。</p>
<p>接着直接执行了 <code>build</code> 方法，咱们看 <code>build</code> 方法内的关键代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($concrete <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">    <span class="keyword">return</span> $concrete(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;getLastParameterOverride());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>getLastParameterOverride</code></li>
</ul>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getLastParameterOverride</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> count($<span class="keyword">this</span>-&gt;<span class="keyword">with</span>) ? end($<span class="keyword">this</span>-&gt;<span class="keyword">with</span>) : [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>嗯看到这里，我们上一章也说过，一个闭包的调用，这里需要跳回 <code>getClosure</code> 继续分析了：</p>
<p><code>$concrete($this, $parameters)</code> 这里是传了一个 <code>this</code> 参数，即 <code>application</code> 类，所以 <code>$container=application</code> 类，那结合刚才说 <code>getClosure</code> 方法，这里闭包内部应该是执行一个 <code>$container-&gt;make($concrete)</code> 逻辑，注意参数 <code>$concrete</code> 是第一次传的 <code>app\Http\</code> 字符串；那更直接一点，代码其实是这样 <code>application-&gt;make(‘app\Http\Kernel’)</code> 。</p>
<p>从 <code>make(‘Illuminate\Contracts\Http\Kernel’)</code> 又转换到 <code>make(‘app\Http\Kernel’)</code> ，我们现在只需要知道这个顺序。</p>
<p>好，那再一次去看 <code>make</code> 如何实例化这个 <code>app\Http\Kernel</code> 类的，这次应该有不同的认识。</p>
<p>再次执行到 <code>getConcrete</code> 方法，我们说了要么是返回<code>一个闭包对象</code>，要么就是<code>一个字符串</code>，前面都是返回的闭包，而这次呢？转到 <code>getConcrete</code> 相关代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getConcrete</span><span class="params">($abstract)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! is_null($concrete = <span class="keyword">$this</span>-&gt;getContextualConcrete($abstract))) &#123;</span><br><span class="line">        <span class="keyword">return</span> $concrete;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we don't have a registered resolver or concrete for the type, we'll just</span></span><br><span class="line">    <span class="comment">// assume each type is a concrete name and will attempt to resolve it as is</span></span><br><span class="line">    <span class="comment">// since the container should be able to resolve concretes automatically.</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;bindings[$abstract])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bindings[$abstract][<span class="string">'concrete'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $abstract;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Build-方法逻辑顺序："><a href="#Build-方法逻辑顺序：" class="headerlink" title="Build 方法逻辑顺序："></a>Build 方法逻辑顺序：</h2><p>先是我们最熟悉的闭包实例判断，我们这里只是一个字符串，所以不成立，再见。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($concrete <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">    <span class="keyword">return</span> $concrete(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;getLastParameterOverride());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后 <code>new</code> 了一个反射类</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$reflector</span> = <span class="keyword">new</span> ReflectionClass(<span class="symbol">$co</span>ncrete);</span><br></pre></td></tr></table></figure>
<p>先是来了个 <code>isInstantiable</code> 判断，</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (! <span class="variable">$reflector</span>-&gt;isInstantiable()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;notInstantiable(<span class="variable">$concrete</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>PHP</code> 官网解释：</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/Ciz5dr12oy.png" alt></p>
<p>只要你不能实例化，直接抛错。</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/WmnBG5Ev0F.png" alt></p>
<p>接下来又学到一个新数组</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$this</span>-&gt;buildStack[] = <span class="variable">$concrete</span>;</span><br></pre></td></tr></table></figure>
<p>绑定栈，百度百科科普一下：</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/XL9V5n1Beo.png" alt></p>
<p><code>app\Http\Kernel</code> 进入了栈结构了</p>
<p>紧接着又继续用到反射方法 <code>getConstructor</code> ，继续 <code>PHP</code> 官网：</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/8NQoEW5bJL.png" alt></p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$<span class="function"><span class="keyword">constructor</span> = $<span class="title">reflector</span>-&gt;<span class="title">getConstructor</span><span class="params">()</span>;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/ZqwZwsOT1R.png" alt></p>
<p>这下清楚了，如果反射不存在的话就返回一个 null 。</p>
<p>接下来也是一个 <code>is_null</code> 判断</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="keyword">If</span> there are no constructors, that means there are no dependencies <span class="keyword">then</span></span><br><span class="line"><span class="comment">// we can just resolve the instances of the objects right away, without</span></span><br><span class="line"><span class="comment">// resolving any other types or dependencies out of these containers.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_null($<span class="function"><span class="keyword">constructor</span>)) <span class="comment">&#123;</span></span></span><br><span class="line"><span class="function"><span class="comment">    array_pop($this-&gt;buildStack);</span></span></span><br><span class="line"><span class="function"><span class="comment"></span></span></span><br><span class="line"><span class="function"><span class="comment">    return new $concrete;</span></span></span><br><span class="line"><span class="function"><span class="comment">&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>注释很明了，不需要多余的工作，先是出栈，弹出 <code>$concrete</code> ，然后直接返回对象实例。</p>
<p>这里 <code>app\Http\Kernel</code> 继承了父类 <code>Illuminate\Foundation\Http\Kernel</code> ，并且有构造函数，这里先发一下构造函数原型，以便后面更容易理解：</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/yxp8OFpGgg.png" alt></p>
<p>那么现在我们还得继续往下分析，发一下 <code>$constructor</code> 调试截图，更清晰一点：</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/bNksZTr6dg.png" alt></p>
<p>OK，那么现在 <code>$constructor</code> 是一个 <code>ReflectionMethod</code> 对象，这个反射方法对象我们在第二章也演示过，是针对类的方法。</p>
<p>紧接着:</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$dependencies = $<span class="function"><span class="keyword">constructor</span>-&gt;<span class="title">getParameters</span><span class="params">()</span>;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>getParameters</code> 方法示例：</li>
</ul>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/S6Hb7woErL.png" alt></p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/aOLf1dKNUM.png" alt></p>
<p>一环扣一环，返回值依然是一个新对象，不过是针对参数。</p>
<p>调试截图:</p>
<p><img src="https://dn-phphub.qbox.me/uploads/images/201510/16/1795/ZOBmtPpgVQ.png" alt></p>
<p>嗯，确实匹配构造函数的参数，没什么大问题，每一个参数即是一个 <code>ReflectionParameter</code> 对象。</p>
<p>嗯哼，接下来也很关键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Once we have all the constructor's parameters we can create each of the</span></span><br><span class="line"><span class="comment">// dependency instances and then use the reflection instances to make a</span></span><br><span class="line"><span class="comment">// new instance of this class, injecting the created dependencies in.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 一旦我们有了所以的构造函数的参数</span></span><br><span class="line"><span class="comment">// 我们就可以创建一个依赖实例</span></span><br><span class="line"><span class="comment">// 然后使用反射实例来创建这个类的一个新实例</span></span><br><span class="line"><span class="comment">// 注入创建的依赖关系</span></span><br><span class="line"></span><br><span class="line">$instances = <span class="keyword">$this</span>-&gt;resolveDependencies(</span><br><span class="line">    $dependencies</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>接着出栈:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">array</span><span class="constructor">_pop($<span class="params">this</span>-&gt;<span class="params">buildStack</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>最后很关键的地方来了:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable">$reflector</span>-&gt;newInstanceArgs(<span class="variable">$instances</span>);</span><br><span class="line"></span><br><span class="line">/<span class="regexp">/ 创建一个类的实例, 给出的参数将传递到类的构造函数</span></span><br></pre></td></tr></table></figure>
<p>这个简单了吧，正好对应构造函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Application $app, Router $router)</span></span></span><br></pre></td></tr></table></figure>
<p>这样解决的依赖关系.</p>
<h2 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h2><p>本章关键点在于 <code>build</code> 方法<strong>利用反射解决依赖关系</strong>那里，还有也进一步学习了 <code>getClosure</code> 方法内部逻辑，</p>

        
      
    </div>

    <footer class="article-footer">
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>本文作者:  </strong>CAO XIAN LIANG</a>
          </li>
          <li class="post-copyright-link">
          <strong>本文链接:  </strong>
          <a href="/2018/02/23/Laravel-Startup-Process-Notes/" target="_blank" title="Laravel 执行流程">http://blog.caoxl.com/2018/02/23/Laravel-Startup-Process-Notes/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明:   </strong>
            本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            许可协议。转载请注明出处
          </li>
         
        </ul>
<div>

      
      
      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Laravel/">Laravel</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/02/26/How-to-transfer-Hexo-ToMacBook/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          Hexo 更换电脑后怎么继续使用博客
        
      </div>
    </a>
  
  
    <a href="/2018/02/11/Laravel-Database-Query/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">Laravel 数据库请求构建器</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、自动加载"><span class="nav-number">1.</span> <span class="nav-text">一、自动加载</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定位"><span class="nav-number">1.1.</span> <span class="nav-text">定位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getLoader"><span class="nav-number">1.2.</span> <span class="nav-text">getLoader()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">1.3.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Container-类"><span class="nav-number">2.</span> <span class="nav-text">Container 类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定位-1"><span class="nav-number">2.1.</span> <span class="nav-text">定位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Container-类-1"><span class="nav-number">2.2.</span> <span class="nav-text">Container 类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#offsetExists"><span class="nav-number">2.2.1.</span> <span class="nav-text">offsetExists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#offsetGet"><span class="nav-number">2.2.2.</span> <span class="nav-text">offsetGet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#offsetSet"><span class="nav-number">2.2.3.</span> <span class="nav-text">offsetSet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#offsetUnset"><span class="nav-number">2.2.4.</span> <span class="nav-text">offsetUnset</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#探索-Application-构造函数"><span class="nav-number">3.</span> <span class="nav-text">探索 Application 构造函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定位-2"><span class="nav-number">3.1.</span> <span class="nav-text">定位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Application-php"><span class="nav-number">3.2.</span> <span class="nav-text">Application.php</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一、registerBaseBindings"><span class="nav-number">3.2.1.</span> <span class="nav-text">一、registerBaseBindings()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二、registerBaseServiceProviders"><span class="nav-number">3.2.2.</span> <span class="nav-text">二、registerBaseServiceProviders()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三、registerCoreContainerAliases"><span class="nav-number">3.2.3.</span> <span class="nav-text">三、registerCoreContainerAliases()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四、setBasePath"><span class="nav-number">3.2.4.</span> <span class="nav-text">四、setBasePath()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#认识-Bind"><span class="nav-number">4.</span> <span class="nav-text">认识 Bind</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#总结-1"><span class="nav-number">4.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#认识-Make"><span class="nav-number">5.</span> <span class="nav-text">认识 Make</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#正确执行-Make"><span class="nav-number">5.1.</span> <span class="nav-text">正确执行 Make</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结-2"><span class="nav-number">5.2.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#启动-kernel"><span class="nav-number">6.</span> <span class="nav-text">启动 kernel</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Build-方法逻辑顺序："><span class="nav-number">6.1.</span> <span class="nav-text">Build 方法逻辑顺序：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结-3"><span class="nav-number">6.2.</span> <span class="nav-text">总结</span></a></li></ol></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2017 - 2020 Keep It Simple And Stupid All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



<script src="/js/scripts.js"></script>




  <script src="/js/dialog.js"></script>








	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Keep It Simple And Stupid
          </div>
          <div class="panel-body">
            Copyright © 2020 CAO XIAN LIANG All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>