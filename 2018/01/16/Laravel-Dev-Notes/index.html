<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>laravel 使用笔记 | Keep It Simple And Stupid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="LaravelFrameworkPHP">
  
  
  
  
  <meta name="description" content="Laravel Dev Notes 学习别人的博客,并且转载的…  路由as 在路由定义中的作用？如何使用？如何向命名过的含参数的路由传递参数？ 命名路由让你可以更方便的「为特定路由生成 URL 」或「进行重定向」。">
<meta name="keywords" content="Laravel,Framework,PHP">
<meta property="og:type" content="article">
<meta property="og:title" content="Laravel 使用笔记">
<meta property="og:url" content="http://blog.caoxl.com/2018/01/16/Laravel-Dev-Notes/index.html">
<meta property="og:site_name" content="Keep It Simple And Stupid">
<meta property="og:description" content="Laravel Dev Notes 学习别人的博客,并且转载的…  路由as 在路由定义中的作用？如何使用？如何向命名过的含参数的路由传递参数？ 命名路由让你可以更方便的「为特定路由生成 URL 」或「进行重定向」。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-08-22T03:58:58.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Laravel 使用笔记">
<meta name="twitter:description" content="Laravel Dev Notes 学习别人的博客,并且转载的…  路由as 在路由定义中的作用？如何使用？如何向命名过的含参数的路由传递参数？ 命名路由让你可以更方便的「为特定路由生成 URL 」或「进行重定向」。">
  
    <link rel="alternate" href="/atom.xml" title="Keep It Simple And Stupid" type="application/atom+xml">
  

  

  <link rel="icon" href="https://source.unsplash.com/random">
  <link rel="apple-touch-icon" href="/https://source.unsplash.com/random">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">

  
    <link rel="stylesheet" href="/css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css">
  

  
  
  

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="https://source.unsplash.com/random">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">分类</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-Laravel-Dev-Notes" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      Laravel 使用笔记
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/01/16/Laravel-Dev-Notes/" class="article-date">
	  <time datetime="2018-01-16T07:01:17.000Z" itemprop="datePublished">2018-01-16</time>
	</a>

      
    <a class="article-category-link" href="/categories/Laravel-Lumen/">Laravel / Lumen</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>

    <div class="article-entry" itemprop="articleBody">
      
        
        
          <h1 id="Laravel-Dev-Notes"><a href="#Laravel-Dev-Notes" class="headerlink" title="Laravel Dev Notes"></a>Laravel Dev Notes</h1><blockquote>
<p>学习别人的博客,并且转载的…</p>
</blockquote>
<h1 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h1><h2 id="as-在路由定义中的作用？如何使用？如何向命名过的含参数的路由传递参数？"><a href="#as-在路由定义中的作用？如何使用？如何向命名过的含参数的路由传递参数？" class="headerlink" title="as 在路由定义中的作用？如何使用？如何向命名过的含参数的路由传递参数？"></a>as 在路由定义中的作用？如何使用？如何向命名过的含参数的路由传递参数？</h2><blockquote>
<p>命名路由让你可以更方便的「为特定路由生成 URL 」或「进行重定向」。</p>
</blockquote>
<a id="more"></a>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 定义路由 并为其命名</span></span><br><span class="line"><span class="comment"># 第一种 =&gt; 通过数组键 `as` 命名</span></span><br><span class="line">Route::get(<span class="string">'user/profile/&#123;id&#125;'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'profile'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'user/profile/&#123;id&#125;'</span>;</span><br><span class="line">&#125;]);</span><br><span class="line"><span class="comment"># 命名路由群组和子路由</span></span><br><span class="line">Route::group([<span class="string">'as'</span> =&gt; <span class="string">'admin::'</span>], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    Route::get(<span class="string">'dashboard'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'dashboard'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 路由名称为「admin::dashboard」</span></span><br><span class="line">    &#125;]);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二种 =&gt; 通过链式调用 `name()` 方法命名</span></span><br><span class="line">Route::get(<span class="string">'user/profile/&#123;id&#125;'</span>, <span class="string">'UserController@showProfile'</span>)-&gt;name(<span class="string">'profile'</span>);</span><br><span class="line"><span class="comment"># 2. 使用命名过的路由</span></span><br><span class="line">Route::get(<span class="string">'test_profile'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> redirect()-&gt;route(<span class="string">'profile'</span>, [<span class="string">'id'</span> =&gt; <span class="number">1</span>]);    <span class="comment">// 这里的 `profile` 就是某条路由定义过的命名; `id` 就是该路由中的参数名</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> redirect()-&gt;route(<span class="string">'admin::dashboard'</span>);    <span class="comment">// 重定向到路由群组命名过的子路由</span></span><br><span class="line">  <span class="comment"># Or</span></span><br><span class="line">  <span class="comment"># return redirect()-&gt;to(route('profile'));</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="路由参数限制"><a href="#路由参数限制" class="headerlink" title="路由参数限制"></a>路由参数限制</h2><ul>
<li>可选路由参数<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参数名后面 结束 `&#125;` 之前的 `?` 代表此路由参数为可选参数</span></span><br><span class="line">Route::get(<span class="string">'user/&#123;name?&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($name = <span class="string">'John'</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $name;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>正则过滤路由参数：未通过正则检查的路由参数将会出现 NotFoundHttpException 报错<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 局部限制</span></span><br><span class="line">Route::get(<span class="string">'user/&#123;id&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)-&gt;where(<span class="string">'id'</span>, <span class="string">'[0-9]+'</span>);</span><br><span class="line"><span class="comment"># 全局限制 =&gt; boot()@/app/Providers/RouteServiceProvider.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">(Router $router)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $router-&gt;pattern(<span class="string">'id'</span>, <span class="string">'[0-9]+'</span>);    <span class="comment">// 模式一旦被定义，便会自动应用到所有使用该「参数名称」的路由上</span></span><br><span class="line">    <span class="keyword">parent</span>::boot($router);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="url-和-route-的区别"><a href="#url-和-route-的区别" class="headerlink" title="url() 和 route() 的区别"></a>url() 和 route() 的区别</h2><p> <code>url()</code> 可以生成任意的 URL，不检查是否是合法路由。</p>
<p> <code>route()</code> 则会接受命名过的路由别名，然后生成 URL。如果路由别名不存在，则会报错。</p>
<h2 id="关于子域名路由"><a href="#关于子域名路由" class="headerlink" title="关于子域名路由"></a>关于子域名路由</h2><blockquote>
<p>子域名可以像路由 URIs 分配路由参数。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Route::group([<span class="string">'domain'</span> =&gt; <span class="string">'&#123;account&#125;.myapp.com'</span>], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    Route::get(<span class="string">'user/&#123;id&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($account, $id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里需要额外说明的是，要使用上子域名这个功能，必须要在域名解析那里将所有具体的子域名指向和主域名同样的服务器（泛解析），同样的网站路径下，才有意义。</p>
<ul>
<li><p>路由群组共用参数和嵌套群路由</p>
<p>在路由的第一个数组数组参数中的 prefix 键，代表的是「当前群路由」中共用的路由前缀，其值也可以包含参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Route::group([</span><br><span class="line">	<span class="string">'as'</span>     =&gt; <span class="string">'admin::'</span>,</span><br><span class="line">	<span class="string">'prefix'</span> =&gt; <span class="string">'admin'</span>,</span><br><span class="line">	], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    Route::get(<span class="string">'dashboard'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'dashboard'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 路由名称为「admin::dashboard」</span></span><br><span class="line">        <span class="comment">// URL =&gt; route('admin::dashboard');</span></span><br><span class="line">    &#125;]);</span><br><span class="line">    <span class="comment">// 嵌套群路由</span></span><br><span class="line">    Route::group([</span><br><span class="line">    	<span class="string">'prefix'</span> =&gt; <span class="string">'accounts/&#123;account_id&#125;'</span>     <span class="comment">// 路由群组共用参数</span></span><br><span class="line">    	], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">	    Route::get(<span class="string">'detail'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($account_id)</span>    </span>&#123;</span><br><span class="line">	        <span class="comment">// URL =&gt; /admin/accounts/&#123;account_id&#125;/detail</span></span><br><span class="line">	    &#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h1><h2 id="POST-API-中禁用-CSRF-中间件"><a href="#POST-API-中禁用-CSRF-中间件" class="headerlink" title="POST API 中禁用 CSRF 中间件"></a>POST API 中禁用 CSRF 中间件</h2><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App\Http\Middleware\VerifyCsrfToken</span></span><br><span class="line"><span class="keyword">protected</span> $<span class="keyword">except</span> = [</span><br><span class="line">  <span class="string">'/api/*'</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h2 id="自定义-Auth-中间件"><a href="#自定义-Auth-中间件" class="headerlink" title="自定义 Auth 中间件"></a>自定义 Auth 中间件</h2><ul>
<li>创建类文件<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">php</span> <span class="selector-tag">artisan</span> <span class="selector-tag">make</span><span class="selector-pseudo">:middleware</span> <span class="selector-tag">UserAuth</span></span><br><span class="line"><span class="selector-tag">php</span> <span class="selector-tag">artisan</span> <span class="selector-tag">make</span><span class="selector-pseudo">:middleware</span> <span class="selector-tag">AdminAuth</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>编写 handle() 方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AdminAuth</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!session()-&gt;has(<span class="string">'admin'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> redirect()-&gt;to(<span class="string">'/admin/login'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> $next($request);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// UserAuth</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!session()-&gt;has(<span class="string">'user'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> redirect()-&gt;to(<span class="string">'/login'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> $next($request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>注册／挂载到应用内核 $routeMiddleware<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// app\Http\Kernel.php</span><br><span class="line">portected $routeMiddleware = [</span><br><span class="line">  // ...</span><br><span class="line">  <span class="string">'auth.admin'</span> =&gt; \App\Http\Middleware\AdminAuth::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">  <span class="string">'auth.user'</span> =&gt; \App\Http\Middleware\UserAuth::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>路由中调用新中间件<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Route::group([</span><br><span class="line">  <span class="string">'prefix'</span>     =&gt; <span class="string">'/profile'</span>,</span><br><span class="line">  <span class="string">'middleware'</span> =&gt; <span class="string">'auth.user'</span>,</span><br><span class="line">], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line">Route::group([</span><br><span class="line">  <span class="string">'prefix'</span>     =&gt; <span class="string">'/admin'</span>,</span><br><span class="line">  <span class="string">'middleware'</span> =&gt; <span class="string">'auth.admin'</span>,</span><br><span class="line">], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><h2 id="查询构造器"><a href="#查询构造器" class="headerlink" title="查询构造器"></a>查询构造器</h2><h2 id="distinct-select"><a href="#distinct-select" class="headerlink" title="distinct select"></a>distinct select</h2><p>必须 select 中指定之后 distinct 才有效。</p>
<h2 id="模型也能使用其方法"><a href="#模型也能使用其方法" class="headerlink" title="模型也能使用其方法"></a>模型也能使用其方法</h2><p>在 Laravel 模型中，也能使用和查询构造器一样的一些方法。</p>
<h2 id="往数据库插入测试数据"><a href="#往数据库插入测试数据" class="headerlink" title="往数据库插入测试数据"></a>往数据库插入测试数据</h2><ul>
<li>通过 seeder =&gt; 直接修改 database/DatabaseSeeder.php<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">function</span> <span class="selector-tag">run</span>()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">Model</span>::<span class="built_in">unguard</span>();</span><br><span class="line">  <span class="attribute">DB</span>::<span class="built_in">table</span>(<span class="string">'users'</span>)<span class="built_in">-</span>&gt;<span class="built_in">insert</span>([</span><br><span class="line">    [</span><br><span class="line">      <span class="string">'name'</span>     =&gt; str_random(<span class="number">10</span>),</span><br><span class="line">      <span class="string">'email'</span>    =&gt; <span class="built_in">str_random</span>(<span class="number">10</span>).<span class="string">'@gmail.com'</span>,</span><br><span class="line">      <span class="string">'password'</span> =&gt; <span class="built_in">bcrypt</span>(<span class="string">'secret'</span>),</span><br><span class="line">    ],</span><br><span class="line">    // more ...</span><br><span class="line">  ]);</span><br><span class="line">  <span class="attribute">Model</span>::<span class="built_in">reguard</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>通过调用 seeder:</p>
<ul>
<li>生成独立的 seeder：php artisan make:seeder UsersTableSeeder</li>
<li>修改 UsersTableSeeder 中要填充的内容和数量</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">function</span> <span class="selector-tag">run</span>()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">DB</span>::<span class="built_in">table</span>(<span class="string">'users'</span>)<span class="built_in">-</span>&gt;<span class="built_in">insert</span>([</span><br><span class="line">    [</span><br><span class="line">      <span class="string">'name'</span>     =&gt; str_random(<span class="number">10</span>),</span><br><span class="line">      <span class="string">'email'</span>    =&gt; <span class="built_in">str_random</span>(<span class="number">10</span>).<span class="string">'@gmail.com'</span>,</span><br><span class="line">      <span class="string">'password'</span> =&gt; <span class="built_in">bcrypt</span>(<span class="string">'secret'</span>),</span><br><span class="line">    ],</span><br><span class="line">    // more ...</span><br><span class="line">  ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>DatabaseSeeder 中调用: call(UsersTableSeeder);</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Model::unguard();</span><br><span class="line">  <span class="keyword">$this</span>-&gt;call(UserTableSeeder::class);</span><br><span class="line">  Model::reguard();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>通过模型工厂：</p>
<ul>
<li>将要填充数据的表对应的模型及其格式注册到 databse/factories/ModelFactory.php</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$factory-&gt;define(App\Models\User::class, <span class="function"><span class="keyword">function</span> <span class="params">(Faker\Generator $faker)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'name'</span> =&gt; $faker-&gt;name,</span><br><span class="line">        <span class="string">'email'</span> =&gt; $faker-&gt;safeEmail,</span><br><span class="line">        <span class="string">'password'</span> =&gt; bcrypt(str_random(<span class="number">10</span>)),</span><br><span class="line">        <span class="string">'remember_token'</span> =&gt; str_random(<span class="number">10</span>),</span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>然后在 DatabaseSeeder 中调用 factory()-&gt;times()-&gt;make()</li>
<li><p>最后通过模型类一次性插入生成的测试数据</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Model::unguard();</span><br><span class="line">  <span class="comment"># 默认的方式 但不推荐使用 `create()`</span></span><br><span class="line">  <span class="comment">// factory(App\Models\User::class, 50)-&gt;create()-&gt;each(function($u) &#123;</span></span><br><span class="line">  <span class="comment">//     $u-&gt;posts()-&gt;save(factory(App\Post::class)-&gt;make());</span></span><br><span class="line">  <span class="comment">// &#125;);</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 推荐使用 `make()`</span></span><br><span class="line">  $users = factory(\App\Models\User::class)-&gt;times(<span class="number">100</span>)-&gt;make();</span><br><span class="line">  \App\Models\User::insert($users-&gt;toArray());</span><br><span class="line">  Model::reguard();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Migration"><a href="#Migration" class="headerlink" title="Migration"></a>Migration</h2><h2 id="create-TABLE-NAME-和-table-TABLE-NAME"><a href="#create-TABLE-NAME-和-table-TABLE-NAME" class="headerlink" title="--create=TABLE_NAME 和 --table=TABLE_NAME"></a><code>--create=TABLE_NAME</code> 和 <code>--table=TABLE_NAME</code></h2><p>有什么区别？创建 migrations 时是否需要带上此参数？</p>
<p>带 <code>--create=TABLE_NAME</code> 表示在运行 <code>php artisan migrate</code> 的时候会创建物理表（表名为 TABLE_NAME）到数据库，不带则只是创建该迁移文件。</p>
<p>带 <code>--table=TABLE_NAME</code> 表示在进行修改表操作的时候指定要修改的表名为 TABLE_NAME。</p>
<p>最后，对应到 migrations 文件中的 up() 方法，<code>--create=TABLE_NAME</code> 调用的是 <code>Schema::create(&#39;TABLE_NAME&#39;)</code>，而 <code>--table=TABLE_NAME</code> 则调用的是 <code>Schema::table(&#39;TABLE_NAME&#39;)</code>。</p>
<p><em>说明:</em><br>如果要运行由不带 <code>--create=TABLE_NAME</code> 的命令创建的 migrations，只需要修改这些文件的 up 方法（看情况，已有内容的可以不用在修改，但是通常都需要修改），即使用 Schema 语法写入需要的数据库操作，最后重新执行以下操作即可：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 修改数据库 migrations 表中要运行的 migration 的 batch 值为当前最高值+1</span></span><br><span class="line"><span class="comment">-- mysql command statart</span></span><br><span class="line"><span class="keyword">update</span> <span class="string">`migrations`</span></span><br><span class="line"><span class="keyword">set</span> <span class="string">`batch`</span> = (batch + <span class="number">1</span>)</span><br><span class="line"><span class="keyword">where</span> <span class="string">`migration`</span> = <span class="string">'2014_10_12_000000_create_users_table'</span>;</span><br><span class="line"><span class="comment">-- mysql command end</span></span><br><span class="line"><span class="comment"># 2. 回滚已手动置新的 migration 最新批次</span></span><br><span class="line">php artisan <span class="keyword">rollback</span></span><br><span class="line"><span class="comment"># 3. 重新执行迁移</span></span><br><span class="line">php artisan migrate</span><br></pre></td></tr></table></figure>
<p>这里的 batch 代表的是执行 php artisan migrate 的批次，即是记录 laravel 是第几批运行某个具体的迁移的。</p>
<p>batch 值相同的 migrations 在执行 php artisan migrate:rollback 时都会被回滚。</p>
<h2 id="关于-up-和-down"><a href="#关于-up-和-down" class="headerlink" title="关于 up() 和 down()"></a>关于 <code>up()</code> 和 <code>down()</code></h2><p>这两个方法必须要是互逆的。</p>
<p>即使说，up() 里面写的是 <code>create</code>，<code>down()</code> 里面就必须写 <code>drop</code>，而不能写 <code>renameColumn()</code> 之类的，反之同理。</p>
<h2 id="Eloquent"><a href="#Eloquent" class="headerlink" title="Eloquent"></a>Eloquent</h2><ul>
<li>关于调用含有 hasMany() 和 belongsTo() 关系的方法</li>
</ul>
<p>实际调用的时候不能当作方法调用，而要当作属性获取。</p>
<p>即不能写成类似 <code>$user-&gt;tasks()</code> 而要写成 <code>$user-&gt;tasks</code>。</p>
<p>此外，含有这些关联属性的方法名的单复数形式要和关系相对应，即如果是 <code>belongs-to</code> 关系，则模型中相应的方法名应该是<code>单数</code>，如果是 <code>has-many</code> 关系，则模型中相应的方法名应该是复数，举例说明：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># App\Models\Task.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(User::class);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># App\Models\User.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasMany(Task::class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>什么时候适合用 Eloquent？</li>
</ul>
<p>Eloquent 在对常见数据库操作时是非常得心应手的，比如单表的增删改，表的查询（包括联表），都是 OK 的，首选 ORM 比较合适。</p>
<p>但是，在一些增删改完整性要求高的情况下，比如事务，这时候 Eloquent 是没办法做到的，这时候只能使用 DB Facade 提供的事务处理方法。</p>
<ul>
<li><code>$fillable</code>／<code>$guarded</code> and Mass Assignment？</li>
</ul>
<p>Mass Assignment，或称批量复制，指的是在 Laravel 在创建 Model 时可以批量传入一个数组，一次性设置好要保存的属性，而不用一个个指定字段具体的值，比如可以直接快速创建一个用户： $user = new User(Input::all());。</p>
<p><code>$fillable</code> 和 <code>$guarded</code> 都是在批量赋值过程中使用的， <code>$fillable</code> 相当于的白名单，<code>$guarded</code> 相当于黑名单，使用时只能使用其一。 <strong>白名单总能覆盖黑名单</strong>。</p>
<p>默认情况下，模型的所有属性都是黑名单，只有 $fillable 中的属性才能在批量赋值时被插入数据库。</p>
<p>但是，并不是说 $fillable 之外的属性都不能被赋值，只是，不能批量赋值，可以单独为一些特殊字段赋值，然后保存：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span>-&gt;user_type = <span class="string">'admin'</span>;</span><br><span class="line"><span class="variable">$user</span>-&gt;save();</span><br></pre></td></tr></table></figure>
<p>当要批量赋值 $fillable 中没有指定的属性时，可以使用 forceCreate() 硬性创建，只是需要确保特殊字段的安全性。</p>
<h2 id="团队数据库开发的工作流简要说明"><a href="#团队数据库开发的工作流简要说明" class="headerlink" title="团队数据库开发的工作流简要说明"></a>团队数据库开发的工作流简要说明</h2><p>此流程相关的元素有：migration &amp; seeder|factories &amp; git，下面举例说明：</p>
<ul>
<li><p>A 在其本机建新表 users，插入了一些测试数据，最后生成了 migrations，seeds 或者 factories 文件</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 1. 创建迁移</span></span><br><span class="line">php artisan make:migration create_users_table --create=users</span><br><span class="line"><span class="meta"># 2. 根据需要修改 migrations 中的定义</span></span><br><span class="line"><span class="meta"># 3. 运行迁移 =&gt; 插入该迁移中定义的表到数据库</span></span><br><span class="line">php artisan migrate</span><br><span class="line"><span class="meta"># 4. 为该表插入测试数据（具体操作详见：@往数据库插入测试数据）</span></span><br><span class="line"><span class="meta"># 5. 提交到 git 仓库</span></span><br><span class="line">git add -A &amp;&amp; git commit -m <span class="string">"create table users"</span></span><br><span class="line">git pull origin dev # 根据实际情况看是否需要合并冲突</span><br><span class="line">git push origin own_branch</span><br></pre></td></tr></table></figure>
</li>
<li><p>B 拉取到表 users 的结构和 seeder，然后同步新改动到本机</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 拉取仓库最新改动</span></span><br><span class="line"><span class="attr">git</span> <span class="string">pull origin dev    # 假设协作分支为 dev（根据情况看是否需要先提交本地改动）</span></span><br><span class="line"><span class="comment"># 2. 迁移数据库更新（同步）</span></span><br><span class="line"><span class="attr">php</span> <span class="string">artisan migrate</span></span><br><span class="line"><span class="comment"># 3. 同步测试数据（可选）</span></span><br><span class="line"><span class="attr">php</span> <span class="string">artisan db:seed</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>B 为 users 表新增一个 gender 字段，也插入了一些测试数据，最后生成了 migrations, seeds 或者 factories 文件</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 1. 创建迁移</span></span><br><span class="line">php artisan make:migration add_gender_to_users_table --table=users</span><br><span class="line"><span class="meta"># 2. 修改迁移定义 为表 users 表新增 gender 字段</span></span><br><span class="line"><span class="meta"># 3. 运行迁移（同上）</span></span><br><span class="line"><span class="meta"># 4. 为该表插入测试数据（同上）</span></span><br><span class="line"><span class="meta"># 5. 提交到 git 仓库（同上）</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>最简单的工作流程就是这样，如果有更多的开发者，也是按照这个基本流程来同步数据库改动。</p>
<p>可以看出，通过 laravel，多人同步数据库版本的核心其实就只有 php artisan migrate 这一条命令，包括最后部署到服务器，也只需要 migrate 一下就可以了，个人认为是很简单。</p>
<p><em>说明:</em><br>如果对数据库有新的改动，则必须要创建新的迁移。最好不要修改已经迁移过的 migrations，因为如果要同步这些已修改的迁移，则需要先将这个迁移手动置最新一批，然后回滚，再执行 php artisan migrate 才能生效。</p>
<p>但是，由于保存 migrations files 的迁移批次是存在数据库中的，而 A 的数据库表 migrations 并不会同步到 B 数据库的 migrations 表，因此如果 B 得到了 A 修改过已迁移过的 migrations files 也需要先将这个迁移手动置最新一批，然后回滚，再执行 <code>php artisan migrate</code> 才能生效</p>
<p>所以，<strong>数据库每发生一次改动，最好是新建一次迁移</strong>。</p>
<h1 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h1><h2 id="启用-auth-认证的前提"><a href="#启用-auth-认证的前提" class="headerlink" title="启用 auth 认证的前提"></a>启用 auth 认证的前提</h2><h2 id="Users-表必须字段"><a href="#Users-表必须字段" class="headerlink" title="Users 表必须字段"></a>Users 表必须字段</h2><ul>
<li>可以唯一标志一个用户的账号：至少有一个，可以是 username，也可以是 email，手机号码等。</li>
<li>password：&gt; 60 个字符。</li>
<li>remember_token：nullable 、100 个字符。（migration class: $table-&gt;rememberToken()）</li>
</ul>
<h2 id="表单"><a href="#表单" class="headerlink" title="表单"></a>表单</h2><ul>
<li><input name="email" type="text"></li>
<li><input name="password" type="password"></li>
<li><input name="remember" type="checkbox">

</li>
</ul>
<p>表单需要的 name 值具体是什么，取决于在 PHP 中所定义的接受 Key。比如，可以把 email 换成 account，并使用户无论输入邮箱还是用户名都可以登录成功。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 获得登录凭证</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@overide</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getCredentials</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  $login = $request-&gt;get(<span class="string">'account'</span>);</span><br><span class="line">  $field = filter_var($login, FILTER_VALIDATE_EMAIL) ? <span class="string">'email'</span> : <span class="string">'name'</span>;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    $field =&gt; $login,</span><br><span class="line">    <span class="string">'password'</span> =&gt; $request-&gt;get(<span class="string">'password'</span>),</span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul>
<li>默认规定的路由格式，重定向位置，认证相关视图路径（默认在 auth/ 下面）都是可以自定义的。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># routes.php</span></span><br><span class="line">Route::post(<span class="string">'login'</span>, <span class="string">'Auth\AuthController@postLogin'</span>);</span><br><span class="line"><span class="comment"># AuthController Class</span></span><br><span class="line"><span class="keyword">protected</span> $username = <span class="string">'account'</span>;      <span class="comment">// 用户账户的唯一标志</span></span><br><span class="line"><span class="keyword">protected</span> $redirectPath = <span class="string">'/home'</span>;    <span class="comment">// 用户登录成功后的重定向路由</span></span><br><span class="line"><span class="comment"># Authenticate Class =&gt; handle()</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;auth-&gt;guest()) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;ajax()) &#123;</span><br><span class="line">      <span class="keyword">return</span> response(<span class="string">'Unauthorized.'</span>, <span class="number">401</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> redirect()-&gt;guest(<span class="string">'auth/login'</span>);     <span class="comment">// 表单形式登录校验失败后重定向路由</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> $next($request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用认证中间件-Auth-的几个地方"><a href="#调用认证中间件-Auth-的几个地方" class="headerlink" title="调用认证中间件 Auth 的几个地方"></a>调用认证中间件 Auth 的几个地方</h2><ul>
<li><p>路由闭包</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 普通路由</span></span><br><span class="line">Route::get(<span class="string">'profile'</span>, [</span><br><span class="line">  <span class="string">'middleware'</span> =&gt; <span class="string">'auth'</span>,</span><br><span class="line">  <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...     // 只有认证过的用户能进来这里</span></span><br><span class="line">&#125;]);</span><br><span class="line"><span class="comment"># 群路由</span></span><br><span class="line">Route::group([</span><br><span class="line">  <span class="string">'middleware'</span> =&gt; <span class="string">'auth'</span></span><br><span class="line">], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>控制器构造器</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;middleware(<span class="string">'auth'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="自定义最大登录尝试次数、冻结登录时间和错误提示消息"><a href="#自定义最大登录尝试次数、冻结登录时间和错误提示消息" class="headerlink" title="自定义最大登录尝试次数、冻结登录时间和错误提示消息"></a>自定义最大登录尝试次数、冻结登录时间和错误提示消息</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  App\Http\Controllers\Auth\AuthController.php</span></span><br><span class="line"><span class="keyword">protected</span> $maxLoginAttempts = <span class="number">10</span>; <span class="comment">// Amount of bad attempts user can make</span></span><br><span class="line"><span class="keyword">protected</span> $lockoutTime = <span class="number">300</span>; <span class="comment">// Time for which user is going to be blocked in seconds</span></span><br><span class="line"><span class="comment"># resources/lang/en/auth.php</span></span><br><span class="line"><span class="string">'failed'</span> =&gt; <span class="string">'These credentials do not match our records.'</span>,</span><br><span class="line"><span class="string">'throttle'</span> =&gt; <span class="string">'Too many login attempts. Please try again in :seconds seconds.'</span>,</span><br></pre></td></tr></table></figure>
<h1 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h1><p>授权的目的，是为了检查某个角色是否具备某个权限。</p>
<p>具体到代码层面，通常是去判断模型 A 是否与模型 B 有所属关系。</p>
<blockquote>
<p>数据库表的关联字段是否相同，或者专门的权限表中是否有模型 A 和 B 的关联记录，等等。</p>
</blockquote>
<p>Laravel （&gt;5.1.11）默认授权工作流程如下：</p>
<h2 id="定义权限"><a href="#定义权限" class="headerlink" title="定义权限"></a>定义权限</h2><p>通过 Illuminate\Auth\Access\Gate 类，在 AuthServiceProvider 文件中定义应用中的所有权限</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">Access</span>\<span class="title">Gate</span> <span class="title">as</span> <span class="title">GateContract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Support</span>\<span class="title">Providers</span>\<span class="title">AuthServiceProvider</span> <span class="title">as</span> <span class="title">ServiceProvider</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="comment">// 注册应用程序的认证或授权服务</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">(GateContract $gate)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;registerPolicies($gate);</span><br><span class="line">    	<span class="comment">// 1. 通过回调处理授权</span></span><br><span class="line">        $gate-&gt;define(<span class="string">'edit-post'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($user, $post)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $user-&gt;id === $post-&gt;user_id;</span><br><span class="line">        &#125;);</span><br><span class="line">    	<span class="comment">// 2. 通过类和方法名</span></span><br><span class="line">    	<span class="comment">// $gate-&gt;define('edit-post', 'ClassName@methodName');</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的闭包里不用手动检查 $user 是否存在，未登录用户或是没有用 forUser() 方法指定的用户，Gate 自动返回的权限值为 false。</p>
<h2 id="定义拦截授权事件"><a href="#定义拦截授权事件" class="headerlink" title="定义拦截授权事件"></a>定义拦截授权事件</h2><p>在判断所有已定义权限之前，可以为某些特殊用户，比如最高权限的超级管理员（或者最低权限的访客），中断其后的授权校验，直接判定为拥有最高权限。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$gate-&gt;before(<span class="function"><span class="keyword">function</span> <span class="params">($user, $ability)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($user-&gt;isSuperAdmin()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>也可以使用 after() 方法定义一个在所有授权检查结束后会被运行的回调，但是无法修改 after 回调中授权检查的结果。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$gate-&gt;after(<span class="function"><span class="keyword">function</span> <span class="params">($user, $ability, $result, $arguments)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="检查权限"><a href="#检查权限" class="headerlink" title="检查权限"></a>检查权限</h2><p>各种权限定义好后，接下来就是进行权限检查。Laravel 有以下几种检查方式：</p>
<h2 id="通过-Gate-Facade"><a href="#通过-Gate-Facade" class="headerlink" title="通过 Gate Facade"></a>通过 Gate Facade</h2><p>Gate facade 包含 3 个方法：check、allows、denies。</p>
<p>以判断当前用户是否有刚刚创建的 edit-post 权限举例说明：</p>
<h3 id="检查已登录用户权限"><a href="#检查已登录用户权限" class="headerlink" title="检查已登录用户权限"></a>检查已登录用户权限</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Gate</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Modles</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Modles</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 编辑指定的文章</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">edit</span><span class="params">($id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $post = Post::findOrFail($id);</span><br><span class="line">      	<span class="comment">// 1.使用 denies</span></span><br><span class="line">        <span class="keyword">if</span> (Gate::denies(<span class="string">'edit-post'</span>, $post)) &#123;</span><br><span class="line">            abort(<span class="number">403</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 更新文章...</span></span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">      	<span class="comment">// 2.使用 allows 或 check (和 denies 相反)</span></span><br><span class="line">      	<span class="comment">// cheak 是 allows 的别名</span></span><br><span class="line">        <span class="keyword">if</span> (Gate::allows(<span class="string">'edit-post'</span>, $post)) &#123;</span><br><span class="line">          <span class="comment">// 更新文章...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            abort(<span class="number">403</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里不需要传递当前登录用户至该方法内，因为 Gate 会自动加载当前登录用户。</p>
<h3 id="检查指定用户的权限"><a href="#检查指定用户的权限" class="headerlink" title="检查指定用户的权限"></a>检查指定用户的权限</h3><p>如果想要检查已登录用户之外的其他用户是否具有指定的权限，可以使用 forUser() 方法：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (Gate::forUser(<span class="variable">$user</span>)-&gt;allows(<span class="string">'edit-post'</span>, <span class="variable">$post</span>)) &#123;</span><br><span class="line">    /<span class="regexp">/ do right thing</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="多参数情况"><a href="#多参数情况" class="headerlink" title="多参数情况"></a>多参数情况</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.权限定义时回调的参数</span></span><br><span class="line">Gate::define(<span class="string">'delete-comment'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($user, $post, $comment)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 2.同时校验多个权限</span></span><br><span class="line"><span class="keyword">if</span> (Gate::allows(<span class="string">'delete-comment'</span>, [$post, $comment])) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="通过-User-Model"><a href="#通过-User-Model" class="headerlink" title="通过 User Model"></a>通过 User Model</h2><p>默认情况下，Laravel 的模型使用了 Authorizable trait，它提供了两个方法：can 及 cannot，类似于 Gate 的 allows和 denies。</p>
<p>还是用上面的例子说明：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编辑指定的文章</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">edit</span><span class="params">(Request $request, $id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  $post = Post::findOrFail($id);</span><br><span class="line">  <span class="keyword">if</span> ($request-&gt;user()-&gt;cannot(<span class="string">'edit-post'</span>, $post)) &#123;</span><br><span class="line">    abort(<span class="number">403</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">// 更新文章...</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 或者使用 can 反回来</span></span><br><span class="line">  <span class="keyword">if</span> ($request-&gt;user()-&gt;can(<span class="string">'edit-post'</span>, $post)) &#123;</span><br><span class="line">	<span class="comment">// 更新文章...</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    abort(<span class="number">403</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="通过-Blade-模版标签"><a href="#通过-Blade-模版标签" class="headerlink" title="通过 Blade 模版标签"></a>通过 Blade 模版标签</h2><p>在 Blade 模板中，你还可以使用 @can 标签来快速检查当前登录用户是否有指定的权限。例子同上：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/post/</span></span></span><span class="template-variable">&#123;&#123; $post-&gt;id &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span>查看文章<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">@can('edit-post', $post)</span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- 当前登录用户可以编辑文章 --&gt;</span></span></span><br><span class="line"><span class="xml">@else</span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- 当前登录用户不可以编辑文章 --&gt;</span></span></span><br><span class="line"><span class="xml">@endcan</span></span><br></pre></td></tr></table></figure>
<h2 id="通过表单请求授权"><a href="#通过表单请求授权" class="headerlink" title="通过表单请求授权"></a>通过表单请求授权</h2><p>表单请求 是一个自定义的请求类，里面包含着验证逻辑，需要先创建好表单请求类。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">php</span> <span class="selector-tag">artisan</span> <span class="selector-tag">make</span><span class="selector-pseudo">:request</span> <span class="selector-tag">UpdatePostRequest</span></span><br></pre></td></tr></table></figure>
<p>可以在 UpdatePostRequest 类中的的 authorize() 方法中调用 Gate 进行授权验证。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authorize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $postId = <span class="keyword">$this</span>-&gt;route(<span class="string">'post'</span>);</span><br><span class="line">    <span class="keyword">return</span> Gate::allows(<span class="string">'edit-post'</span>, Post::findOrFail($postId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义请求类编写好后，就可以作为 Laravel 默认的 Request 类传入控制器使用了。</p>
<p>如果 authorize 方法返回 false，则会自动返回一个 HTTP 响应，其中包含 403 状态码，而你的控制器方法也将不会被运行。（这样也简化了控制器代码量）</p>
<h1 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h1><h2 id="Blade-标签的几种形态"><a href="#Blade-标签的几种形态" class="headerlink" title="Blade 标签的几种形态"></a>Blade 标签的几种形态</h2><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 普通形态「实体转义过」</span></span><br><span class="line">&#123;&#123; $var &#125;&#125;</span><br><span class="line"><span class="comment"># 2. 注释形态</span></span><br><span class="line">&#123;&#123;<span class="comment">-- This is a comment, which will not be in the rendered HTML --&#125;&#125;</span></span><br><span class="line"><span class="comment"># 3. 原样输出形态</span></span><br><span class="line">@&#123;&#123; whatever you <span class="built_in">write</span> here will be output <span class="keyword">in</span> HTML, rather than executed &#125;&#125;</span><br><span class="line"><span class="comment"># 4. 原样执行形态「HTML 实体将不被转义」</span></span><br><span class="line">&#123;!! '&lt;<span class="keyword">script</span>&gt;alert(<span class="string">"will be executed"</span>)&lt;/<span class="keyword">script</span>&gt;' !!&#125;</span><br></pre></td></tr></table></figure>
<h1 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h1><h2 id="Laravel-使用队列步骤"><a href="#Laravel-使用队列步骤" class="headerlink" title="Laravel 使用队列步骤"></a>Laravel 使用队列步骤</h2><ul>
<li>「创建」任务类<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:job SendNoticeEmail <span class="comment">--queued</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>创建后，根据业务需求编写任务类，通常是某个模块所需的耗时功能。比如：发邮件、截图、生成压缩包、七牛云上传，等。</p>
<p><code>--queued</code> 参数表示运行具有队列属性，即该任务类必须实现 ShouldQueue 接口。</p>
<ul>
<li>「派发」任务</li>
</ul>
<p>在某个业务逻辑处派发具体的任务，即「任务入队」：<code>$this-&gt;dispatch($job)</code>。</p>
<p>也支持使用 <code>$this-&gt;dispatchFrom()</code> 从请求中派发任务。</p>
<p><strong>只要使用了 DispatchesJobs trait 的类都可以直接通过 $this-&gt;dispatch($job) 来派发任务到队列上。</strong></p>
<p>在将任务入队的时候，可以用 onQueue(QUEUE_NAME) 指定任务所属的队列；也可以用 delay(secs) 来延迟多少秒后运行。</p>
<ul>
<li>处理「回调」</li>
</ul>
<p>所注册的队列任务，运行完成后会被执行的回调操作，比如：数据库状态更新、邮件通知，等。主要有两种：</p>
<p>完成通过：<code>Queue::after($connection, $job, $data)</code>。</p>
<p>失败通过：<code>Queue::failing($connection, $job, $data)</code>。</p>
<p>通常在 AppServiceProvider 类的 boot() 方法中处理队列回调，其中失败事件可以直接在任务类中重写 failed() 方法来处理任务运行失败后的操作。</p>
<p>这里的 $connection 指的是队列连接类型，比如 database。</p>
<p><code>$job</code> 是指当前任务实例本身的完整信息，其对应的类定义是：Illuminate\Queue\Jobs\DatabaseJob，其中有很多方法可以获取当前队列和任务对象的信息。</p>
<p><code>$data</code> 是被序列化的 <code>$job</code> 对象属性对象，被存储在任务表的 payload 字段，可以通过 unserialize($data[‘data’][‘command’]) 来恢复该实例对象。</p>
<ul>
<li>「侦听」任务</li>
</ul>
<p>代码逻辑写好之后，只是单纯将任务入队操作，并不会执行。需要启动 Laravel 侦听器来处理这些队列任务：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan <span class="built_in">queue</span>:<span class="built_in">listen</span> --<span class="built_in">queue</span>=<span class="keyword">default</span>,capture</span><br></pre></td></tr></table></figure>
<p><code>--queue=default,capture</code> 中代表此侦听器将处理哪些队列，排越靠左的队列，优先级越高。</p>
<h2 id="释放和删除"><a href="#释放和删除" class="headerlink" title="释放和删除"></a>释放和删除</h2><p>从队列中释放一个任务，只是把这个任务重新放回队列，并不是从队列中删除。</p>
<p>要删除一个队列，需要删除队列中相应的记录，比如是数据库驱动的队列，就需要删除任务表中相关的记录。</p>
<p>也可以用 Artisan 命令来删除失败任务:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php artisan <span class="built_in">queue</span>:forget <span class="number">5</span>    # 删除掉某个失败任务</span><br><span class="line"> </span><br><span class="line">php artisan <span class="built_in">queue</span>:<span class="built_in">flush</span>    # 删除所有失败任务</span><br></pre></td></tr></table></figure>
<p>非失败任务不能删除，因为任务成功后会自动删除。</p>
<h2 id="Laravel-队列线上环境实践"><a href="#Laravel-队列线上环境实践" class="headerlink" title="Laravel 队列线上环境实践"></a>Laravel 队列线上环境实践</h2><p>在实际应用（线上）中，往往不是使用 queue:listen 来处理队列任务，而是通过 queue:work 配合 –daemon 选项，再加上 supervisor 进程管理器，来处理线上环境的队列任务。</p>
<p>相关配置及脚本如下：</p>
<ul>
<li>队列任务批量部署脚本<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/env bash</span></span><br><span class="line"><span class="comment"># deploy.sh</span></span><br><span class="line">workers=1</span><br><span class="line">worker_len=16</span><br><span class="line">sleep_secs=3</span><br><span class="line"><span class="comment">#path=/data/wwwroot/eme.dev</span></span><br><span class="line">path=/data/wwwroot/www.eme168.com</span><br><span class="line"><span class="keyword">while</span> (( <span class="variable">$workers</span>&lt;=<span class="variable">$worker_len</span> ))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"deploying phjs-cc queue daemon... (<span class="variable">$workers</span>/<span class="variable">$worker_len</span>)"</span></span><br><span class="line">        php <span class="variable">$path</span>/artisan queue:work database --queue=phjs-cc-<span class="variable">$workers</span> --memory=256 --sleep=2 --tries=2 --daemon &amp;</span><br><span class="line">        sleep <span class="variable">$sleep_secs</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"deploying shrinking-thumb queue daemon... (<span class="variable">$workers</span>/<span class="variable">$worker_len</span>)"</span></span><br><span class="line">        php <span class="variable">$path</span>/artisan queue:work database --queue=shrink-thumb-<span class="variable">$workers</span> --memory=256 --sleep=2 --tries=2 --daemon &amp;</span><br><span class="line">        sleep <span class="variable">$sleep_secs</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"deploying qn-upload queue daemon... (<span class="variable">$workers</span>/<span class="variable">$worker_len</span>)"</span></span><br><span class="line">        php <span class="variable">$path</span>/artisan queue:work database --queue=qn-upload-<span class="variable">$workers</span> --memory=128 --sleep=2 --tries=2 --daemon &amp;</span><br><span class="line">        sleep <span class="variable">$sleep_secs</span></span><br><span class="line">        <span class="built_in">let</span> <span class="string">"workers++"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'deploy finished.'</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br><span class="line"><span class="meta">#! /bin/env bash</span></span><br><span class="line"><span class="comment"># undeploy.sh</span></span><br><span class="line">workers=0</span><br><span class="line">worker_len=16</span><br><span class="line">sleep_secs=1</span><br><span class="line"><span class="keyword">while</span> (( <span class="variable">$workers</span>&lt;=<span class="variable">$worker_len</span> ))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"un-deploying phjs-cc queue daemon... (<span class="variable">$workers</span>/<span class="variable">$worker_len</span>)"</span></span><br><span class="line">        `tmux <span class="built_in">kill</span>-session -t <span class="string">"phjs-cc-<span class="variable">$workers</span>"</span>`</span><br><span class="line">        sleep <span class="variable">$sleep_secs</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"un-deploying shrinking-thumb queue daemon... (<span class="variable">$workers</span>/<span class="variable">$worker_len</span>)"</span></span><br><span class="line">        `tmux <span class="built_in">kill</span>-session -t <span class="string">"shrink-thumb-<span class="variable">$workers</span>"</span>`</span><br><span class="line">        sleep <span class="variable">$sleep_secs</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"un-deploying qn-upload queue daemon... (<span class="variable">$workers</span>/<span class="variable">$worker_len</span>)"</span></span><br><span class="line">        `tmux <span class="built_in">kill</span>-session -t <span class="string">"qn-upload-<span class="variable">$workers</span>"</span>`</span><br><span class="line">        sleep <span class="variable">$sleep_secs</span></span><br><span class="line">        <span class="built_in">let</span> <span class="string">"workers++"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'un-deploy finished.'</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br><span class="line"><span class="comment"># ps -ef | grep php | grep -v grep | awk '&#123;print $2&#125;' | xargs kill -9</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这里部署的后台处理进程个数根据服务器配置情况而定，这里是在 4 核／16G／20M 的阿里云 ECS 机器上部署的。</p>
<ul>
<li><p>安装&amp;使用 supervisor</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以 CentOS 6 为例</span></span><br><span class="line">yum <span class="builtin-name">info</span> supervisor</span><br><span class="line">yum install -y supervisor</span><br><span class="line">service supervisord start|stop|restart</span><br><span class="line">supervisorctl reread</span><br><span class="line">supervisorctl start proj-worker:*</span><br><span class="line">vim /etc/supervisord.conf</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>supervisor 对应配置</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[program:proj-phjs]</span><br><span class="line"><span class="attribute">process_name</span>=%(program_name)s_%(process_num)02d</span><br><span class="line"><span class="attribute">command</span>=php /data/wwwroot/www.proj.com/artisan queue:work database <span class="attribute">--queue</span>=phjs-cc-%(process_num)2d <span class="attribute">--memory</span>=256 <span class="attribute">--sleep</span>=2 <span class="attribute">--tries</span>=2 --daemon</span><br><span class="line"><span class="attribute">autostart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">autorestart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">user</span>=www</span><br><span class="line"><span class="attribute">numprocs</span>=16</span><br><span class="line"><span class="attribute">redirect_stderr</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">stdout_logfile</span>=/data/wwwroot/www.proj.com/storage/logs/sv-worker.log</span><br><span class="line">[program:proj-shrink]</span><br><span class="line"><span class="attribute">process_name</span>=%(program_name)s_%(process_num)02d</span><br><span class="line"><span class="attribute">command</span>=php /data/wwwroot/www.proj.com/artisan queue:work database <span class="attribute">--queue</span>=shrink-thumb-%(process_num)2d <span class="attribute">--memory</span>=256 <span class="attribute">--sleep</span>=2 <span class="attribute">--tries</span>=2 --daemon</span><br><span class="line"><span class="attribute">autostart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">autorestart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">user</span>=www</span><br><span class="line"><span class="attribute">numprocs</span>=16</span><br><span class="line"><span class="attribute">redirect_stderr</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">stdout_logfile</span>=/data/wwwroot/www.proj.com/storage/logs/sv-worker.log</span><br><span class="line">[program:proj-upload]</span><br><span class="line"><span class="attribute">process_name</span>=%(program_name)s_%(process_num)02d</span><br><span class="line"><span class="attribute">command</span>=php /data/wwwroot/www.proj.com/artisan queue:work database <span class="attribute">--queue</span>=qn-upload-%(process_num)2d <span class="attribute">--memory</span>=256 <span class="attribute">--sleep</span>=2 <span class="attribute">--tries</span>=2 --daemon</span><br><span class="line"><span class="attribute">autostart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">autorestart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">user</span>=www</span><br><span class="line"><span class="attribute">numprocs</span>=16</span><br><span class="line"><span class="attribute">redirect_stderr</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">stdout_logfile</span>=/data/wwwroot/www.proj.com/storage/logs/sv-worker.log</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p> 注意这里的 numprocs 数最好和 deploy.sh 里面的 workers 数量保持一致，因为确保每个后台运行的队列处理进程都能被 supervisor 监控到。</p>
<p> 其中，%(process_num)2d 对应的是数 numprocs 内的序号。0 表示不足多少位（这里是2位）时填充。</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="Composer"><a href="#Composer" class="headerlink" title="Composer"></a>Composer</h2><h2 id="安装指定版本的-Laravel"><a href="#安装指定版本的-Laravel" class="headerlink" title="安装指定版本的 Laravel"></a>安装指定版本的 Laravel</h2><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">composer </span><span class="built_in">create-project</span> <span class="string">laravel/</span><span class="string">laravel </span><span class="string">laravel.</span><span class="string">dev </span>5.1</span><br></pre></td></tr></table></figure>
<h2 id="composer-create-project-和-laravel-new-安装方式的区别？"><a href="#composer-create-project-和-laravel-new-安装方式的区别？" class="headerlink" title="composer create-project 和 laravel new 安装方式的区别？"></a><code>composer create-project</code> 和 <code>laravel new</code> 安装方式的区别？</h2><p>前者会通过 Composer 的机制解析并获得 Laravel 的下载包地址后然后下载，再加上国内 packgist.org 的速度不行，不换源很可能打不开，因此导致很慢。</p>
<p>而后者是直接获得 cabinet.laravel.com/latest.zip，自然速度快很多。</p>
<h2 id="dist-source-auto-的区别"><a href="#dist-source-auto-的区别" class="headerlink" title="dist/source/auto 的区别"></a>dist/source/auto 的区别</h2><p>通过 Composer 下载的软件包，是由软件包的「名字+版本号」唯一定义的，实际上，Composer 会把每个版本都当作一个独立的软件包，这个差别在从使用 Composer 的角度来说是不关紧要的，但是当你想要改变源代码的时候就变的很重要了。</p>
<p>不过，除了「名字」+「版本号」之外，还有「元数据」。</p>
<blockquote>
<p>The information most relevant for installation is the source definition, which describes where to get the package contents. The package data points to the contents of the package. And there are two options here: dist and source.</p>
</blockquote>
<ul>
<li><code>dist</code></li>
</ul>
<p>The dist is a packaged version of the package data. Usually a released version, usually a stable release.</p>
<ul>
<li><code>source</code><br>The source is used for development. This will usually originate from a source code repository, such as git. You can fetch this when you want to modify the downloaded package.</li>
</ul>
<p>在安装软件包的时候，dist 和 source 选项可以同时指定，默认是 auto。</p>
<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><ul>
<li><strong>[Doctrine\DBAL\DBALException] Unknown database type enum requested, Doctrine\DBAL\Platforms\MySqlPlatform may not support</strong></li>
</ul>
<p>在含有 enum 属性字段的时候，如果进行重命名等操作，出现了次错误，有一个 workaround 可以解决，需要在具体的修改操作之前加上下面这段代码：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 添加的代码 start</span></span><br><span class="line">Schema::getConnection()</span><br><span class="line"><span class="function">  -&gt;</span>getDoctrineSchemaManager()</span><br><span class="line"><span class="function">  -&gt;</span>getDatabasePlatform()</span><br><span class="line"><span class="function">  -&gt;</span>registerDoctrineTypeMapping(<span class="string">'enum'</span>, <span class="string">'string'</span>);</span><br><span class="line"><span class="comment">### 添加的代码 end</span></span><br><span class="line"><span class="comment">### 重命名操作</span></span><br><span class="line">Schema::table(<span class="string">'users'</span>, <span class="keyword">function</span> (Blueprint $table) &#123;</span><br><span class="line">  $table-&gt;renameColumn(<span class="string">'password'</span>, <span class="string">'u_passwd'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>详细的讨论见：<u><a href="https://github.com/laravel/framework/issues/1186" target="_blank" rel="noopener">https://github.com/laravel/framework/issues/1186</a></u></p>
</blockquote>
<ul>
<li>明明存在类却提示找不到类？</li>
</ul>
<p>检查是否更改过类文件名，如果改过，则执行：<code>composer dump-autoload</code> 即可修复。</p>
<ul>
<li><strong>Class ‘Doctrine\DBAL\Driver\PDOMySql\Driver’ not found</strong></li>
</ul>
<p>在确认 composer.json 中 require 字段中含有 “doctrine/dbal”: “~2.3” 依赖后，重新执行下安装命令：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">composer</span> <span class="meta">require</span> doctrine/dba</span><br></pre></td></tr></table></figure>
<ul>
<li><p>session flash 无效？<br>只在本此请求中有效。</p>
</li>
<li><p><strong>Composer：Could not find package * at any version for your minimum-stability (stable).</strong></p>
<blockquote>
<p>Check the package spelling or your min imum-stability: <u><a href="https://github.com/composer/composer/issues/5118" target="_blank" rel="noopener">https://github.com/composer/composer/issues/5118</a></u></p>
</blockquote>
</li>
<li><p><strong>Composer：Composer install requires dev minimum-stability</strong></p>
<blockquote>
<p><u><a href="https://github.com/BGSU-LITS/learning-tools/issues/1" target="_blank" rel="noopener">https://github.com/BGSU-LITS/learning-tools/issues/1</a></u></p>
</blockquote>
</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://d.laravel-china.org/docs/5.1/" target="_blank" rel="noopener">Laravel 5.1 LTS 中文手册 &amp; Laravel 5.1 LTS Documentation</a></li>
<li><a href="大批量假数据填充的正确方法">大批量假数据填充的正确方法</a></li>
</ul>

        
      
    </div>

    <footer class="article-footer">
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>本文作者:  </strong>CAO XIAN LIANG</a>
          </li>
          <li class="post-copyright-link">
          <strong>本文链接:  </strong>
          <a href="/2018/01/16/Laravel-Dev-Notes/" target="_blank" title="Laravel 使用笔记">http://blog.caoxl.com/2018/01/16/Laravel-Dev-Notes/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明:   </strong>
            本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            许可协议。转载请注明出处
          </li>
         
        </ul>
<div>

      
      
      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Framework/">Framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Laravel/">Laravel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/">PHP</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/01/16/Laravel-Basic-knowledge/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          Laravel 基础知识
        
      </div>
    </a>
  
  
    <a href="/2018/01/15/Mac-Flow-Dev/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">Mac 流</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Laravel-Dev-Notes"><span class="nav-number">1.</span> <span class="nav-text">Laravel Dev Notes</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#路由"><span class="nav-number">2.</span> <span class="nav-text">路由</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#as-在路由定义中的作用？如何使用？如何向命名过的含参数的路由传递参数？"><span class="nav-number">2.1.</span> <span class="nav-text">as 在路由定义中的作用？如何使用？如何向命名过的含参数的路由传递参数？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由参数限制"><span class="nav-number">2.2.</span> <span class="nav-text">路由参数限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#url-和-route-的区别"><span class="nav-number">2.3.</span> <span class="nav-text">url() 和 route() 的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关于子域名路由"><span class="nav-number">2.4.</span> <span class="nav-text">关于子域名路由</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#中间件"><span class="nav-number">3.</span> <span class="nav-text">中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#POST-API-中禁用-CSRF-中间件"><span class="nav-number">3.1.</span> <span class="nav-text">POST API 中禁用 CSRF 中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义-Auth-中间件"><span class="nav-number">3.2.</span> <span class="nav-text">自定义 Auth 中间件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据库"><span class="nav-number">4.</span> <span class="nav-text">数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#查询构造器"><span class="nav-number">4.1.</span> <span class="nav-text">查询构造器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#distinct-select"><span class="nav-number">4.2.</span> <span class="nav-text">distinct select</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模型也能使用其方法"><span class="nav-number">4.3.</span> <span class="nav-text">模型也能使用其方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#往数据库插入测试数据"><span class="nav-number">4.4.</span> <span class="nav-text">往数据库插入测试数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Migration"><span class="nav-number">4.5.</span> <span class="nav-text">Migration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#create-TABLE-NAME-和-table-TABLE-NAME"><span class="nav-number">4.6.</span> <span class="nav-text">--create=TABLE_NAME 和 --table=TABLE_NAME</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关于-up-和-down"><span class="nav-number">4.7.</span> <span class="nav-text">关于 up() 和 down()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Eloquent"><span class="nav-number">4.8.</span> <span class="nav-text">Eloquent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#团队数据库开发的工作流简要说明"><span class="nav-number">4.9.</span> <span class="nav-text">团队数据库开发的工作流简要说明</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#认证"><span class="nav-number">5.</span> <span class="nav-text">认证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#启用-auth-认证的前提"><span class="nav-number">5.1.</span> <span class="nav-text">启用 auth 认证的前提</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Users-表必须字段"><span class="nav-number">5.2.</span> <span class="nav-text">Users 表必须字段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表单"><span class="nav-number">5.3.</span> <span class="nav-text">表单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">5.4.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调用认证中间件-Auth-的几个地方"><span class="nav-number">5.5.</span> <span class="nav-text">调用认证中间件 Auth 的几个地方</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义最大登录尝试次数、冻结登录时间和错误提示消息"><span class="nav-number">5.6.</span> <span class="nav-text">自定义最大登录尝试次数、冻结登录时间和错误提示消息</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#授权"><span class="nav-number">6.</span> <span class="nav-text">授权</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义权限"><span class="nav-number">6.1.</span> <span class="nav-text">定义权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定义拦截授权事件"><span class="nav-number">6.2.</span> <span class="nav-text">定义拦截授权事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查权限"><span class="nav-number">6.3.</span> <span class="nav-text">检查权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过-Gate-Facade"><span class="nav-number">6.4.</span> <span class="nav-text">通过 Gate Facade</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#检查已登录用户权限"><span class="nav-number">6.4.1.</span> <span class="nav-text">检查已登录用户权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查指定用户的权限"><span class="nav-number">6.4.2.</span> <span class="nav-text">检查指定用户的权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多参数情况"><span class="nav-number">6.4.3.</span> <span class="nav-text">多参数情况</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过-User-Model"><span class="nav-number">6.5.</span> <span class="nav-text">通过 User Model</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过-Blade-模版标签"><span class="nav-number">6.6.</span> <span class="nav-text">通过 Blade 模版标签</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过表单请求授权"><span class="nav-number">6.7.</span> <span class="nav-text">通过表单请求授权</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#视图"><span class="nav-number">7.</span> <span class="nav-text">视图</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Blade-标签的几种形态"><span class="nav-number">7.1.</span> <span class="nav-text">Blade 标签的几种形态</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#队列"><span class="nav-number">8.</span> <span class="nav-text">队列</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Laravel-使用队列步骤"><span class="nav-number">8.1.</span> <span class="nav-text">Laravel 使用队列步骤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#释放和删除"><span class="nav-number">8.2.</span> <span class="nav-text">释放和删除</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Laravel-队列线上环境实践"><span class="nav-number">8.3.</span> <span class="nav-text">Laravel 队列线上环境实践</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#其他"><span class="nav-number">9.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Composer"><span class="nav-number">9.1.</span> <span class="nav-text">Composer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装指定版本的-Laravel"><span class="nav-number">9.2.</span> <span class="nav-text">安装指定版本的 Laravel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#composer-create-project-和-laravel-new-安装方式的区别？"><span class="nav-number">9.3.</span> <span class="nav-text">composer create-project 和 laravel new 安装方式的区别？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dist-source-auto-的区别"><span class="nav-number">9.4.</span> <span class="nav-text">dist/source/auto 的区别</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FAQ"><span class="nav-number">10.</span> <span class="nav-text">FAQ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">11.</span> <span class="nav-text">参考</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2017 - 2022 Keep It Simple And Stupid All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



<script src="/js/scripts.js"></script>




  <script src="/js/dialog.js"></script>








	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Keep It Simple And Stupid
          </div>
          <div class="panel-body">
            Copyright © 2022 CAO XIAN LIANG All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>