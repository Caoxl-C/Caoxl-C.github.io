<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>mysql 坑 | Keep It Simple And Stupid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="MySQLDatabase" />
  
  
  
  
  <meta name="description" content="持续记录使用 MySQL 过程中遇到过的偏冷知识点和坑。 CLIenable mysql command on mac12345678# 1. install mysql workbenchbrew cask install mysqlworkbench# 2. export environment variablesexport PATH&#x3D;$PATH:&#x2F;Applications&#x2F;MySQLWor">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL 坑">
<meta property="og:url" content="http://blog.caoxl.com/2018/01/19/MySQL-Tricks/index.html">
<meta property="og:site_name" content="Keep It Simple And Stupid">
<meta property="og:description" content="持续记录使用 MySQL 过程中遇到过的偏冷知识点和坑。 CLIenable mysql command on mac12345678# 1. install mysql workbenchbrew cask install mysqlworkbench# 2. export environment variablesexport PATH&#x3D;$PATH:&#x2F;Applications&#x2F;MySQLWor">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-01-19T09:41:44.000Z">
<meta property="article:modified_time" content="2019-08-22T06:29:28.000Z">
<meta property="article:author" content="CAO XIAN LIANG">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="Database">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Keep It Simple And Stupid" type="application/atom+xml">
  

  

  <link rel="icon" href="https://images.unsplash.com/photo-1643801026603-63d4f50be313?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=767&q=80">
  <link rel="apple-touch-icon" href="/https://images.unsplash.com/photo-1643801026603-63d4f50be313?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=767&q=80">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>

  
<script src="/js/bootstrap.js"></script>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    
<link rel="stylesheet" href="/css/dialog.css">

  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  

<style type="text/css">
.spoiler {
  display: inline-flex;
}
p.spoiler {
  display: flex;
}
.spoiler a {
  pointer-events: none;
}
.spoiler-blur, .spoiler-blur > * {
  transition: text-shadow .5s ease;
}
.spoiler .spoiler-blur, .spoiler .spoiler-blur > * {
  color: rgba(0, 0, 0, 0);
  background-color: rgba(0, 0, 0, 0);
  text-shadow: 0 0 10px grey;
  cursor: pointer;
}
.spoiler .spoiler-blur:hover, .spoiler .spoiler-blur:hover > * {
  text-shadow: 0 0 5px grey;
}
.spoiler-box, .spoiler-box > * {
  transition: color .5s ease,
  background-color .5s ease;
}
.spoiler .spoiler-box, .spoiler .spoiler-box > * {
  color: black;
  background-color: black;
  text-shadow: none;
}</style><meta name="generator" content="Hexo 6.3.0"></head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="https://images.unsplash.com/photo-1643801026603-63d4f50be313?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=767&q=80">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">分类</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-MySQL-Tricks" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      MySQL 坑
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/01/19/MySQL-Tricks/" class="article-date">
	  <time datetime="2018-01-19T09:41:44.000Z" itemprop="datePublished">2018-01-19</time>
	</a>

      
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>

    <div class="article-entry" itemprop="articleBody">
      
        
        
          <p>持续记录使用 MySQL 过程中遇到过的偏冷知识点和坑。</p>
<h1 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h1><h2 id="enable-mysql-command-on-mac"><a href="#enable-mysql-command-on-mac" class="headerlink" title="enable mysql command on mac"></a>enable <code>mysql</code> command on mac</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. install mysql workbench</span></span><br><span class="line">brew cask install mysqlworkbench</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. export environment variables</span></span><br><span class="line">export PATH=<span class="variable">$PATH</span>:<span class="regexp">/Applications/</span>MySQLWorkbench.app<span class="regexp">/Contents/</span>MacOS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. use</span></span><br><span class="line">mysql -h &#123;host&#125; -u &#123;user&#125; -p &#123;password&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="mycli"><a href="#mycli" class="headerlink" title="mycli"></a>mycli</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install </span>mycli</span><br><span class="line"></span><br><span class="line"><span class="keyword">brew </span><span class="keyword">install </span>mycli</span><br></pre></td></tr></table></figure>

<p>有语法提示，简直不能太赞。使用和普通 mysql 命令一样。</p>
<h2 id="over-SSH-Tunnel"><a href="#over-SSH-Tunnel" class="headerlink" title="over SSH Tunnel"></a>over SSH Tunnel</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -f =&gt; background</span></span><br><span class="line"><span class="comment"># -L =&gt; bind port between local and remote</span></span><br><span class="line"><span class="comment"># -N =&gt; don&#x27;t execute command just forwarding ports</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">ssh</span> -f user@ssh.example.com -L <span class="number">3307</span>:mysql_server.example.com:<span class="number">3306</span> -N</span><br><span class="line"><span class="attribute">mysql</span> -h <span class="number">127.0.0.1</span> -P <span class="number">3307</span> -u&lt;mysql_user&gt; -p &lt;mysql_user_password&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kill SSH Tunnel progress</span></span><br><span class="line"><span class="comment"># Get pid</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">netstat</span> -vanp tcp | grep <span class="number">3307</span></span><br><span class="line"><span class="attribute">lsoif</span> -i:<span class="number">3307</span></span><br><span class="line"><span class="attribute">kill</span> -<span class="number">9</span> &#123;pid&#125;</span><br></pre></td></tr></table></figure>

<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><h2 id="NULL-vs-NOT-NULL"><a href="#NULL-vs-NOT-NULL" class="headerlink" title="NULL vs NOT NULL"></a>NULL vs NOT NULL</h2><p>除非真的要保存 NULL，否则尽量避免使用 NULL。</p>
<p>但把 NULL 列改为 NOT NULL 带来的性能提升很小，所以除非确定它引入了问题，否则就不要把它当作优先的优化措施。</p>
<h2 id="index-with-nullable-field"><a href="#index-with-nullable-field" class="headerlink" title="index with nullable field"></a>index with nullable field</h2><p>当 where 条件是 <code>column = cond</code> ，column 是 <code>is null</code>，MySQL 也能对其进行优化，即 MySQL 可以使用索引来查找 <code>nullable</code> 字段。</p>
<p>但是，当 where 条件种包含如下情况时，该优化不会生效：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> <span class="symbol">`name`</span> <span class="keyword">IS</span> <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>

<p>其中，<code>name</code> 字段的定义是 NOT NULL。该情况通常出现在联合查询时。</p>
<blockquote>
<p><u><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/is-null-optimization.html">https://dev.mysql.com/doc/refman/5.7/en/is-null-optimization.html</a></u></p>
</blockquote>
<h2 id="FROM-DUAL"><a href="#FROM-DUAL" class="headerlink" title="FROM DUAL"></a>FROM DUAL</h2><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DATABASE</span>() <span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>There is much discussion over whether or not FROM DUAL should be included in this or not. On a technical level, it is a holdover from Oracle and can safely be removed. If you are inclined, you can use the following instead: <code>SELECT DATABASE()</code>;</p>
<p>That said, it is perhaps important to note, that while FROM DUAL does not actually do anything, it is valid MySQL syntax. From a strict perspective, including braces in a single line conditional in JavaScript also does not do anything, but it is still a valid practice</p>
</blockquote>
<h2 id="having-vs-where"><a href="#having-vs-where" class="headerlink" title="having vs where"></a><code>having</code> vs <code>where</code></h2><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> table <span class="symbol">`user`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`name`</span> varchar(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="symbol">`gender`</span> tinyint <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="symbol">`age`</span> tinyint <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><code>having</code> 使用的是从已经筛选出来过的字段（包括别名），而 <code>where</code> 使用的是表中定义好的字段。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="type">name</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> age &gt; <span class="number">18</span>;    <span class="comment">-- 不会报错</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="type">name</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">having</span> age &gt; <span class="number">18</span>;   <span class="comment">-- 会报错 `Unknown column &#x27;age&#x27; in &#x27;having clause&#x27;`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">having</span> age &gt; <span class="number">18</span>;    <span class="comment">-- 不会报错, `*` 已包含了 `age`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不会报错</span></span><br><span class="line"><span class="keyword">select</span> <span class="type">name</span>, avg(age) <span class="keyword">as</span> avg_age <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">group</span> <span class="keyword">by</span> gender <span class="keyword">having</span> avg_age &gt; <span class="number">18</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 报错，表 user 不存在 `avg_age` 字段</span></span><br><span class="line"><span class="keyword">select</span> <span class="type">name</span>, avg(age) <span class="keyword">as</span> avg_age <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> avg_age &gt; <span class="number">18</span> <span class="keyword">group</span> <span class="keyword">by</span> gender;</span><br></pre></td></tr></table></figure>

<p><code>where</code> 性能高于 <code>having</code>，能写在 <code>where</code> 限定条件中的就尽量写在 <code>where</code> 中。</p>
<h2 id="group-by-的方便和坑"><a href="#group-by-的方便和坑" class="headerlink" title="group by 的方便和坑"></a><code>group by</code> 的方便和坑</h2><ul>
<li>方便：统计不同性别的用户个数（同一列中不同值的个数）：</li>
</ul>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. count</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	count(gender = <span class="number">1</span> <span class="keyword">OR</span> <span class="keyword">NULL</span>) <span class="keyword">as</span> boy,</span><br><span class="line">	count(gender = <span class="number">2</span> <span class="keyword">OR</span> <span class="keyword">NULL</span>) <span class="keyword">as</span> girl,</span><br><span class="line">	count(gender = <span class="number">3</span> <span class="keyword">OR</span> <span class="keyword">NULL</span>) <span class="keyword">as</span> gay,</span><br><span class="line"><span class="keyword">from</span> <span class="keyword">user</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. sum</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	sum(<span class="keyword">if</span>(gender = <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">as</span> boy,</span><br><span class="line">	sum(<span class="keyword">if</span>(gender = <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">as</span> girl,</span><br><span class="line">	sum(<span class="keyword">if</span>(gender = <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">as</span> gay</span><br><span class="line"><span class="keyword">from</span> <span class="keyword">user</span>;</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	sum(gender = <span class="number">1</span>) <span class="keyword">as</span> boy,</span><br><span class="line">	sum(gender = <span class="number">2</span>) <span class="keyword">as</span> girl,</span><br><span class="line">	sum(gender = <span class="number">3</span>) <span class="keyword">as</span> gay</span><br><span class="line"><span class="keyword">from</span> <span class="keyword">user</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. group by</span></span><br><span class="line"><span class="keyword">select</span> gender, count(*) <span class="keyword">as</span> cnt <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">group</span> <span class="keyword">by</span> gender;</span><br></pre></td></tr></table></figure>

<ul>
<li>坑：性能</li>
</ul>
<p>如果没有用到索引数据量一般大也会巨慢，甚至出现 MySQL CPU 爆高，超时等。</p>
<p><code>group by</code>与 <code>order by</code> 的索引优化基本一样，<code>group by</code> <strong>实质是先排序后分组</strong>，也就是分组之前必排序，遵照索引的最佳左前缀原则可以大大提高 group by 的效率。</p>
<h1 id="隐式特性（坑）"><a href="#隐式特性（坑）" class="headerlink" title="隐式特性（坑）"></a>隐式特性（坑）</h1><h2 id="Implict-Commit"><a href="#Implict-Commit" class="headerlink" title="Implict Commit"></a>Implict Commit</h2><h3 id="部分事务隐式强制性提交"><a href="#部分事务隐式强制性提交" class="headerlink" title="部分事务隐式强制性提交"></a>部分事务隐式强制性提交</h3><blockquote>
<p><a target="_blank" rel="noopener" href="http://www.php.net/manual/en/pdo.begintransaction.php">Some databases, including MySQL, automatically issue an implicit COMMIT when a database definition language (DDL) statement such as DROP TABLE or CREATE TABLE is issued within a transaction. The implicit COMMIT will prevent you from rolling back any other changes within the transaction boundary.</a></p>
<p>CREATE TABLE操作背后涉及到了大量的操作，不仅仅包括对核心表的操作，还包括大量内存数据结构的更新（如Schema），以及存储系统的变更（如创建相应的数据块），工程上很难把这些操作做成原子的。</p>
<p>那么，应该如何做呢？比较折中的方式就是跟用户做一个约定：CREATE TABLE操作总默认COMMIT它之前的事务，这就是implict commit。</p>
</blockquote>
<p>详情可参考 <u><a target="_blank" rel="noopener" href="http://blog.csdn.net/maray/article/details/46410817">这篇博客</a></u>。</p>
<h1 id="binlog"><a href="#binlog" class="headerlink" title="binlog"></a>binlog</h1><h2 id="查看-binlog"><a href="#查看-binlog" class="headerlink" title="查看 binlog"></a>查看 binlog</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -vv <span class="attribute">--base64-output</span>=decode-rows /path/<span class="keyword">to</span>/mysql-bin-log</span><br></pre></td></tr></table></figure>

<h2 id="恢复成SQL"><a href="#恢复成SQL" class="headerlink" title="恢复成SQL"></a>恢复成SQL</h2><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 恢复本地 binlog</span></span><br><span class="line">mysqlbinlog <span class="string">\</span></span><br><span class="line">--<span class="literal">no</span>-defaults <span class="string">\</span></span><br><span class="line">--base64-output=AUTO <span class="string">\</span></span><br><span class="line">--verbose <span class="string">\</span></span><br><span class="line">--set-charset=utf8 <span class="string">\</span></span><br><span class="line">--start-datetime=<span class="string">&#x27;2017-07-16 00:00:00&#x27;</span> <span class="string">\</span></span><br><span class="line">--stop-datetime=<span class="string">&#x27;2017-07-17 00:00:00&#x27;</span> <span class="string">\</span></span><br><span class="line">./mysql-bin.<span class="number">000611</span> &gt; /data/restore.sql</span><br><span class="line"><span class="comment"># 恢复远程服务器 binlog</span></span><br><span class="line">mysqlbinlog <span class="string">\</span></span><br><span class="line">--<span class="literal">no</span>-defaults <span class="string">\</span></span><br><span class="line">-uwaimai_o2o -p <span class="string">\</span></span><br><span class="line">-hrm-wz93132ahz16ttyhq.mysql.rds.aliyuncs.com <span class="string">\</span></span><br><span class="line">--read-<span class="keyword">from</span>-remote-server <span class="string">\</span></span><br><span class="line">mysql-bin.<span class="number">000618</span> &gt; restore.sql</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/mysqlbinlog.html">https://dev.mysql.com/doc/refman/5.7/en/mysqlbinlog.html</a></p>
</blockquote>
<h2 id="使用不小于-MySQL-server-的版本"><a href="#使用不小于-MySQL-server-的版本" class="headerlink" title="使用不小于 MySQL server 的版本"></a>使用不小于 MySQL server 的版本</h2><p>如果 mysqlbinlog 版本太低，则会出现类似报错如下：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ERROR: </span>Error in Log_event::read_log_event(): &#x27;Sanity check failed&#x27;, data_len: 151, event_type: 35</span><br><span class="line"><span class="keyword">ERROR: </span>Could not read entry at offset 120: Error in log format or read error.</span><br></pre></td></tr></table></figure>

<h1 id="版本有关问题"><a href="#版本有关问题" class="headerlink" title="版本有关问题"></a>版本有关问题</h1><ul>
<li><strong>Specified key was too long; max key length is 767 bytes</strong></li>
</ul>
<blockquote>
<p>767 bytes is the stated prefix limitation for InnoDB tables in MySQL version 5.6 (and prior versions). It’s 1,000 bytes long for MyISAM tables. In MySQL version 5.7 and upwards this limit has been increased to 3072 bytes.</p>
<p><u><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1814532/1071-specified-key-was-too-long-max-key-length-is-767-bytes">https://stackoverflow.com/questions/1814532/1071-specified-key-was-too-long-max-key-length-is-767-bytes</a></u></p>
</blockquote>
<h2 id="备份-x2F-恢复"><a href="#备份-x2F-恢复" class="headerlink" title="备份&#x2F;恢复"></a>备份&#x2F;恢复</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mysqldump</span> -hrm-wz93132ahz16ttyhq.mysql.rds.aliyuncs.com -uwaimai_o2o -p waimai_020 | gzip &gt; wz93132ahz16ttyhq-<span class="number">2017</span>-<span class="number">11</span>-<span class="number">23</span>.sql.gz</span><br></pre></td></tr></table></figure>

<h1 id="主机连接"><a href="#主机连接" class="headerlink" title="主机连接"></a>主机连接</h1><h2 id="127-0-0-1-vs-localhost"><a href="#127-0-0-1-vs-localhost" class="headerlink" title="127.0.0.1 vs localhost"></a>127.0.0.1 vs localhost</h2><p>使用 mysql cli 客户端连接 docker 容器中的 mysql，使用 <code>127.0.0.1</code> 可以连接上，但是使用 <code>localhost</code> 却不能连：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -h 127.0.0.1 -uroot -p*****    # Success</span><br><span class="line">mysql -h localhost -uroot -p*****    # Failed</span><br><span class="line"><span class="keyword">ERROR </span>2002 (HY000): Can&#x27;t connect to local MySQL server through socket &#x27;/tmp/mysql.sock&#x27; (2)</span><br></pre></td></tr></table></figure>

<p>其实这个问题不属于 MySQL 范围内的问题，所有服务器程序（ssh, telnet…）都会遇到这些问题。</p>
<p>根本原因是由服务端程序实际上监听的地址是一个 IPv4 还是一个 hostname。</p>
<p>比如这里的 MySQL，如果 MySQL server 只是监听了 127.0.0.1 这个 IPv4 地址，那么客户端就只能使用 127.0.0.1 这个 IP 连接。</p>
<p>此外，从错误信息中还可以总结一点，unix-like 操作系统默认会把 localhost 当作 UNIX domain socket，而 windows 默认就认为是 TCP&#x2F;IP，这样的结果是：</p>
<ul>
<li>在 unix-like OS 上，如果指定地址为 localhost 那么 OS 会默认常识使用 Unix domain socket；如果指定地址为 <code>127.0.0.1</code>，那么 OS 才会使用 TCP&#x2F;IP。</li>
<li>在 windows 上，无论指定 <code>localhost</code> 还是 <code>127.0.0.1</code>，OS 都会使用 TCP&#x2F;IP。</li>
</ul>
<blockquote>
<p>UNIX socket is an inter-process communication mechanism that allows bidirectional data exchange between processes running on the same machine.</p>
<p> IP sockets (especially TCP&#x2F;IP sockets) are a mechanism allowing communication between processes over the network. In some cases, you can use TCP&#x2F;IP sockets to talk with processes running on the same computer (by using the loopback interface).</p>
</blockquote>
<blockquote>
<p>UNIX domain sockets know that they’re executing on the same system, so they can avoid some checks and operations (like routing); which makes them faster and lighter than IP sockets. So if you plan to communicate with processes on the same host, this is a better option than IP sockets.</p>
<p><u><a target="_blank" rel="noopener" href="https://serverfault.com/questions/124517/whats-the-difference-between-unix-socket-and-tcp-ip-socket">https://serverfault.com/questions/124517/whats-the-difference-between-unix-socket-and-tcp-ip-socket</a></u></p>
</blockquote>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/problems-with-null.html">MySQL :: MySQL 5.7 Reference Manual :: B.5.4.3 Problems with NULL Values</a></li>
<li><a target="_blank" rel="noopener" href="https://dba.stackexchange.com/questions/15335/are-many-null-columns-harmful-in-mysql-innodb">Are many NULL columns harmful in mysql InnoDB?</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/30367982/how-to-know-the-date-of-insertion-of-record-in-sql">how to know the date of insertion of record in SQL</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/16753122/sql-how-to-replace-values-of-select-return">SQL How to replace values of select return?</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/18373366/mysql-connection-over-ssh-tunnel-how-to-specify-other-mysql-server">MySQL connection over SSH tunnel - how to specify other MySQL server?</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2426335/pdo-transactions-dont-roll-back">PDO: Transactions don’t roll back?</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2950676/difference-between-set-autocommit-1-and-start-transaction-in-mysql-have-i-misse">Difference between SET autocommit&#x3D;1 and START TRANSACTION in mysqls</a></li>
</ul>

        
      
    </div>

    <footer class="article-footer">
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>本文作者:  </strong>CAO XIAN LIANG</a>
          </li>
          <li class="post-copyright-link">
          <strong>本文链接:  </strong>
          <a href="/2018/01/19/MySQL-Tricks/" target="_blank" title="MySQL 坑">http://blog.caoxl.com/2018/01/19/MySQL-Tricks/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明:   </strong>
            本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            许可协议。转载请注明出处
          </li>
         
        </ul>
<div>

      
      
      
      
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Database/" rel="tag">Database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/01/19/Dig-Into-PHP/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          PHP  研究多一点
        
      </div>
    </a>
  
  
    <a href="/2018/01/19/Database-Design-Notes/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">Database 数据库设计概念</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CLI"><span class="nav-number">1.</span> <span class="nav-text">CLI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#enable-mysql-command-on-mac"><span class="nav-number">1.1.</span> <span class="nav-text">enable mysql command on mac</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mycli"><span class="nav-number">1.2.</span> <span class="nav-text">mycli</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#over-SSH-Tunnel"><span class="nav-number">1.3.</span> <span class="nav-text">over SSH Tunnel</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95"><span class="nav-number">2.</span> <span class="nav-text">语法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NULL-vs-NOT-NULL"><span class="nav-number">2.1.</span> <span class="nav-text">NULL vs NOT NULL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#index-with-nullable-field"><span class="nav-number">2.2.</span> <span class="nav-text">index with nullable field</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FROM-DUAL"><span class="nav-number">2.3.</span> <span class="nav-text">FROM DUAL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#having-vs-where"><span class="nav-number">2.4.</span> <span class="nav-text">having vs where</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#group-by-%E7%9A%84%E6%96%B9%E4%BE%BF%E5%92%8C%E5%9D%91"><span class="nav-number">2.5.</span> <span class="nav-text">group by 的方便和坑</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9A%90%E5%BC%8F%E7%89%B9%E6%80%A7%EF%BC%88%E5%9D%91%EF%BC%89"><span class="nav-number">3.</span> <span class="nav-text">隐式特性（坑）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Implict-Commit"><span class="nav-number">3.1.</span> <span class="nav-text">Implict Commit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E5%88%86%E4%BA%8B%E5%8A%A1%E9%9A%90%E5%BC%8F%E5%BC%BA%E5%88%B6%E6%80%A7%E6%8F%90%E4%BA%A4"><span class="nav-number">3.1.1.</span> <span class="nav-text">部分事务隐式强制性提交</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#binlog"><span class="nav-number">4.</span> <span class="nav-text">binlog</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-binlog"><span class="nav-number">4.1.</span> <span class="nav-text">查看 binlog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%81%A2%E5%A4%8D%E6%88%90SQL"><span class="nav-number">4.2.</span> <span class="nav-text">恢复成SQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%B0%8F%E4%BA%8E-MySQL-server-%E7%9A%84%E7%89%88%E6%9C%AC"><span class="nav-number">4.3.</span> <span class="nav-text">使用不小于 MySQL server 的版本</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E6%9C%89%E5%85%B3%E9%97%AE%E9%A2%98"><span class="nav-number">5.</span> <span class="nav-text">版本有关问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%87%E4%BB%BD-x2F-%E6%81%A2%E5%A4%8D"><span class="nav-number">5.1.</span> <span class="nav-text">备份&#x2F;恢复</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E8%BF%9E%E6%8E%A5"><span class="nav-number">6.</span> <span class="nav-text">主机连接</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#127-0-0-1-vs-localhost"><span class="nav-number">6.1.</span> <span class="nav-text">127.0.0.1 vs localhost</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">7.</span> <span class="nav-text">参考</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2017 - 2023 Keep It Simple And Stupid All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>




<script src="/js/scripts.js"></script>





  
<script src="/js/dialog.js"></script>









	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Keep It Simple And Stupid
          </div>
          <div class="panel-body">
            Copyright © 2023 CAO XIAN LIANG All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>