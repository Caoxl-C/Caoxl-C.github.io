<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>远古框架 thinkphp3.2 | Keep It Simple And Stupid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="ThinkPHP3.2TP3.2">
  
  
  
  
  <meta name="description" content="因为工作需要，要重新捡起远古框架ThinKPHP3.2">
<meta name="keywords" content="ThinkPHP3.2,TP3.2">
<meta property="og:type" content="article">
<meta property="og:title" content="远古框架 ThinkPHP3.2">
<meta property="og:url" content="http://blog.caoxl.com/2018/10/16/Ancient-Frame-TP3-2-Notes/index.html">
<meta property="og:site_name" content="Keep It Simple And Stupid">
<meta property="og:description" content="因为工作需要，要重新捡起远古框架ThinKPHP3.2">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-08-22T06:42:12.918Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="远古框架 ThinkPHP3.2">
<meta name="twitter:description" content="因为工作需要，要重新捡起远古框架ThinKPHP3.2">
  
    <link rel="alternate" href="/atom.xml" title="Keep It Simple And Stupid" type="application/atom+xml">
  

  

  <link rel="icon" href="http://caoxl.com/imgs/we-min.jpg">
  <link rel="apple-touch-icon" href="/http://caoxl.com/imgs/we-min.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">

  
    <link rel="stylesheet" href="/css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css">
  

  
  
  

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="http://caoxl.com/imgs/we-min.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">分类</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-Ancient-Frame-TP3-2-Notes" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      远古框架 ThinkPHP3.2
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/10/16/Ancient-Frame-TP3-2-Notes/" class="article-date">
	  <time datetime="2018-10-16T02:46:09.000Z" itemprop="datePublished">2018-10-16</time>
	</a>

      
    <a class="article-category-link" href="/categories/框架相关/">框架相关</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>

    <div class="article-entry" itemprop="articleBody">
      
        
        
          <blockquote>
<p>因为工作需要，要重新捡起远古框架ThinKPHP3.2</p>
</blockquote>
<a id="more"></a>
<blockquote>
<p><a href="https://www.kancloud.cn/manual/thinkphp/1679" target="_blank" rel="noopener">https://www.kancloud.cn/manual/thinkphp/1679</a></p>
</blockquote>
<h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><h2 id="安装ThinkPHP3-2"><a href="#安装ThinkPHP3-2" class="headerlink" title="安装ThinkPHP3.2"></a>安装ThinkPHP3.2</h2><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">composer </span><span class="built_in">create-project</span> <span class="string">topthink/</span><span class="string">thinkphp </span><span class="string">ThinkPHP32</span></span><br></pre></td></tr></table></figure>
<h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h2><ul>
<li>PHP5.3+</li>
</ul>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">www  WEB部署目录（或者子目录）</span><br><span class="line">├─index.php       入口文件</span><br><span class="line">├─README.md       README文件</span><br><span class="line">├─Application     应用目录</span><br><span class="line">├─<span class="keyword">Public</span>          资源文件目录</span><br><span class="line">└─ThinkPHP        框架目录</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">├─ThinkPHP 框架系统目录（可以部署在非web目录下面）</span><br><span class="line">│  ├─Common       核心公共函数目录</span><br><span class="line">│  ├─Conf         核心配置目录 </span><br><span class="line">│  ├─Lang         核心语言包目录</span><br><span class="line">│  ├─Library      框架类库目录</span><br><span class="line">│  │  ├─Think     核心Think类库包目录</span><br><span class="line">│  │  ├─Behavior  行为类库目录</span><br><span class="line">│  │  ├─Org       Org类库包目录</span><br><span class="line">│  │  ├─Vendor    第三方类库目录</span><br><span class="line">│  │  ├─ ...      更多类库目录</span><br><span class="line">│  ├─Mode         框架应用模式目录</span><br><span class="line">│  ├─Tpl          系统模板目录</span><br><span class="line">│  ├─LICENSE.txt  框架授权协议文件</span><br><span class="line">│  ├─logo.png     框架LOGO文件</span><br><span class="line">│  ├─README.txt   框架README文件</span><br><span class="line">│  └─ThinkPHP.php 框架入口文件</span><br></pre></td></tr></table></figure>
<h2 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h2><p>我们可以在自动生成的<code>Application/Home/Controller</code>目录下面找到一个 <code>IndexController.class.php</code> 文件，这就是默认的<code>Index</code>控制器文件。</p>
<ul>
<li>控制器类的命名方式是：<strong>控制器名（驼峰法，首字母大写）+Controller</strong></li>
<li>控制器文件的命名方式是：<strong>类名+class.php（类文件后缀）</strong></li>
</ul>
<h2 id="开发规范"><a href="#开发规范" class="headerlink" title="开发规范"></a>开发规范</h2><p>使用ThinkPHP开发的过程中应该尽量遵循下列命名规范：</p>
<ul>
<li>类文件都是以.class.php为后缀（这里是指的ThinkPHP内部使用的类库文件，不代表外部加载的类库文件），使用驼峰法命名，并且首字母大写，例如 <code>DbMysql.class.php</code>；</li>
<li>类的命名空间地址和所在的路径地址一致，例如 <code>Home\Controller\UserController</code>类所在的路径应该是 <code>Application/Home/Controller/UserController.class.php</code>；</li>
<li>函数、配置文件等其他类库文件之外的一般是以<code>.php</code>为后缀（第三方引入的不做要求）；</li>
<li>函数的命名使用小写字母和下划线的方式，例如 <code>get_client_ip</code>；</li>
<li>方法的命名使用驼峰法，并且首字母小写或者使用下划线<code>“_”</code>，例如 <code>getUserName</code>，<code>_parseType</code>，通常下划线开头的方法属于私有方法；</li>
<li>属性的命名使用驼峰法，并且首字母小写或者使用下划线<code>“_”</code>，例如 <code>tableName</code>、<code>_instance</code>，通常下划线开头的属性属于私有属性；</li>
<li>以双下划线<code>“__”</code>打头的函数或方法作为魔法方法，例如 <code>__call</code> 和 <code>__autoload</code>；</li>
<li>常量以大写字母和下划线命名，例如 <code>HAS_ONE</code> 和 <code>MANY_TO_MANY</code>；</li>
<li>配置参数以大写字母和下划线命名，例如 <code>HTML_CACHE_ON</code>；</li>
<li>语言变量以大写字母和下划线命名，例如<code>MY_LANG</code>，以下划线打头的语言变量通常用于系统语言变量，例如 <code>_CLASS_NOT_EXIST_</code>；</li>
</ul>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>在ThinkPHP中，一般来说应用的配置文件是自动加载的，加载的顺序是：</p>
<p><code>惯例配置</code>-&gt;<code>应用配置</code>-&gt;<code>模式配置</code>-&gt;<code>调试配置</code>-&gt;<code>状态配置</code>-&gt;<code>模块配置</code>-&gt;<code>扩展配置</code>-&gt;<code>动态配置</code></p>
<ul>
<li>惯例配置</li>
</ul>
<p>惯例重于配置是系统遵循的一个重要思想，框架内置有一个惯例配置文件（位于<code>ThinkPHP/Conf/convention.php</code>），按照大多数的使用对常用参数进行了默认配置</p>
<ul>
<li>应用配置</li>
</ul>
<p>应用配置文件也就是调用所有模块之前都会首先加载的公共配置文件（默认位于<code>Application/Common/Conf/config.php</code>）。</p>
<ul>
<li>模式配置（可选）</li>
</ul>
<p>如果使用了普通应用模式之外的应用模式的话，还可以为应用模式（后面会有描述）单独定义配置文件，文件命名规范是： <code>Application/Common/Conf/config_应用模式名称.php</code>（仅在运行该模式下面才会加载）。</p>
<ul>
<li>调试配置（可选）</li>
</ul>
<p>如果开启调试模式的话，则会自动加载框架的调试配置文件（位于<code>ThinkPHP/Conf/debug.php</code>）和应用调试配置文件（位于<code>Application/Common/Conf/debug.php</code>）</p>
<ul>
<li>状态配置（可选）</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在公司环境中</span></span><br><span class="line">define(<span class="string">'APP_STATUS'</span>,<span class="string">'office'</span>);</span><br><span class="line"><span class="comment">// 那么就会自动加载该状态对应的配置文件（位于Application/Common/Conf/office.php）。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 回家后</span></span><br><span class="line">define(<span class="string">'APP_STATUS'</span>,<span class="string">'home'</span>);</span><br><span class="line"><span class="comment">// 那么就会自动加载该状态对应的配置文件（位于Application/Common/Conf/home.php）。</span></span><br></pre></td></tr></table></figure>
<h2 id="读取配置"><a href="#读取配置" class="headerlink" title="读取配置"></a>读取配置</h2><p>无论何种配置文件，定义了配置文件之后，都统一使用系统提供的<code>C</code>方法（可以借助<code>Config</code>单词来帮助记忆）来读取已有的配置。</p>
<ul>
<li>C(‘参数名称’)</li>
</ul>
<p>例如，读取当前的URL模式配置参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$model = C(<span class="string">'URL_MODEL'</span>);</span><br><span class="line"><span class="comment">// 由于配置参数不区分大小写，因此下面的写法是等效的</span></span><br><span class="line"><span class="comment">// $model = C('url_model');</span></span><br></pre></td></tr></table></figure>
<h2 id="动态配置"><a href="#动态配置" class="headerlink" title="动态配置"></a>动态配置</h2><ul>
<li>C(‘参数名称’,’新的参数值’)</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态改变缓存有效期</span></span><br><span class="line">C(<span class="string">'DATA_CACHE_TIME'</span>,<span class="number">60</span>);</span><br></pre></td></tr></table></figure>
<p>也可以支持二维数组的读取和设置，使用点语法进行操作，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取已经设置的参数值</span></span><br><span class="line">C(<span class="string">'USER_CONFIG.USER_TYPE'</span>);</span><br><span class="line"><span class="comment">// 设置新的值</span></span><br><span class="line">C(<span class="string">'USER_CONFIG.USER_TYPE'</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><h2 id="多层MVC"><a href="#多层MVC" class="headerlink" title="多层MVC"></a>多层MVC</h2><p>ThinkPHP基于MVC（<code>Model-View-Controller</code>，模型-视图-控制器）模式，并且均支持多层（multi-Layer）设计。</p>
<h3 id="模型（Model）层"><a href="#模型（Model）层" class="headerlink" title="模型（Model）层"></a>模型（Model）层</h3><p>例如在某个项目设计中需要区分数据层、逻辑层、服务层等不同的模型层，我们可以在模块目录下面创建Model、Logic和Service目录，把对用户表的所有模型操作分成三层：</p>
<ol>
<li>数据层：<code>Model/UserModel</code> 用于定义数据相关的自动验证和自动完成和数据存取接口</li>
<li>逻辑层：<code>Logic/UserLogic</code> 用于定义用户相关的业务逻辑</li>
<li>服务层：<code>Service/UserService</code> 用于定义用户相关的服务接口等</li>
</ol>
<h3 id="视图（View）层"><a href="#视图（View）层" class="headerlink" title="视图（View）层"></a>视图（View）层</h3><p>视图层由模板和模板引擎组成，在模板中可以直接使用PHP代码，模板引擎的设计会在后面讲述，通过驱动也可以支持其他第三方的模板引擎</p>
<h3 id="控制器（Controller）层"><a href="#控制器（Controller）层" class="headerlink" title="控制器（Controller）层"></a>控制器（Controller）层</h3><p>ThinkPHP的控制器层由<strong>核心控制器</strong>和<strong>业务控制器</strong>组成，核心控制器由系统内部的App类完成，负责应用（包括模块、控制器和操作）的调度控制，包括HTTP请求拦截和转发、加载配置等</p>
<h2 id="CBD模式"><a href="#CBD模式" class="headerlink" title="CBD模式"></a>CBD模式</h2><p>ThinkPHP引入了全新的<strong>CBD（核心Core+行为Behavior+驱动Driver）</strong>架构模式。</p>
<h3 id="Core（核心）"><a href="#Core（核心）" class="headerlink" title="Core（核心）"></a>Core（核心）</h3><p>ThinkPHP的核心部分包括核心函数库、惯例配置、核心类库（包括基础类和内置驱动及核心行为），这些是ThinkPHP必不可少的部分。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ThinkPHP/Common/functions.php <span class="comment">// 核心函数库</span></span><br><span class="line">ThinkPHP/Conf/convention.php  <span class="comment">// 惯例配置文件</span></span><br><span class="line">ThinkPHP/Conf/debug.php  <span class="comment">// 惯例调试配置文件</span></span><br><span class="line">ThinkPHP/Mode/common.php  <span class="comment">// 普通模式定义文件</span></span><br><span class="line">ThinkPHP/Library/Think <span class="comment">// 核心类库包</span></span><br><span class="line">ThinkPHP/Library/Behavior <span class="comment">// 系统行为类库</span></span><br><span class="line">ThinkPHP/Library/Think/App<span class="class">.<span class="keyword">class</span>.<span class="title">php</span> // 核心应用类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">Cache</span>.<span class="title">class</span>.<span class="title">php</span> // 核心缓存类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">Controller</span>.<span class="title">class</span>.<span class="title">php</span> // 基础控制器类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">Db</span>.<span class="title">class</span>.<span class="title">php</span> // 数据库操作类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">Dispatcher</span>.<span class="title">class</span>.<span class="title">php</span> // <span class="title">URL</span>解析调度类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">Exception</span>.<span class="title">class</span>.<span class="title">php</span> // 系统基础异常类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">Hook</span>.<span class="title">class</span>.<span class="title">php</span> // 系统钩子类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">Log</span>.<span class="title">class</span>.<span class="title">php</span> // 系统日志记录类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">Model</span>.<span class="title">class</span>.<span class="title">php</span> // 系统基础模型类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">Route</span>.<span class="title">class</span>.<span class="title">php</span> // 系统路由类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">Storage</span>.<span class="title">class</span>.<span class="title">php</span> // 系统存储类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">Template</span>.<span class="title">class</span>.<span class="title">php</span> // 内置模板引擎类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">Think</span>.<span class="title">class</span>.<span class="title">php</span> // 系统引导类</span></span><br><span class="line"><span class="class"><span class="title">ThinkPHP</span>/<span class="title">Library</span>/<span class="title">Think</span>/<span class="title">View</span>.<span class="title">class</span>.<span class="title">php</span> // 系统视图类</span></span><br></pre></td></tr></table></figure>
<h3 id="Behavior-行为"><a href="#Behavior-行为" class="headerlink" title="Behavior (行为)"></a>Behavior (行为)</h3><p>Behavior目录下面是系统内置的一些行为类库，内置驱动则分布在各个不同的驱动目录下面（参考下面的驱动部分）。</p>
<p>行为（Behavior）是ThinkPHP扩展机制中比较关键的一项扩展，行为既可以独立调用，也可以绑定到某个标签（位）中进行侦听。</p>
<p>行为类的定义方式如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Behavior</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestBehavior</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">     <span class="comment">// 行为扩展的执行入口必须是run</span></span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">(&amp;$params)</span></span></span><br><span class="line"><span class="function">     </span>&#123;</span><br><span class="line">         <span class="keyword">if</span>(C(<span class="string">'TEST_PARAM'</span>)) &#123;</span><br><span class="line">             <span class="keyword">echo</span> <span class="string">'RUNTEST BEHAVIOR '</span>.$params;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Driver（驱动）"><a href="#Driver（驱动）" class="headerlink" title="Driver（驱动）"></a>Driver（驱动）</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ThinkPHP/Library/Think/Cache/Driver <span class="comment">// 缓存驱动类库</span></span><br><span class="line">ThinkPHP/Library/Think/Db/Driver <span class="comment">// 数据库驱动类库</span></span><br><span class="line">ThinkPHP/Library/Think/Log/Driver <span class="comment">// 日志记录驱动类库</span></span><br><span class="line">ThinkPHP/Library/Think/Session/Driver <span class="comment">// Session驱动类库</span></span><br><span class="line">ThinkPHP/Library/Think/Storage/Driver <span class="comment">// 存储驱动类库</span></span><br><span class="line">ThinkPHP/Library/Think/Template/Driver <span class="comment">// 第三方模板引擎驱动类库</span></span><br><span class="line">ThinkPHP/Library/Think/Template/TagLib <span class="comment">// 内置模板引擎标签库扩展类库</span></span><br></pre></td></tr></table></figure>
<h2 id="自动加载"><a href="#自动加载" class="headerlink" title="自动加载"></a>自动加载</h2><h3 id="自动加载的优先级"><a href="#自动加载的优先级" class="headerlink" title="自动加载的优先级"></a>自动加载的优先级</h3><p>在实际的应用类库加载过程中，往往会涉及到自动加载的优先级问题，以<code>Test\MyClass</code>类为例，自动加载的优先顺序如下：</p>
<ol>
<li>判断是否有注册了<code>Test\MyClass</code>类库映射，如果有则自动加载类库映射定义的文件；</li>
<li>判断是否存在<code>Library/Test</code>目录，有则以该目录为初始目录加载；</li>
<li>判断是否有注册<code>Test</code>根命名空间，有则以注册的目录为初始目录加载；</li>
<li>如果以上都不成立，则以<code>Test</code>为模块目录进行初始目录加载；</li>
</ol>
<h3 id="手动加载第三方类库"><a href="#手动加载第三方类库" class="headerlink" title="手动加载第三方类库"></a>手动加载第三方类库</h3><p>如果要加载第三方类库，包括<strong>不符合命名规范和后缀的类库，以及没有使用命名空间或者命名空间和路径不一致的类库</strong>，或者你就是想手动加载类库文件，我们都可以通过手动导入的方式加载。</p>
<p>我们可以使用<code>import</code>方法导入任何类库，用法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入Org类库包 Library/Org/Util/Date.class.php类库</span></span><br><span class="line">import(<span class="string">"Org.Util.Date"</span>);</span><br><span class="line"><span class="comment">// 导入Home模块下面的 Application/Home/Util/UserUtil.class.php类库</span></span><br><span class="line">import(<span class="string">"Home.Util.UserUtil"</span>);</span><br><span class="line"><span class="comment">// 导入当前模块下面的类库 </span></span><br><span class="line">import(<span class="string">"@.Util.Array"</span>);</span><br><span class="line"><span class="comment">// 导入Vendor类库包 Library/Vendor/Zend/Server.class.php</span></span><br><span class="line">import(<span class="string">'Vendor.Zend.Server'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="系统流程"><a href="#系统流程" class="headerlink" title="系统流程"></a>系统流程</h2><p>ThinkPHP框架开发的应用的标准执行流程如下：</p>
<ol>
<li>用户URL请求</li>
<li>调用应用入口文件（通常是网站的<code>index.php</code>）</li>
<li>载入框架入口文件（<code>ThinkPHP.php</code>）</li>
<li>记录初始运行时间和内存开销</li>
<li>系统常量判断及定义</li>
<li>载入框架引导类（<code>Think\Think</code>）并执行<code>Think::start</code>方法进行应用初始化</li>
<li>设置错误处理机制和自动加载机制</li>
<li>调用<code>Think\Storage</code>类进行存储初始化（由<code>STORAGE_TYPE</code>常量定义存储类型）</li>
<li>部署模式下如果存在应用编译缓存文件则直接加载（直接跳转到步骤22）</li>
<li>读取应用模式（由<code>APP_MODE</code>常量定义）的定义文件（以下以普通模式为例说明）</li>
<li>加载当前应用模式定义的核心文件（普通模式是 <code>ThinkPHP/Mode/common.php</code>）</li>
<li>加载惯例配置文件（普通模式是 <code>ThinkPHP/Conf/convention.php</code>）</li>
<li>加载应用配置文件（普通模式是 <code>Application/Common/Conf/config.php</code>）</li>
<li>加载系统别名定义</li>
<li>判断并读取应用别名定义文件（普通模式是 <code>Application/Common/Conf/alias.php</code>）</li>
<li>加载系统行为定义</li>
<li>判断并读取应用行为定义文件（普通模式是 <code>Application/Common/Conf/tags.php</code>）</li>
<li>加载框架底层语言包（普通模式是 <code>ThinkPHP/Lang/zh-cn.php</code>）</li>
<li>如果是部署模式则生成应用编译缓存文件</li>
<li>加载调试模式系统配置文件（<code>ThinkPHP/Conf/debug.php</code>）</li>
<li>判断并读取应用的调试配置文件（默认是 <code>Application/Common/Conf/debug.php</code>）</li>
<li>判断应用状态并读取状态配置文件（如果<code>APP_STATUS</code>常量定义不为空的话）</li>
<li>检测应用目录结构并自动生成（如果<code>CHECK_APP_DIR</code>配置开启并且<code>RUNTIME_PATH</code>目录不存在的情况下）</li>
<li>调用<code>Think\App</code>类的<code>run</code>方法启动应用</li>
<li>应用初始化（<code>app_init</code>）标签位侦听并执行绑定行为</li>
<li>判断并加载动态配置和函数文件</li>
<li>调用<code>Think\Dispatcher::dispatch</code>方法进行URL请求调度</li>
<li>自动识别兼容URL模式和命令行模式下面的<code>$_SERVER[&#39;PATH_INFO&#39;]</code>参数</li>
<li>检测域名部署以及完成模块和控制器的绑定操作（<code>APP_SUB_DOMAIN_DEPLOY</code>参数开启）</li>
<li>分析URL地址中的<code>PATH_INFO</code>信息</li>
<li>获取请求的模块信息</li>
<li>检测模块是否存在和允许访问</li>
<li>判断并加载模块配置文件、别名定义、行为定义及函数文件</li>
<li>判断并加载模块的动态配置和函数文件</li>
<li>模块的URL模式判断</li>
<li>模块的路由检测（<code>URL_ROUTER_ON</code>开启）</li>
<li><code>PATH_INFO</code>处理（<code>path_info</code>）标签位侦听并执行绑定行为</li>
<li>URL后缀检测（<code>URL_DENY_SUFFIX</code>以及<code>URL_HTML_SUFFIX</code>处理）</li>
<li>获取当前控制器和操作，以及URL其他参数</li>
<li>URL请求调度完成（<code>url_dispatch</code>）标签位侦听并执行绑定行为</li>
<li>应用开始（<code>app_begin</code>）标签位侦听并执行绑定行为</li>
<li>调用<code>SESSION_OPTIONS</code>配置参数进行<code>Session</code>初始化（如果不是命令行模式）</li>
<li>根据请求执行控制器方法</li>
<li>如果控制器不存在则检测空控制器是否存在</li>
<li>控制器开始（<code>action_begin</code>）标签位侦听并执行绑定行为</li>
<li>默认调用系统的<code>ReadHtmlCache</code>行为读取静态缓存（<code>HTML_CACHE_ON</code>参数开启）</li>
<li>判断并调用控制器的<code>_initialize</code>初始化方法</li>
<li>判断操作方法是否存在，如果不存在则检测是否定义空操作方法</li>
<li>判断前置操作方法是否定义，有的话执行</li>
<li>Action参数绑定检测，自动匹配操作方法的参数</li>
<li>如果有模版渲染（调用控制器display方法）</li>
<li>视图开始（<code>view_begin</code>）标签位侦听并执行绑定行为</li>
<li>调用<code>Think\View</code>的<code>fetch</code>方法解析并获取模版内容</li>
<li>自动识别当前主题以及定位模版文件</li>
<li>视图解析（<code>view_parse</code>）标签位侦听并执行绑定行为</li>
<li>默认调用内置<code>ParseTemplate</code>行为解析模版（普通模式下面）</li>
<li>模版引擎解析模版内容后生成模版缓存</li>
<li>模版过滤替换（<code>template_filter</code>）标签位侦听并执行绑定行为</li>
<li>默认调用系统的<code>ContentReplace</code>行为进行模版替换</li>
<li>输出内容过滤（<code>view_filter</code>）标签位侦听并执行绑定行为</li>
<li>默认调用系统的<code>WriteHtmlCache</code>行为写入静态缓存（<code>HTML_CACHE_ON</code>参数开启）</li>
<li>调用<code>Think\View</code>类的<code>render</code>方法输出渲染内容</li>
<li>视图结束（<code>view_end</code>）标签位侦听并执行绑定行为</li>
<li>判断后置操作方法是否定义，有的话执行</li>
<li>控制器结束（<code>action_end</code>）标签位侦听并执行绑定行为</li>
<li>应用结束（<code>app_end</code>）标签位侦听并执行绑定行为</li>
<li>执行系统的<code>ShowPageTrace</code>行为（<code>SHOW_PAGE_TRACE</code>参数开启并且不是<code>AJAX</code>请求）</li>
<li>日志信息存储写入</li>
</ol>
<blockquote>
<p>如果是部署模式下面的第二次请求的话，上面的流程中的步骤10~21是可以省略的。</p>
</blockquote>
<h1 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h1><h2 id="规则路由"><a href="#规则路由" class="headerlink" title="规则路由"></a>规则路由</h2><h3 id="规则表达式"><a href="#规则表达式" class="headerlink" title="规则表达式"></a>规则表达式</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'my'</span>         =&gt; <span class="string">'Member/myinfo'</span>, <span class="comment">// 静态地址路由</span></span><br><span class="line"><span class="string">'blog/:id'</span>   =&gt; <span class="string">'Blog/read'</span>, <span class="comment">// 静态地址和动态地址结合</span></span><br><span class="line"><span class="string">'new/:year/:month/:day'</span>=&gt;<span class="string">'News/read'</span>, <span class="comment">// 静态地址和动态地址结合</span></span><br><span class="line"><span class="string">':user/:blog_id'</span> =&gt;<span class="string">'Blog/read'</span>,<span class="comment">// 全动态地址</span></span><br></pre></td></tr></table></figure>
<h2 id="实例说明"><a href="#实例说明" class="headerlink" title="实例说明"></a>实例说明</h2><p>假设我们定义了News控制器如下（代码实现仅供参考）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewsController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $New = M(<span class="string">'New'</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'id'</span>])) &#123;</span><br><span class="line">            <span class="comment">// 根据id查询结果</span></span><br><span class="line">            $data = $New-&gt;find($_GET[<span class="string">'id'</span>]);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_GET[<span class="string">'name'</span>]))&#123;</span><br><span class="line">            <span class="comment">// 根据name查询结果</span></span><br><span class="line">            $data = $New-&gt;getByName($_GET[<span class="string">'name'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = $data;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;display();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">archive</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $New = M(<span class="string">'New'</span>);</span><br><span class="line">        $year   =   $_GET[<span class="string">'year'</span>];</span><br><span class="line">        $month  =   $_GET[<span class="string">'month'</span>];</span><br><span class="line">        $begin_time = strtotime($year . $month . <span class="string">"01"</span>);</span><br><span class="line">        $end_time = strtotime(<span class="string">"+1 month"</span>, $begin_time);</span><br><span class="line">        $map[<span class="string">'create_time'</span>] =  <span class="keyword">array</span>(<span class="keyword">array</span>(<span class="string">'gt'</span>,$begin_time),<span class="keyword">array</span>(<span class="string">'lt'</span>,$end_time));</span><br><span class="line">        $map[<span class="string">'status'</span>]  =   <span class="number">1</span>;</span><br><span class="line">        $list = $New-&gt;where($map)-&gt;select();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;list =   $list;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;display();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义路由规则如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'URL_ROUTER_ON'</span>   =&gt; <span class="keyword">true</span>, <span class="comment">//开启路由</span></span><br><span class="line"><span class="string">'URL_ROUTE_RULES'</span> =&gt; <span class="keyword">array</span>( <span class="comment">//定义路由规则 </span></span><br><span class="line">    <span class="string">'new/:id\d'</span>    =&gt; <span class="string">'News/read'</span>,</span><br><span class="line">    <span class="string">'new/:name'</span>    =&gt; <span class="string">'News/read'</span>,</span><br><span class="line">    <span class="string">'new/:year\d/:month\d'</span>  =&gt; <span class="string">'News/archive'</span>,</span><br><span class="line">),</span><br></pre></td></tr></table></figure>
<h1 id="控制器-1"><a href="#控制器-1" class="headerlink" title="控制器"></a>控制器</h1><h2 id="前置和后置操作"><a href="#前置和后置操作" class="headerlink" title="前置和后置操作"></a>前置和后置操作</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">//前置操作方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_before_index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'before&lt;br/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'index&lt;br/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后置操作方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_after_index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'after&lt;br/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="伪静态"><a href="#伪静态" class="headerlink" title="伪静态"></a>伪静态</h2><p>URL伪静态通常是为了满足更好的<strong>SEO</strong>效果，ThinkPHP支持伪静态URL设置，可以通过设置<code>URL_HTML_SUFFIX</code>参数随意在URL的最后增加你想要的静态后缀，而不会影响当前操作的正常执行。例如，我们设置:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'URL_HTML_SUFFIX'</span>=&gt;<span class="string">'shtml'</span></span><br></pre></td></tr></table></figure>
<p>默认情况下，伪静态的设置为html，如果我们设置伪静态后缀为空，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'URL_HTML_SUFFIX'</span>=&gt;<span class="string">''</span></span><br></pre></td></tr></table></figure>
<p>则可以支持所有的静态后缀，并且会记录当前的伪静态后缀到常量 <code>__EXT__</code> ，但不会影响正常的页面访问。</p>
<p>如果希望支持多个伪静态后缀，可以直接设置如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多个伪静态后缀设置 用|分割</span></span><br><span class="line"><span class="string">'URL_HTML_SUFFIX'</span> =&gt; <span class="string">'html|shtml|xml'</span></span><br></pre></td></tr></table></figure>
<p>可以设置禁止访问的URL后缀，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'URL_DENY_SUFFIX'</span> =&gt; <span class="string">'pdf|ico|png|gif|jpg'</span>, <span class="comment">// URL禁止访问的后缀设置</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：</strong><br>URL_DENY_SUFFIX的优先级比URL_HTML_SUFFIX要高。</p>
</blockquote>
<h2 id="URL生成"><a href="#URL生成" class="headerlink" title="URL生成"></a>URL生成</h2><p>为了配合所使用的URL模式，我们需要能够动态的根据当前的URL设置生成对应的URL地址，为此，ThinkPHP内置提供了<strong>U</strong>方法，用于URL的动态生成，可以确保项目在移植过程中不受环境的影响。</p>
<ul>
<li>U(‘地址表达式’,[‘参数’],[‘伪静态后缀’],[‘显示域名’])</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">U(<span class="string">'User/add'</span>) <span class="comment">// 生成User控制器的add操作的URL地址</span></span><br><span class="line">U(<span class="string">'Blog/read?id=1'</span>) <span class="comment">// 生成Blog控制器的read操作 并且id为1的URL地址</span></span><br><span class="line">U(<span class="string">'Admin/User/select'</span>) <span class="comment">// 生成Admin模块的User控制器的select操作的URL地址</span></span><br></pre></td></tr></table></figure>
<h2 id="AJAX返回"><a href="#AJAX返回" class="headerlink" title="AJAX返回"></a>AJAX返回</h2><p>ThinkPHP可以很好的支持AJAX请求，系统的<code>\Think\Controller</code>类提供了<code>ajaxReturn</code>方法用于<code>AJAX</code>调用后返回数据给客户端。并且支持<code>JSON</code>、<code>JSONP</code>、<code>XML</code>和<code>EVAL</code>四种方式给客户端接受数据，并且支持配置其他方式的数据格式返回。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$data = <span class="string">'ok'</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;ajaxReturn($data);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持返回数组数据：</span></span><br><span class="line">$data[<span class="string">'status'</span>]  = <span class="number">1</span>;</span><br><span class="line">$data[<span class="string">'content'</span>] = <span class="string">'content'</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;ajaxReturn($data);</span><br></pre></td></tr></table></figure>
<p>默认配置采用JSON格式返回数据（通过配置DEFAULT_AJAX_RETURN进行设置），我们可以指定格式返回，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指定XML格式返回数据</span></span><br><span class="line">$data[<span class="string">'status'</span>]  = <span class="number">1</span>;</span><br><span class="line">$data[<span class="string">'content'</span>] = <span class="string">'content'</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;ajaxReturn($data,<span class="string">'xml'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="跳转和重定向"><a href="#跳转和重定向" class="headerlink" title="跳转和重定向"></a>跳转和重定向</h2><h3 id="页面跳转"><a href="#页面跳转" class="headerlink" title="页面跳转"></a>页面跳转</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$User = M(<span class="string">'User'</span>); <span class="comment">//实例化User对象</span></span><br><span class="line">$result = $User-&gt;add($data); </span><br><span class="line"><span class="keyword">if</span>($result)&#123;</span><br><span class="line">    <span class="comment">//设置成功后跳转页面的地址，默认的返回页面是$_SERVER['HTTP_REFERER']</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;success(<span class="string">'新增成功'</span>, <span class="string">'/User/index'</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//错误页面的默认跳转页面是返回前一页，通常不需要设置</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;error(<span class="string">'新增失败'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跳转地址是可选的，<code>success</code>方法的默认跳转地址是<code>$_SERVER[&quot;HTTP_REFERER&quot;]</code>，<code>error</code>方法的默认跳转地址是<code>javascript:history.back(-1)</code>;。</p>
<blockquote>
<p>默认的等待时间success方法是1秒，error方法是3秒</p>
</blockquote>
<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//重定向到New模块的Category操作</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;redirect(<span class="string">'New/category'</span>, <span class="keyword">array</span>(<span class="string">'cate_id'</span> =&gt; <span class="number">2</span>), <span class="number">5</span>, <span class="string">'页面跳转中...'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="输入变量"><a href="#输入变量" class="headerlink" title="输入变量"></a>输入变量</h2><h3 id="获取变量"><a href="#获取变量" class="headerlink" title="获取变量"></a>获取变量</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$id    =  $_GET[<span class="string">'id'</span>]; <span class="comment">// 获取get变量</span></span><br><span class="line">$name  =  $_POST[<span class="string">'name'</span>];  <span class="comment">// 获取post变量</span></span><br><span class="line">$value =  $_SESSION[<span class="string">'var'</span>]; <span class="comment">// 获取session变量</span></span><br><span class="line">$name  =  $_COOKIE[<span class="string">'name'</span>]; <span class="comment">// 获取cookie变量</span></span><br><span class="line">$file  =  $_SERVER[<span class="string">'PHP_SELF'</span>]; <span class="comment">// 获取server变量</span></span><br></pre></td></tr></table></figure>
<p>但是我们不建议直接使用传统方式获取，因为没有统一的安全处理机制，后期如果调整的话，改起来会比较麻烦。所以，更好的方式是在框架中统一使用<strong>I</strong>函数进行变量获取和过滤。</p>
<ul>
<li>I(‘变量类型.变量名/修饰符’,[‘默认值’],[‘过滤方法或正则’],[‘额外数据源’])</li>
</ul>
<h3 id="变量修饰符"><a href="#变量修饰符" class="headerlink" title="变量修饰符"></a>变量修饰符</h3><ul>
<li>I(‘变量类型.变量名/修饰符’)</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">I(<span class="string">'get.id/d'</span>); <span class="comment">// 强制变量转换为整型</span></span><br><span class="line">I(<span class="string">'post.name/s'</span>); <span class="comment">// 强制转换变量为字符串类型</span></span><br><span class="line">I(<span class="string">'post.ids/a'</span>); <span class="comment">// 强制变量转换为数组类型</span></span><br></pre></td></tr></table></figure>
<h2 id="请求类型"><a href="#请求类型" class="headerlink" title="请求类型"></a>请求类型</h2><ul>
<li><code>IS_GET</code>：判断是否是GET方式提交</li>
<li><code>IS_POST</code>：判断是否是POST方式提交</li>
<li><code>IS_PUT</code>：判断是否是PUT方式提交</li>
<li><code>IS_DELETE</code>：判断是否是DELETE方式提交</li>
<li><code>IS_AJAX</code>：判断是否是AJAX提交</li>
<li><code>REQUEST_METHOD</code>：当前提交类型</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">()</span></span></span><br><span class="line"><span class="function">     </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (IS_POST) &#123;</span><br><span class="line">             $User = M(<span class="string">'User'</span>);</span><br><span class="line">             $User-&gt;create();</span><br><span class="line">             $User-&gt;save();</span><br><span class="line">             <span class="keyword">$this</span>-&gt;success(<span class="string">'保存完成'</span>);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">$this</span>-&gt;error(<span class="string">'非法请求'</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="空操作"><a href="#空操作" class="headerlink" title="空操作"></a>空操作</h2><p>空操作是指系统在找不到请求的操作方法的时候，会定位到空操作（<code>_empty</code>）方法来执行，利用这个机制，我们可以实现错误页面和一些URL的优化。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CityController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_empty</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//把所有城市的操作解析到city方法</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;city($name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意 city方法 本身是 protected 方法</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">city</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//和$name这个城市相关的处理</span></span><br><span class="line">         <span class="keyword">echo</span> <span class="string">'当前城市'</span> . $name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h1><h2 id="模型定义"><a href="#模型定义" class="headerlink" title="模型定义"></a>模型定义</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryModel</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $tableName = <span class="string">'categories'</span>;</span><br><span class="line">    <span class="keyword">protected</span> $tablePrefix = <span class="string">'top_'</span>; </span><br><span class="line">    <span class="keyword">protected</span> $trueTableName = <span class="string">'top_categories'</span>; </span><br><span class="line">    <span class="keyword">protected</span> $dbName = <span class="string">'top'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="模型实例化"><a href="#模型实例化" class="headerlink" title="模型实例化"></a>模型实例化</h2><h3 id="D方法实例化"><a href="#D方法实例化" class="headerlink" title="D方法实例化"></a>D方法实例化</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//实例化模型</span></span><br><span class="line">$User = D(<span class="string">'User'</span>);</span><br><span class="line"><span class="comment">// 相当于 $User = new \Home\Model\UserModel();</span></span><br><span class="line"><span class="comment">// 执行具体的数据操作</span></span><br><span class="line">$User-&gt;select();</span><br></pre></td></tr></table></figure>
<h2 id="切换数据库"><a href="#切换数据库" class="headerlink" title="切换数据库"></a>切换数据库</h2><p>如果我们已经在项目配置中定义了其他的数据库连接信息，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//数据库配置1</span></span><br><span class="line"><span class="string">'DB_CONFIG1'</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'db_type'</span>  =&gt; <span class="string">'mysql'</span>,</span><br><span class="line">    <span class="string">'db_user'</span>  =&gt; <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'db_pwd'</span>   =&gt; <span class="string">'1234'</span>,</span><br><span class="line">    <span class="string">'db_host'</span>  =&gt; <span class="string">'localhost'</span>,</span><br><span class="line">    <span class="string">'db_port'</span>  =&gt; <span class="string">'3306'</span>,</span><br><span class="line">    <span class="string">'db_name'</span>  =&gt; <span class="string">'thinkphp'</span></span><br><span class="line">),</span><br><span class="line"><span class="comment">//数据库配置2</span></span><br><span class="line"><span class="string">'DB_CONFIG2'</span> =&gt; <span class="string">'mysql://root:1234@localhost:3306/thinkphp'</span>;</span><br></pre></td></tr></table></figure>
<p>我们就可以直接在db方法中调用配置进行连接了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;db(<span class="number">1</span>,<span class="string">"DB_CONFIG1"</span>)-&gt;query(<span class="string">"查询SQL"</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;db(<span class="number">2</span>,<span class="string">"DB_CONFIG2"</span>)-&gt;query(<span class="string">"查询SQL"</span>);</span><br></pre></td></tr></table></figure>
<p>如果切换数据库之后，数据表和当前不一致的话，可以使用table方法指定要操作的数据表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;db(<span class="number">1</span>)-&gt;table(<span class="string">"top_user"</span>)-&gt;find();</span><br></pre></td></tr></table></figure>
<h2 id="连贯操作"><a href="#连贯操作" class="headerlink" title="连贯操作"></a>连贯操作</h2><h3 id="lock"><a href="#lock" class="headerlink" title="lock"></a>lock</h3><p><code>Lock</code>方法是用于数据库的锁机制，如果在查询或者执行操作的时候使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lock(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<h3 id="fetchSql"><a href="#fetchSql" class="headerlink" title="fetchSql"></a>fetchSql</h3><p><code>fetchSql</code>用于直接返回SQL而不是执行查询，适用于任何的CURD操作方法。 例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$result = M(<span class="string">'User'</span>)-&gt;fetchSql(<span class="keyword">true</span>)-&gt;find(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<h3 id="token"><a href="#token" class="headerlink" title="token"></a>token</h3><p><code>token</code>方法可用于临时关闭令牌验证，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$model-&gt;token(<span class="keyword">false</span>)-&gt;create();</span><br></pre></td></tr></table></figure>
<h3 id="strict"><a href="#strict" class="headerlink" title="strict"></a>strict</h3><p><code>strict</code>为3.2.3新增连贯操作，用于设置数据写入和查询是否严格检查是否存在字段。默认情况下不合法数据字段自动删除，如果设置了严格检查则会抛出异常。 例如:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$model-&gt;strict(<span class="keyword">true</span>)-&gt;add($data);</span><br></pre></td></tr></table></figure>
<h3 id="index"><a href="#index" class="headerlink" title="index"></a>index</h3><p><code>index</code>方法用于数据集的强制索引操作，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$Model-&gt;index(<span class="string">'user'</span>)-&gt;select();</span><br></pre></td></tr></table></figure>
<h2 id="查询语言"><a href="#查询语言" class="headerlink" title="查询语言"></a>查询语言</h2><h3 id="SQL查询"><a href="#SQL查询" class="headerlink" title="SQL查询"></a>SQL查询</h3><h4 id="QUERY方法"><a href="#QUERY方法" class="headerlink" title="QUERY方法"></a>QUERY方法</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$Model = <span class="keyword">new</span> \Think\Model() <span class="comment">// 实例化一个model对象 没有对应任何数据表</span></span><br><span class="line">$Model-&gt;query(<span class="string">"select * from think_user where status=1"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="EXECUTE方法"><a href="#EXECUTE方法" class="headerlink" title="EXECUTE方法"></a>EXECUTE方法</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$Model = <span class="keyword">new</span> \Think\Model() <span class="comment">// 实例化一个model对象 没有对应任何数据表</span></span><br><span class="line">$Model-&gt;execute(<span class="string">"update think_user set name='thinkPHP' where status=1"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="动态查询"><a href="#动态查询" class="headerlink" title="动态查询"></a>动态查询</h3><h4 id="getBy动态查询"><a href="#getBy动态查询" class="headerlink" title="getBy动态查询"></a>getBy动态查询</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$user = $User-&gt;getByName(<span class="string">'liu21st'</span>);</span><br><span class="line">$user = $User-&gt;getByEmail(<span class="string">'liu21st@gmail.com'</span>);</span><br><span class="line">$user = $User-&gt;getByAddress(<span class="string">'中国深圳'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="getFieldBy动态查询"><a href="#getFieldBy动态查询" class="headerlink" title="getFieldBy动态查询"></a>getFieldBy动态查询</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$userId = $User-&gt;getFieldByName(<span class="string">'liu21st'</span>,<span class="string">'id'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h3><p>1、使用select方法 当select方法的参数为false的时候，表示不进行查询只是返回构建SQL，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先构造子查询SQL </span></span><br><span class="line">$subQuery = $model-&gt;field(<span class="string">'id,name'</span>)-&gt;table(<span class="string">'tablename'</span>)-&gt;group(<span class="string">'field'</span>)-&gt;where($where)-&gt;order(<span class="string">'status'</span>)-&gt;select(<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<p>当select方法传入false参数的时候，表示不执行当前查询，而只是生成查询SQL。</p>
<p>2、使用buildSql方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$subQuery = $model-&gt;field(<span class="string">'id,name'</span>)-&gt;table(<span class="string">'tablename'</span>)-&gt;group(<span class="string">'field'</span>)-&gt;where($where)-&gt;order(<span class="string">'status'</span>)-&gt;buildSql();</span><br></pre></td></tr></table></figure>
<p>调用buildSql方法后不会进行实际的查询操作，而只是生成该次查询的SQL语句（为了避免混淆，会在SQL两边加上括号），然后我们直接在后续的查询中直接调用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 利用子查询进行查询 </span></span><br><span class="line">$model-&gt;table($subQuery.<span class="string">' a'</span>)-&gt;where()-&gt;order()-&gt;select()</span><br></pre></td></tr></table></figure>
<h2 id="自动验证"><a href="#自动验证" class="headerlink" title="自动验证"></a>自动验证</h2><h3 id="动态验证"><a href="#动态验证" class="headerlink" title="动态验证"></a>动态验证</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$rules = <span class="keyword">array</span>(</span><br><span class="line">     <span class="keyword">array</span>(<span class="string">'verify'</span>,<span class="string">'require'</span>,<span class="string">'验证码必须！'</span>), <span class="comment">//默认情况下用正则进行验证</span></span><br><span class="line">     <span class="keyword">array</span>(<span class="string">'name'</span>,<span class="string">''</span>,<span class="string">'帐号名称已经存在！'</span>,<span class="number">0</span>,<span class="string">'unique'</span>,<span class="number">1</span>), <span class="comment">// 在新增的时候验证name字段是否唯一</span></span><br><span class="line">     <span class="keyword">array</span>(<span class="string">'value'</span>,<span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>),<span class="string">'值的范围不正确！'</span>,<span class="number">2</span>,<span class="string">'in'</span>), <span class="comment">// 当值不为空的时候判断是否在一个范围内</span></span><br><span class="line">     <span class="keyword">array</span>(<span class="string">'repassword'</span>,<span class="string">'password'</span>,<span class="string">'确认密码不正确'</span>,<span class="number">0</span>,<span class="string">'confirm'</span>), <span class="comment">// 验证确认密码是否和密码一致</span></span><br><span class="line">     <span class="keyword">array</span>(<span class="string">'password'</span>,<span class="string">'checkPwd'</span>,<span class="string">'密码格式不正确'</span>,<span class="number">0</span>,<span class="string">'function'</span>), <span class="comment">// 自定义函数验证密码格式</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$User = M(<span class="string">"User"</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line"><span class="keyword">if</span> (!$User-&gt;validate($rules)-&gt;create())&#123;</span><br><span class="line">     <span class="comment">// 如果创建失败 表示验证没有通过 输出错误提示信息</span></span><br><span class="line">     <span class="keyword">exit</span>($User-&gt;getError());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="comment">// 验证通过 可以进行其他数据操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参数绑定"><a href="#参数绑定" class="headerlink" title="参数绑定"></a>参数绑定</h2><h3 id="手动绑定"><a href="#手动绑定" class="headerlink" title="手动绑定"></a>手动绑定</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$Model = M(<span class="string">'User'</span>);</span><br><span class="line">$where[<span class="string">'name'</span>] = <span class="string">':name'</span>;</span><br><span class="line">$list = $Model-&gt;where($where)-&gt;bind(<span class="string">':name'</span>,I(<span class="string">'name'</span>))-&gt;select();</span><br></pre></td></tr></table></figure>
<p>目前不支持 <code>?</code> 方式进行占位符，统一使用 <code>:var</code> 方式进行占位符，驱动内部会自动进行处理。</p>
<h3 id="自动绑定"><a href="#自动绑定" class="headerlink" title="自动绑定"></a>自动绑定</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$Model = M(<span class="string">'User'</span>);</span><br><span class="line">$Model-&gt;name = <span class="string">'thinkphp'</span>;</span><br><span class="line">$Model-&gt;email = <span class="string">'thinkphp@qq.com'</span>;</span><br><span class="line">$Model-&gt;add();</span><br></pre></td></tr></table></figure>
<h2 id="关联模型"><a href="#关联模型" class="headerlink" title="关联模型"></a>关联模型</h2><h3 id="关联关系"><a href="#关联关系" class="headerlink" title="关联关系"></a>关联关系</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">一对一关联 ：ONE_TO_ONE，包括HAS_ONE 和 BELONGS_TO </span><br><span class="line">一对多关联 ：ONE_TO_MANY，包括HAS_MANY 和 BELONGS_TO</span><br><span class="line">多对多关联 ：MANY_TO_MANY</span><br></pre></td></tr></table></figure>
<h3 id="HAS-ONE"><a href="#HAS-ONE" class="headerlink" title="HAS_ONE"></a>HAS_ONE</h3><p><code>HAS_ONE</code>关联表示当前模型拥有一个子对象，例如，每个员工都有一个人事档案。我们可以建立一个用户模型UserModel，并且添加如下关联定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Model</span>\<span class="title">RelationModel</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserModel</span> <span class="keyword">extends</span> <span class="title">RelationModel</span></span>&#123;</span><br><span class="line">     <span class="keyword">protected</span> $_link = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'Profile'</span>=&gt; <span class="keyword">self</span>::HAS_ONE,</span><br><span class="line">     );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BELONGS-TO"><a href="#BELONGS-TO" class="headerlink" title="BELONGS_TO"></a>BELONGS_TO</h3><p><code>Belongs_to</code>关联表示当前模型从属于另外一个父对象，例如每个用户都属于一个部门。我们可以做如下关联定义。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'Dept'</span> =&gt; <span class="keyword">self</span>::BELONGS_TO</span><br></pre></td></tr></table></figure>
<h3 id="HAS-MANY"><a href="#HAS-MANY" class="headerlink" title="HAS_MANY"></a>HAS_MANY</h3><p><code>HAS_MANY</code> 关联表示当前模型拥有多个子对象，例如每个用户有多篇文章，我们可以这样来定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'Article'</span> =&gt; <span class="keyword">self</span>::HAS_MANY</span><br></pre></td></tr></table></figure>
<h3 id="MANY-TO-MANY"><a href="#MANY-TO-MANY" class="headerlink" title="MANY_TO_MANY"></a>MANY_TO_MANY</h3><p><code>MANY_TO_MANY</code> 关联表示当前模型可以属于多个对象，而父对象则可能包含有多个子对象，通常两者之间需要一个中间表类约束和关联。例如每个用户可以属于多个组，每个组可以有多个用户：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'Group'</span> =&gt; <span class="keyword">self</span>::MANY_TO_MANY</span><br></pre></td></tr></table></figure>
<h3 id="关联删除"><a href="#关联删除" class="headerlink" title="关联删除"></a>关联删除</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//删除用户ID为3的记录的同时删除关联数据</span></span><br><span class="line">$result = $User-&gt;relation(<span class="keyword">true</span>)-&gt;delete(<span class="string">"3"</span>);</span><br><span class="line"><span class="comment">// 如果只需要关联删除部分数据，可以使用</span></span><br><span class="line">$result = $User-&gt;relation(<span class="string">"Profile"</span>)-&gt;delete(<span class="string">"3"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="高级模型"><a href="#高级模型" class="headerlink" title="高级模型"></a>高级模型</h2><h3 id="字段过滤"><a href="#字段过滤" class="headerlink" title="字段过滤"></a>字段过滤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $_filter = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'过滤的字段'</span>=&gt;<span class="keyword">array</span>(<span class="string">'写入过滤规则'</span>,<span class="string">'读取过滤规则'</span>,是否传入整个数据对象),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="序列化字段"><a href="#序列化字段" class="headerlink" title="序列化字段"></a>序列化字段</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $serializeField = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'info'</span> =&gt; <span class="keyword">array</span>(<span class="string">'name'</span>, <span class="string">'email'</span>, <span class="string">'address'</span>),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="文本字段"><a href="#文本字段" class="headerlink" title="文本字段"></a>文本字段</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Protected</span>  $blobFields = <span class="keyword">array</span>(<span class="string">'content'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="只读字段"><a href="#只读字段" class="headerlink" title="只读字段"></a>只读字段</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $readonlyField = <span class="keyword">array</span>(<span class="string">'name'</span>, <span class="string">'email'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="悲观锁（-Pessimistic-Locking-）"><a href="#悲观锁（-Pessimistic-Locking-）" class="headerlink" title="悲观锁（ Pessimistic Locking ）"></a>悲观锁（ Pessimistic Locking ）</h3><blockquote>
<p>悲观锁，正如其名，它指的是对数据被外界（包括本系统当前的其他事务，以及来自外部系统的事务处理）修改持保守态度，因此，在整个数据处理过程中，将数据处于锁定状态。悲观锁的实现，往往依靠数据库提供的锁机制（也只有数据库层提供的锁机制才能真正保证数据访问的排他性，否则，即使在本系统中实现了加锁机制，也无法保证外部系统不会修改数据）。 通常是使用for update子句来实现悲观锁机制。</p>
<p>ThinkPHP支持悲观锁机制，默认情况下，是关闭悲观锁功能的，要在查询和更新的时候启用悲观锁功能，可以通过使用之前提到的查询锁定方法，例如：</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$User-&gt;lock(<span class="keyword">true</span>)-&gt;save($data);<span class="comment">// 使用悲观锁功能</span></span><br></pre></td></tr></table></figure>
<h3 id="乐观锁（-Optimistic-Locking-）"><a href="#乐观锁（-Optimistic-Locking-）" class="headerlink" title="乐观锁（ Optimistic Locking ）"></a>乐观锁（ Optimistic Locking ）</h3><blockquote>
<p>相对悲观锁而言，乐观锁机制采取了更加宽松的加锁机制。悲观锁大多数情况下依靠数据库的锁机制实现，以保证操作最大程度的独占性。但随之而来的就是数据库性能的大量开销，特别是对长事务而言，这样的开销往往无法承受。 如一个金融系统，当某个操作员读取用户的数据，并在读出的用户数据的基础上进行修改时（如更改用户帐户余额），如果采用悲观锁机制，也就意味着整个操作过程中（从操作员读出数据、开始修改直至提交修改结果的全过程，甚至还包括操作员中途去煮咖啡的时间），数据库记录始终处于加锁状态，可以想见，如果面对几百上千个并发，这样的情况将导致怎样的后果。乐观锁机制在一定程度上解决了这个问题。乐观锁，大多是基于数据版本（ Version ）记录机制实现。何谓数据版本？即为数据增加一个版本标识，在基于数据库表的版本解决方案中，一般是通过为数据库表增加一个 “version” 字段来实现。</p>
</blockquote>
<blockquote>
<p>ThinkPHP也可以支持乐观锁机制，要启用乐观锁，只需要继承高级模型类并定义模型的optimLock属性，并且在数据表字段里面增加相应的字段就可以自动启用乐观锁机制了。默认的optimLock属性是lock_version，也就是说如果要在User表里面启用乐观锁机制，只需要在User表里面增加lock_version字段，如果有已经存在的其它字段作为乐观锁用途，可以修改模型类的optimLock属性即可。如果存在optimLock属性对应的字段，但是需要临时关闭乐观锁机制，把optimLock属性设置为false就可以了。</p>
</blockquote>
<h3 id="数据分表"><a href="#数据分表" class="headerlink" title="数据分表"></a>数据分表</h3><p>对于大数据量的应用，经常会对数据进行<strong>分表</strong>，有些情况是可以利用数据库的<strong>分区</strong>功能，但并不是所有的数据库或者版本都支持，因此我们可以利用ThinkPHP内置的数据分表功能来实现。帮助我们更方便的进行数据的分表和读取操作。</p>
<p>和数据库分区功能不同，内置的数据分表功能需要根据分表规则手动创建相应的数据表。<br>在需要分表的模型中定义<code>partition</code>属性即可。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $partition = <span class="keyword">array</span>(</span><br><span class="line"> <span class="string">'field'</span> =&gt; <span class="string">'name'</span>,<span class="comment">// 要分表的字段 通常数据会根据某个字段的值按照规则进行分表</span></span><br><span class="line"> <span class="string">'type'</span>  =&gt; <span class="string">'md5'</span>,<span class="comment">// 分表的规则 包括id year mod md5 函数 和首字母</span></span><br><span class="line"> <span class="string">'expr'</span>  =&gt; <span class="string">'name'</span>,<span class="comment">// 分表辅助表达式 可选 配合不同的分表规则</span></span><br><span class="line"> <span class="string">'num'</span>   =&gt; <span class="string">'name'</span>,<span class="comment">// 分表的数目 可选 实际分表的数量</span></span><br><span class="line"> );</span><br></pre></td></tr></table></figure>
<p>定义好了分表属性后，我们就可以来进行CURD操作了，唯一不同的是，获取当前的数据表不再使用<code>getTableName</code>方法，而是使用<code>getPartitionTableName</code>方法，而且必须传入当前的数据。然后根据数据分析应该实际操作哪个数据表。因此，分表的字段值必须存在于传入的数据中，否则会进行联合查询。</p>
<h2 id="Mongo模型"><a href="#Mongo模型" class="headerlink" title="Mongo模型"></a>Mongo模型</h2><p><code>Mongo</code>模型是专门为Mongo数据库驱动而支持的Model扩展，如果需要操作Mongo数据库的话，自定义的模型类必须继承<code>Think\Model\MongoModel</code>。</p>
<p>Mongo模型为操作Mongo数据库提供了更方便的实用功能和查询用法，包括：</p>
<ol>
<li>对<code>MongoId</code>对象和非对象主键的全面支持；</li>
<li>保持了动态追加字段的特性；</li>
<li>数字自增字段的支持；</li>
<li>执行<code>SQL</code>日志的支持；</li>
<li>字段自动检测的支持；</li>
<li>查询语言的支持；</li>
<li><code>MongoCode</code>执行的支持；</li>
</ol>
<h1 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h1><h2 id="模板赋值"><a href="#模板赋值" class="headerlink" title="模板赋值"></a>模板赋值</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$array[<span class="string">'name'</span>]    =    <span class="string">'thinkphp'</span>;</span><br><span class="line">$array[<span class="string">'email'</span>]   =    <span class="string">'liu21st@gmail.com'</span>;</span><br><span class="line">$array[<span class="string">'phone'</span>]   =    <span class="string">'12335678'</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;assign($array);</span><br></pre></td></tr></table></figure>
<h2 id="模板渲染"><a href="#模板渲染" class="headerlink" title="模板渲染"></a>模板渲染</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不带任何参数 自动定位当前操作的模板文件</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;display();</span><br></pre></td></tr></table></figure>
<h2 id="获取模板地址"><a href="#获取模板地址" class="headerlink" title="获取模板地址"></a>获取模板地址</h2><ul>
<li>T([资源://][模块@][主题/][控制器/]操作,[视图分层])</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">T(<span class="string">'Public/menu'</span>);</span><br><span class="line"><span class="comment">// 返回 当前模块/View/Public/menu.html</span></span><br><span class="line">T(<span class="string">'blue/Public/menu'</span>);</span><br><span class="line"><span class="comment">// 返回 当前模块/View/blue/Public/menu.html</span></span><br><span class="line">T(<span class="string">'Public/menu'</span>,<span class="string">'Tpl'</span>);</span><br><span class="line"><span class="comment">// 返回 当前模块/Tpl/Public/menu.html</span></span><br><span class="line">T(<span class="string">'Public/menu'</span>);</span><br><span class="line"><span class="comment">// 如果TMPL_FILE_DEPR 为 _ 返回 当前模块/Tpl/Public_menu.html</span></span><br><span class="line">T(<span class="string">'Public/menu'</span>);</span><br><span class="line"><span class="comment">// 如果TMPL_TEMPLATE_SUFFIX 为.tpl 返回 当前模块/Tpl/Public/menu.tpl</span></span><br><span class="line">T(<span class="string">'Admin@Public/menu'</span>);</span><br><span class="line"><span class="comment">// 返回 Admin/View/Public/menu.html</span></span><br><span class="line">T(<span class="string">'Extend://Admin@Public/menu'</span>);</span><br><span class="line"><span class="comment">// 返回 Extend/Admin/View/Public/menu.html (Extend目录取决于AUTOLOAD_NAMESPACE中的配置）</span></span><br></pre></td></tr></table></figure>
<h1 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h1><h2 id="调试模式"><a href="#调试模式" class="headerlink" title="调试模式"></a>调试模式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 开启调试模式</span></span><br><span class="line">define(<span class="string">'APP_DEBUG'</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 定义应用目录</span></span><br><span class="line">define(<span class="string">'APP_PATH'</span>, <span class="string">'./Application/'</span>);</span><br><span class="line"><span class="comment">// 加载框架入口文件</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./ThinkPHP/ThinkPHP.php'</span>;</span><br></pre></td></tr></table></figure>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">E(<span class="string">'新增失败'</span>);</span><br><span class="line"><span class="comment">// 也可以支持异常代码（默认为0），例如：</span></span><br><span class="line">E(<span class="string">'信息录入错误'</span>,<span class="number">25</span>);</span><br></pre></td></tr></table></figure>
<p>异常模板中可以使用的异常变量有：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$e[<span class="string">'file'</span>]异常文件名</span><br><span class="line">$e[<span class="string">'line'</span>] 异常发生的文件行数</span><br><span class="line">$e[<span class="string">'message'</span>] 异常信息</span><br><span class="line">$e[<span class="string">'trace'</span>] 异常的详细Trace信息</span><br></pre></td></tr></table></figure>
<h2 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h2><p>默认情况下只是在调试模式记录日志，要在部署模式开启日志记录，必须在配置中开启<code>LOG_RECORD</code>参数，以及可以在应用配置文件中配置需要记录的日志级别，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'LOG_RECORD'</span> =&gt; <span class="keyword">true</span>, <span class="comment">// 开启日志记录</span></span><br><span class="line"><span class="string">'LOG_LEVEL'</span>  =&gt;<span class="string">'EMERG,ALERT,CRIT,ERR'</span>, <span class="comment">// 只记录EMERG ALERT CRIT ERR 错误</span></span><br></pre></td></tr></table></figure>
<h3 id="日志级别"><a href="#日志级别" class="headerlink" title="日志级别"></a>日志级别</h3><ul>
<li><strong>EMERG</strong> 严重错误，导致系统崩溃无法使用</li>
<li><strong>ALERT</strong> 警戒性错误， 必须被立即修改的错误</li>
<li><strong>CRIT</strong> 临界值错误， 超过临界值的错误</li>
<li><strong>ERR</strong> 一般性错误</li>
<li><strong>WARN</strong> 警告性错误， 需要发出警告的错误</li>
<li><strong>NOTICE</strong> 通知，程序可以运行但是还不够完美的错误</li>
<li><strong>INFO</strong> 信息，程序输出信息</li>
<li><strong>DEBUG</strong> 调试，用于调试信息</li>
<li><strong>SQL</strong> SQL语句，该级别只在调试模式开启时有效</li>
</ul>
<h3 id="手动记录"><a href="#手动记录" class="headerlink" title="手动记录"></a>手动记录</h3><ul>
<li><code>Log::record()</code> - 记录日志信息到内存</li>
<li><code>Log::save()</code> - 把保存在内存中的日志信息（用指定的记录方式）写入</li>
<li><code>Log::write()</code> - 实时写入一条日志信息</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Think\Log::record(<span class="string">'测试日志信息，这是警告级别'</span>,<span class="string">'WARN'</span>,<span class="keyword">true</span>);</span><br><span class="line">Think\Log::write(<span class="string">'测试日志信息，这是警告级别，并且实时写入'</span>,<span class="string">'WARN'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="页面Trace"><a href="#页面Trace" class="headerlink" title="页面Trace"></a>页面Trace</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 显示页面Trace信息</span></span><br><span class="line"><span class="string">'SHOW_PAGE_TRACE'</span> =&gt;<span class="keyword">true</span>,</span><br></pre></td></tr></table></figure>
<p>页面Trace的选项卡是可以定制和扩展的，默认的配置为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'TRACE_PAGE_TABS'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'base'</span>=&gt;<span class="string">'基本'</span>,</span><br><span class="line">     <span class="string">'file'</span>=&gt;<span class="string">'文件'</span>,</span><br><span class="line">     <span class="string">'think'</span>=&gt;<span class="string">'流程'</span>,</span><br><span class="line">     <span class="string">'error'</span>=&gt;<span class="string">'错误'</span>,</span><br><span class="line">     <span class="string">'sql'</span>=&gt;<span class="string">'SQL'</span>,</span><br><span class="line">     <span class="string">'debug'</span>=&gt;<span class="string">'调试'</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="Trace方法"><a href="#Trace方法" class="headerlink" title="Trace方法"></a>Trace方法</h2><p>页面<code>Trace</code>只能用于有页面输出的情况，但是<code>trace</code>方法可以用在任何情况，而且<code>trace</code>方法可以用于<code>AJAX</code>等操作。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace(<span class="string">'变量'</span>,<span class="string">'标签'</span>,<span class="string">'级别'</span>,<span class="string">'是否记录日志'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="断点调试"><a href="#断点调试" class="headerlink" title="断点调试"></a>断点调试</h3><p>凭借强大的页面<code>Trace</code>信息功能支持，ThinkPHP可以支持断点调试功能。 我们只需要在不同的位置对某个变量进行<code>trace</code>输出即可，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$blog = D(<span class="string">"Blog"</span>);</span><br><span class="line">$vo = $blog-&gt;create();</span><br><span class="line">trace($vo,<span class="string">'create vo'</span>);</span><br><span class="line">$vo = $blog-&gt;find();</span><br><span class="line">trace($vo,<span class="string">'find vo'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="性能调试"><a href="#性能调试" class="headerlink" title="性能调试"></a>性能调试</h2><p>开发过程中，有些时候为了测试性能，经常需要调试某段代码的运行时间或者内存占用开销，系统提供了G方法可以很方便的获取某个区间的运行时间和内存占用情况。 例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">G(<span class="string">'begin'</span>);</span><br><span class="line"><span class="comment">// ...其他代码段</span></span><br><span class="line">G(<span class="string">'end'</span>);</span><br><span class="line"><span class="comment">// ...也许这里还有其他代码</span></span><br><span class="line"><span class="comment">// 进行统计区间</span></span><br><span class="line"><span class="keyword">echo</span> G(<span class="string">'begin'</span>,<span class="string">'end'</span>).<span class="string">'s'</span>;</span><br></pre></td></tr></table></figure>
<p>默认的统计精度是小数点后4位，如果觉得这个统计精度不够，还可以设置例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">G(<span class="string">'begin'</span>,<span class="string">'end'</span>,<span class="number">6</span>).<span class="string">'s'</span>;</span><br></pre></td></tr></table></figure>
<p>如果你的环境支持内存占用统计的话，还可以使用G方法进行区间内存开销统计（单位为kb），例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> G(<span class="string">'begin'</span>,<span class="string">'end'</span>,<span class="string">'m'</span>).<span class="string">'kb'</span>;</span><br></pre></td></tr></table></figure>
<h2 id="错误调试"><a href="#错误调试" class="headerlink" title="错误调试"></a>错误调试</h2><p>如果需要我们可以使用E方法输出错误信息并中断执行，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输出错误信息，并中止执行</span></span><br><span class="line">E($msg);</span><br></pre></td></tr></table></figure>
<h2 id="模型调试"><a href="#模型调试" class="headerlink" title="模型调试"></a>模型调试</h2><h3 id="调试执行的SQL语句"><a href="#调试执行的SQL语句" class="headerlink" title="调试执行的SQL语句"></a>调试执行的SQL语句</h3><p>在模型操作中 ，为了更好的查明错误，经常需要查看下最近使用的SQL语句，我们可以用<code>getLastsql</code>方法来输出上次执行的sql语句。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$User = M(<span class="string">"User"</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line">$User-&gt;find(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> $User-&gt;getLastSql();</span><br><span class="line"><span class="comment">// 3.2版本中可以使用简化的方法</span></span><br><span class="line"><span class="keyword">echo</span> $User-&gt;_sql();</span><br></pre></td></tr></table></figure>
<h3 id="调试数据库错误信息"><a href="#调试数据库错误信息" class="headerlink" title="调试数据库错误信息"></a>调试数据库错误信息</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$User = M(<span class="string">"User"</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line">$result = $User-&gt;find(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">false</span> === $result)&#123;</span><br><span class="line">    <span class="keyword">echo</span> $User-&gt;getDbError();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h1><h2 id="数据缓存"><a href="#数据缓存" class="headerlink" title="数据缓存"></a>数据缓存</h2><h3 id="缓存初始化"><a href="#缓存初始化" class="headerlink" title="缓存初始化"></a>缓存初始化</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 缓存初始化</span></span><br><span class="line">S(<span class="keyword">array</span>(<span class="string">'type'</span>=&gt;<span class="string">'xcache'</span>,<span class="string">'expire'</span>=&gt;<span class="number">60</span>));</span><br></pre></td></tr></table></figure>
<h3 id="缓存设置"><a href="#缓存设置" class="headerlink" title="缓存设置"></a>缓存设置</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置缓存</span></span><br><span class="line">S(<span class="string">'name'</span>,$value);</span><br></pre></td></tr></table></figure>
<h3 id="缓存读取"><a href="#缓存读取" class="headerlink" title="缓存读取"></a>缓存读取</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取缓存</span></span><br><span class="line">$value = S(<span class="string">'name'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="缓存删除"><a href="#缓存删除" class="headerlink" title="缓存删除"></a>缓存删除</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除缓存</span></span><br><span class="line">S(<span class="string">'name'</span>,<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<h3 id="对象方式操作缓存"><a href="#对象方式操作缓存" class="headerlink" title="对象方式操作缓存"></a>对象方式操作缓存</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$cache = S(<span class="keyword">array</span>(<span class="string">'type'</span>=&gt;<span class="string">'xcache'</span>,<span class="string">'prefix'</span>=&gt;<span class="string">'think'</span>,<span class="string">'expire'</span>=&gt;<span class="number">600</span>));</span><br><span class="line">$cache-&gt;name = <span class="string">'value'</span>; <span class="comment">// 设置缓存</span></span><br><span class="line">$value = $cache-&gt;name; <span class="comment">// 获取缓存</span></span><br><span class="line"><span class="keyword">unset</span>($cache-&gt;name); <span class="comment">// 删除缓存</span></span><br></pre></td></tr></table></figure>
<h3 id="缓存队列"><a href="#缓存队列" class="headerlink" title="缓存队列"></a>缓存队列</h3><p>数据缓存可以支持缓存队列，简单的说就是可以限制缓存的数量，只需要在初始化的时候指定<code>length</code>参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S(<span class="keyword">array</span>(<span class="string">'type'</span>=&gt;<span class="string">'xcache'</span>,<span class="string">'length'</span>=&gt;<span class="number">100</span>,<span class="string">'expire'</span>=&gt;<span class="number">60</span>));</span><br></pre></td></tr></table></figure>
<h2 id="快速缓存"><a href="#快速缓存" class="headerlink" title="快速缓存"></a>快速缓存</h2><p>如果你的存储数据没有有效期的需求，那么系统还提供了一个快速缓存方法F可以用来更快的操作。</p>
<blockquote>
<p>F方法可以支持不同的存储类型，如果是文件类型的话，默认保存在DATA_PATH目录下面。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">F(<span class="string">'data'</span>,$Data);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 快速缓存Data数据，保存到指定的目录</span></span><br><span class="line">F(<span class="string">'data'</span>,$Data,TEMP_PATH);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取缓存数据</span></span><br><span class="line">$Data = F(<span class="string">'data'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除缓存数据</span></span><br><span class="line">F(<span class="string">'data'</span>,<span class="keyword">NULL</span>);</span><br></pre></td></tr></table></figure>
<p>F方法支持自动创建缓存子目录，在<code>DATA_PATH</code>目录下面缓存<code>data</code>数据，如果User子目录不存在，则自动创建：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F(<span class="string">'User/data'</span>,$Data);</span><br></pre></td></tr></table></figure>
<h2 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$Model-&gt;cache(<span class="keyword">true</span>)-&gt;where(<span class="string">'status=1'</span>)-&gt;select();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定Key</span></span><br><span class="line">$Model-&gt;cache(<span class="string">'cache_name'</span>)-&gt;select();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>指定key的方式会让查询缓存更加高效。</p>
</blockquote>
<h2 id="静态缓存"><a href="#静态缓存" class="headerlink" title="静态缓存"></a>静态缓存</h2><p>要使用静态缓存功能，需要开启<code>HTML_CACHE_ON</code>参数，并且使用<code>HTML_CACHE_RULES</code>配置参数设置静态缓存规则文件 。</p>
<h3 id="静态规则定义"><a href="#静态规则定义" class="headerlink" title="静态规则定义"></a>静态规则定义</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'HTML_CACHE_ON'</span>     =&gt;    <span class="keyword">true</span>, <span class="comment">// 开启静态缓存</span></span><br><span class="line"><span class="string">'HTML_CACHE_TIME'</span>   =&gt;    <span class="number">60</span>,   <span class="comment">// 全局静态缓存有效期（秒）</span></span><br><span class="line"><span class="string">'HTML_FILE_SUFFIX'</span>  =&gt;    <span class="string">'.shtml'</span>, <span class="comment">// 设置静态缓存文件后缀</span></span><br><span class="line"><span class="string">'HTML_CACHE_RULES'</span>  =&gt;     <span class="keyword">array</span>(  <span class="comment">// 定义静态缓存规则</span></span><br><span class="line">     <span class="comment">// 定义格式1 数组方式</span></span><br><span class="line">     <span class="string">'静态地址'</span>    =&gt;     <span class="keyword">array</span>(<span class="string">'静态规则'</span>, <span class="string">'有效期'</span>, <span class="string">'附加规则'</span>), </span><br><span class="line">     <span class="comment">// 定义格式2 字符串方式</span></span><br><span class="line">     <span class="string">'静态地址'</span>    =&gt;     <span class="string">'静态规则'</span>, </span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h1 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h1><h2 id="输入过滤"><a href="#输入过滤" class="headerlink" title="输入过滤"></a>输入过滤</h2><h3 id="使用I函数过滤"><a href="#使用I函数过滤" class="headerlink" title="使用I函数过滤"></a>使用I函数过滤</h3><p>使用系统内置的I函数是避免输入数据出现安全隐患的重要手段，I函数默认的过滤方法是<code>htmlspecialchar</code>s，如果我们需要采用其他的方法进行安全过滤，有两种方式：</p>
<ul>
<li>如果是全局的过滤方法，那么可以设置DEFAULT_FILTER，例如：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'DEFAULT_FILTER'</span>        =&gt;  <span class="string">'strip_tags'</span>,</span><br></pre></td></tr></table></figure>
<p>当然，我们也可以设置多个过滤方法，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'DEFAULT_FILTER'</span>        =&gt;  <span class="string">'strip_tags,stripslashes'</span>,</span><br></pre></td></tr></table></figure>
<ul>
<li>如果是仅需要对个别数据采用特殊的过滤方法，可以在调用I函数的时候传入过滤方法，例如：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">I(<span class="string">'post.id'</span>, <span class="number">0</span>, <span class="string">'intval'</span>); <span class="comment">// 用intval过滤$_POST['id']</span></span><br><span class="line">I(<span class="string">'get.title'</span>, <span class="string">''</span>, <span class="string">'strip_tags'</span>); <span class="comment">// 用strip_tags过滤$_GET['title']</span></span><br></pre></td></tr></table></figure>
<h3 id="写入数据过滤"><a href="#写入数据过滤" class="headerlink" title="写入数据过滤"></a>写入数据过滤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;data($data)-&gt;filter(<span class="string">'strip_tags'</span>)-&gt;add();</span><br></pre></td></tr></table></figure>
<h2 id="表单合法性检测"><a href="#表单合法性检测" class="headerlink" title="表单合法性检测"></a>表单合法性检测</h2><h3 id="配置insertFields-和-updateFields属性"><a href="#配置insertFields-和-updateFields属性" class="headerlink" title="配置insertFields 和 updateFields属性"></a>配置<code>insertFields</code> 和 <code>updateFields</code>属性</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserModel</span> <span class="keyword">extends</span> \<span class="title">Think</span>\<span class="title">Model</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $insertFields = <span class="keyword">array</span>(<span class="string">'account'</span>,<span class="string">'password'</span>,<span class="string">'nickname'</span>,<span class="string">'email'</span>);</span><br><span class="line">    <span class="keyword">protected</span> $updateFields = <span class="keyword">array</span>(<span class="string">'nickname'</span>,<span class="string">'email'</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="直接调用field方法"><a href="#直接调用field方法" class="headerlink" title="直接调用field方法"></a>直接调用field方法</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">M(<span class="string">'User'</span>)-&gt;field(<span class="string">'account,password,nickname,email'</span>)-&gt;create();</span><br></pre></td></tr></table></figure>
<h2 id="表单令牌"><a href="#表单令牌" class="headerlink" title="表单令牌"></a>表单令牌</h2><p>要启用表单令牌功能，需要配置行为绑定，在应用或者模块的配置目录下面的行为定义文件<code>tags.php</code>中，添加：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">     <span class="comment">// 添加下面一行定义即可</span></span><br><span class="line">     <span class="string">'view_filter'</span> =&gt; <span class="keyword">array</span>(<span class="string">'Behavior\TokenBuild'</span>),</span><br><span class="line">    <span class="comment">// 如果是3.2.1以上版本 需要改成</span></span><br><span class="line">    <span class="comment">// 'view_filter' =&gt; array('Behavior\TokenBuildBehavior'),</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>表示在<code>view_filter</code>标签位置执行表单令牌检测行为。</p>
<ul>
<li>表单令牌验证相关的配置参数有：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'TOKEN_ON'</span>      =&gt;    <span class="keyword">true</span>,  <span class="comment">// 是否开启令牌验证 默认关闭</span></span><br><span class="line"><span class="string">'TOKEN_NAME'</span>    =&gt;    <span class="string">'__hash__'</span>,    <span class="comment">// 令牌验证的表单隐藏字段名称，默认为__hash__</span></span><br><span class="line"><span class="string">'TOKEN_TYPE'</span>    =&gt;    <span class="string">'md5'</span>,  <span class="comment">//令牌哈希验证规则 默认为MD5</span></span><br><span class="line"><span class="string">'TOKEN_RESET'</span>   =&gt;    <span class="keyword">true</span>,  <span class="comment">//令牌验证出错后是否重置令牌 默认为true</span></span><br></pre></td></tr></table></figure>
<p>如果开启表单令牌验证功能，系统会自动在带有表单的模板文件里面自动生成以<code>TOKEN_NAME</code>为名称的隐藏域，<br>其值则是<code>TOKEN_TYPE</code>方式生成的哈希字符串，用于实现表单的自动令牌验证。</p>
<p>如果个别页面输出不希望进行表单令牌验证，可以在控制器中的输出方法之前动态关闭表单令牌验证，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C(<span class="string">'TOKEN_ON'</span>,<span class="keyword">false</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;display();</span><br></pre></td></tr></table></figure>
<p>模型类在创建数据对象的同时会自动进行表单令牌验证操作，如果你没有使用create方法创建数据对象的话，则需要手动调用模型的<code>autoCheckToken</code>方法进行表单令牌验证。<br>如果返回<code>false</code>，则表示表单令牌验证错误。例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$User = M(<span class="string">"User"</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line"><span class="comment">// 手动进行令牌验证</span></span><br><span class="line"><span class="keyword">if</span> (!$User-&gt;autoCheckToken($_POST))&#123;</span><br><span class="line"><span class="comment">// 令牌验证错误</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="防止SQL注入"><a href="#防止SQL注入" class="headerlink" title="防止SQL注入"></a>防止SQL注入</h2><ul>
<li><strong>要有效的防止SQL注入问题，我们建议：</strong></li>
</ul>
<blockquote>
<ul>
<li>查询条件尽量使用数组方式，这是更为安全的方式；</li>
<li>如果不得已必须使用字符串查询条件，使用预处理机制</li>
<li>使用自动验证和自动完成机制进行针对应用的自定义过滤；</li>
<li>如果环境允许，尽量使用PDO方式，并使用参数绑定。</li>
</ul>
</blockquote>
<h3 id="查询条件预处理"><a href="#查询条件预处理" class="headerlink" title="查询条件预处理"></a>查询条件预处理</h3><p>where方法使用字符串条件的时候，支持预处理（安全过滤），并支持两种方式传入预处理参数，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$Model-&gt;where(<span class="string">"id=%d and username='%s' and xx='%f'"</span>,<span class="keyword">array</span>($id,$username,$xx))-&gt;select();</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">$Model-&gt;where(<span class="string">"id=%d and username='%s' and xx='%f'"</span>,$id,$username,$xx)-&gt;select();</span><br></pre></td></tr></table></figure>
<h2 id="目录安全文件"><a href="#目录安全文件" class="headerlink" title="目录安全文件"></a>目录安全文件</h2><p>为了避免某些服务器开启了目录浏览权限后可以直接在浏览器输入URL地址查看目录，系统默认开启了目录安全文件机制，会在自动生成目录的时候生成空白的<code>index.html</code>文件，<br>当然安全文件的名称可以设置，例如你想给安全文件定义为<code>default.html</code>可以在入口文件中添加：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'DIR_SECURE_FILENAME'</span>, <span class="string">'default.html'</span>);</span><br><span class="line">define(<span class="string">'APP_PATH'</span>,<span class="string">'./Application/'</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="string">'./ThinkPHP/ThinkPHP.php'</span>;</span><br></pre></td></tr></table></figure>
<p>还可以支持多个安全文件写入，例如你想同时写入<code>index.html</code>和<code>index.htm</code>两个文件，以满足不同的服务器部署环境，可以这样定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'DIR_SECURE_FILENAME'</span>, <span class="string">'index.html,index.htm'</span>);</span><br></pre></td></tr></table></figure>
<p>默认的安全文件只是写入一个空白字符串，如果需要写入其他内容，可以通过<code>DIR_SECURE_CONTENT</code>参数来指定，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'DIR_SECURE_CONTENT'</span>, <span class="string">'deny Access!'</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：目录安全文件仅在第一次生成模块目录的时候生成。如果是3.2.1版本以上，则可以调用代码生成，例如：</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dirs变量是要生成安全文件的目录数组</span></span><br><span class="line">\Think\Build::buildDirSecure($dirs);</span><br></pre></td></tr></table></figure>
<h2 id="上传安全"><a href="#上传安全" class="headerlink" title="上传安全"></a>上传安全</h2><p>网站的上传功能也是一个非常容易被攻击的入口，所以对上传功能的安全检查是尤其必要的。</p>
<p>系统提供的上传类<code>Think\Upload</code>提供了安全方面的支持，包括对文件后缀、文件类型、文件大小以及上传图片文件的合法性检查，确保你已经在上传操作中启用了这些合法性检查。</p>
<h2 id="防止XSS攻击"><a href="#防止XSS攻击" class="headerlink" title="防止XSS攻击"></a>防止XSS攻击</h2><ul>
<li><strong>XSS（跨站脚本攻击）</strong> 可以用于窃取其他用户的Cookie信息，要避免此类问题，可以采用如下解决方案：<ul>
<li>直接过滤所有的JavaScript脚本；</li>
<li>转义Html元字符，使用htmlentities、htmlspecialchars等函数；</li>
<li>系统的扩展函数库提供了XSS安全过滤的remove_xss方法；</li>
<li>新版对URL访问的一些系统变量已经做了XSS处理。</li>
</ul>
</li>
</ul>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="PATH-INFO支持"><a href="#PATH-INFO支持" class="headerlink" title="PATH_INFO支持"></a>PATH_INFO支持</h2><blockquote>
<p>如果发生在本地测试正常，但是一旦部署到服务器环境后会发生只能访问首页的情况，很有可能是你的服务器或者空间不支持<code>PATH_INFO</code>所致。</p>
</blockquote>
<p>如果你的环境没有任何对应的系统变量，那么可以封装一个获取方法，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_path_info</span><span class="params">()</span></span>&#123;</span><br><span class="line">     <span class="comment">// 根据你的环境兼容获取PATH_INFO 具体代码略</span></span><br><span class="line">     <span class="keyword">return</span> $path; <span class="comment">// 直接返回获取到的PATH_INFO信息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们修改下URL_PATHINFO_FETCH参数的配置值，改为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'URL_PATHINFO_FETCH'</span>     =&gt;   <span class="string">':get_path_info'</span></span><br></pre></td></tr></table></figure>
<h2 id="URL重写"><a href="#URL重写" class="headerlink" title="URL重写"></a>URL重写</h2><h3 id="Apache"><a href="#Apache" class="headerlink" title="[ Apache ]"></a>[ Apache ]</h3><ol>
<li>httpd.conf配置文件中加载了mod_rewrite.so模块</li>
<li>AllowOverride None 将None改为 All</li>
<li>把下面的内容保存为.htaccess文件放到应用入口文件的同级目录下</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;IfModule mod_rewrite.c&gt;</span><br><span class="line"> RewriteEngine on</span><br><span class="line"> RewriteCond %&#123;REQUEST_FILENAME&#125; !-d</span><br><span class="line"> RewriteCond %&#123;REQUEST_FILENAME&#125; !-f</span><br><span class="line"> RewriteRule ^(.*)$ index.php/$<span class="number">1</span> [QSA,PT,L]</span><br><span class="line">&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="[ Nginx ]"></a>[ Nginx ]</h3><p>在Nginx低版本中，是不支持PATHINFO的，但是可以通过在Nginx.conf中配置转发规则实现：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location / &#123; <span class="comment">// …..省略部分代码</span></span><br><span class="line">    <span class="keyword">if</span> (!-e $request_filename) &#123;</span><br><span class="line">        rewrite  ^(.*)$  /index.php?s=$<span class="number">1</span>  last;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你的ThinkPHP安装在二级目录，Nginx的伪静态方法设置如下，其中youdomain是所在的目录名称。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /youdomain/ &#123;</span><br><span class="line">    <span class="keyword">if</span> (!-e $request_filename)&#123;</span><br><span class="line">        rewrite  ^/youdomain/(.*)$  /youdomain/index.php?s=$<span class="number">1</span>  last;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="替换入口"><a href="#替换入口" class="headerlink" title="替换入口"></a>替换入口</h2><blockquote>
<p>我们的建议是在生产环境中关闭调试模式后生成Lite文件。<br>注意，目前SAE平台不支持直接生成Lite文件。</p>
</blockquote>
<h3 id="生成Lite文件"><a href="#生成Lite文件" class="headerlink" title="生成Lite文件"></a>生成Lite文件</h3><p>要生成Lite文件，需要在入口文件中增加常量定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'BUILD_LITE_FILE'</span>,<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<p>默认情况下，再次运行后会在Runtime目录下面生成一个lite.php文件。</p>
<p>如果你需要修改Lite文件的位置或者名称，可以在应用配置文件中增加配置如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'RUNTIME_LITE_FILE'</span>=&gt; APP_PATH.<span class="string">'lite.php'</span></span><br></pre></td></tr></table></figure>
<p>配置后，生成的Lite文件的位置为 <code>APP_PATH.&#39;lite.php&#39;</code></p>
<p>Lite文件的编译文件内容是系统默认的，如果希望改变或者增加其他的编译文件的话，可以在外部定义编译列表文件，<br>例如： 我们在应用配置目录下面增加lite.php定义如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">    THINK_PATH.<span class="string">'Common/functions.php'</span>,</span><br><span class="line">    COMMON_PATH.<span class="string">'Common/function.php'</span>,</span><br><span class="line">    CORE_PATH . <span class="string">'Think'</span>.EXT,</span><br><span class="line">    CORE_PATH . <span class="string">'Hook'</span>.EXT,</span><br><span class="line">    CORE_PATH . <span class="string">'App'</span>.EXT,</span><br><span class="line">    CORE_PATH . <span class="string">'Dispatcher'</span>.EXT,</span><br><span class="line">    CORE_PATH . <span class="string">'Model'</span>.EXT,</span><br><span class="line">    CORE_PATH . <span class="string">'Log'</span>.EXT,</span><br><span class="line">    CORE_PATH . <span class="string">'Log/Driver/File'</span>.EXT,</span><br><span class="line">    CORE_PATH . <span class="string">'Route'</span>.EXT,</span><br><span class="line">    CORE_PATH . <span class="string">'Controller'</span>.EXT,</span><br><span class="line">    CORE_PATH . <span class="string">'View'</span>.EXT,</span><br><span class="line">    CORE_PATH . <span class="string">'Storage'</span>.EXT,</span><br><span class="line">    CORE_PATH . <span class="string">'Storage/Driver/File'</span>.EXT,</span><br><span class="line">    CORE_PATH . <span class="string">'Exception'</span>.EXT,</span><br><span class="line">    BEHAVIOR_PATH . <span class="string">'ParseTemplateBehavior'</span>.EXT,</span><br><span class="line">    BEHAVIOR_PATH . <span class="string">'ContentReplaceBehavior'</span>.EXT,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>所有在lite.php文件中定义的文件都会纳入Lite文件的编译缓存中。你还可以对生成的lite文件进行修改。</p>
<blockquote>
<p>如果你修改了框架文件和应用函数和配置文件的话，需要删除Lite文件重新生成。</p>
</blockquote>
<h3 id="替换入口-1"><a href="#替换入口-1" class="headerlink" title="替换入口"></a>替换入口</h3><p>Lite文件生成后，就可以把原来的应用入口文件中的框架入口文件修改如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'./ThinkPHP/ThinkPHP.php'</span>;</span><br><span class="line"><span class="comment">// 改成</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./Runtime/lite.php'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="替换应用入口文件"><a href="#替换应用入口文件" class="headerlink" title="替换应用入口文件"></a>替换应用入口文件</h3><p>如果你的入口文件没有其他代码和逻辑的话，还可以直接把<code>lite.php</code>文件作为应用的入口文件访问。<br>把<code>lite.php</code>文件复制到应用入口文件的相同目录，并直接改名为<code>index.php</code>即可和原来一样正常访问（原来的应用入口文件可以备份以备用于重新生成Lite文件的时候使用）。</p>
<blockquote>
<p>注意：如果你的环境或者目录位置发生变化，以及更改了核心框架和应用函数、配置等文件后，则需要重新生成Lite文件。</p>
</blockquote>
<h1 id="专题"><a href="#专题" class="headerlink" title="专题"></a>专题</h1><h2 id="session初始化设置"><a href="#session初始化设置" class="headerlink" title="session初始化设置"></a>session初始化设置</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// session赋值</span></span><br><span class="line">session(<span class="string">'name'</span>,<span class="string">'value'</span>);  <span class="comment">//设置session</span></span><br><span class="line">session(<span class="string">'user.user_id'</span>,<span class="number">10</span>);  <span class="comment">//设置session</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// session取值</span></span><br><span class="line">$value = session(<span class="string">'name'</span>);</span><br><span class="line"><span class="comment">// 获取所有的session 3.2.2版本新增</span></span><br><span class="line">$value = session();</span><br><span class="line">$value = session(<span class="string">'user.user_id'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// session删除</span></span><br><span class="line">session(<span class="string">'name'</span>,<span class="keyword">null</span>); <span class="comment">// 删除name</span></span><br><span class="line">session(<span class="string">'user.user_id'</span>,<span class="keyword">null</span>); <span class="comment">// 删除session</span></span><br><span class="line">session(<span class="keyword">null</span>); <span class="comment">// 清空当前的session</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// session判断</span></span><br><span class="line"><span class="comment">// 判断名称为name的session值是否已经设置</span></span><br><span class="line">session(<span class="string">'?name'</span>);</span><br><span class="line">session(<span class="string">'?user.user_id'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// session管理</span></span><br><span class="line">session(<span class="string">'[操作名]'</span>);</span><br><span class="line">session(<span class="string">'[pause]'</span>); <span class="comment">// 暂停session写入</span></span><br><span class="line">session(<span class="string">'[start]'</span>); <span class="comment">// 启动session</span></span><br><span class="line">session(<span class="string">'[destroy]'</span>); <span class="comment">// 销毁session</span></span><br><span class="line">session(<span class="string">'[regenerate]'</span>); <span class="comment">// 重新生成session id</span></span><br></pre></td></tr></table></figure>
<h2 id="Cookie支持"><a href="#Cookie支持" class="headerlink" title="Cookie支持"></a>Cookie支持</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cookie设置</span></span><br><span class="line">cookie(<span class="string">'name'</span>,<span class="string">'value'</span>);  <span class="comment">//设置cookie</span></span><br><span class="line">cookie(<span class="string">'name'</span>,<span class="string">'value'</span>,<span class="number">3600</span>); <span class="comment">// 指定cookie保存时间</span></span><br><span class="line">cookie(<span class="string">'name'</span>,<span class="string">'value'</span>,<span class="keyword">array</span>(<span class="string">'expire'</span>=&gt;<span class="number">3600</span>,<span class="string">'prefix'</span>=&gt;<span class="string">'think_'</span>))</span><br><span class="line">cookie(<span class="string">'name'</span>,<span class="string">'value'</span>,<span class="string">'expire=3600&amp;prefix=think_'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cookie获取</span></span><br><span class="line">$value = cookie(<span class="string">'name'</span>);</span><br><span class="line">$value = $_COOKIE[<span class="string">'name'</span>];</span><br><span class="line">$value = $_COOKIE[<span class="string">'前缀+name'</span>];</span><br><span class="line">$value = cookie();</span><br><span class="line">$value = $_COOKIE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cookie删除</span></span><br><span class="line">cookie(<span class="string">'name'</span>,<span class="keyword">null</span>);</span><br><span class="line">cookie(<span class="keyword">null</span>); <span class="comment">// 清空当前设定前缀的所有cookie值</span></span><br><span class="line">cookie(<span class="keyword">null</span>,<span class="string">'think_'</span>); <span class="comment">//  清空指定前缀的所有cookie值</span></span><br></pre></td></tr></table></figure>
<h2 id="数据分页"><a href="#数据分页" class="headerlink" title="数据分页"></a>数据分页</h2><h3 id="利用Page类和limit方法分页"><a href="#利用Page类和limit方法分页" class="headerlink" title="利用Page类和limit方法分页"></a>利用Page类和limit方法分页</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$User = M(<span class="string">'User'</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line">$count      = $User-&gt;where(<span class="string">'status=1'</span>)-&gt;count();<span class="comment">// 查询满足要求的总记录数</span></span><br><span class="line">$Page       = <span class="keyword">new</span> \Think\Page($count,<span class="number">25</span>);<span class="comment">// 实例化分页类 传入总记录数和每页显示的记录数(25)</span></span><br><span class="line">$show       = $Page-&gt;show();<span class="comment">// 分页显示输出</span></span><br><span class="line"><span class="comment">// 进行分页数据查询 注意limit方法的参数要使用Page类的属性</span></span><br><span class="line">$list = $User-&gt;where(<span class="string">'status=1'</span>)-&gt;order(<span class="string">'create_time'</span>)-&gt;limit($Page-&gt;firstRow.<span class="string">','</span>.$Page-&gt;listRows)-&gt;select();</span><br><span class="line"><span class="keyword">$this</span>-&gt;assign(<span class="string">'list'</span>,$list);<span class="comment">// 赋值数据集</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;assign(<span class="string">'page'</span>,$show);<span class="comment">// 赋值分页输出</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;display(); <span class="comment">// 输出模板</span></span><br></pre></td></tr></table></figure>
<h3 id="分页类和page方法的实现分页"><a href="#分页类和page方法的实现分页" class="headerlink" title="分页类和page方法的实现分页"></a>分页类和page方法的实现分页</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$User = M(<span class="string">'User'</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line"><span class="comment">// 进行分页数据查询 注意page方法的参数的前面部分是当前的页数使用 $_GET[p]获取</span></span><br><span class="line">$list = $User-&gt;where(<span class="string">'status=1'</span>)-&gt;order(<span class="string">'create_time'</span>)-&gt;page($_GET[<span class="string">'p'</span>].<span class="string">',25'</span>)-&gt;select();</span><br><span class="line"><span class="keyword">$this</span>-&gt;assign(<span class="string">'list'</span>,$list);<span class="comment">// 赋值数据集</span></span><br><span class="line">$count      = $User-&gt;where(<span class="string">'status=1'</span>)-&gt;count();<span class="comment">// 查询满足要求的总记录数</span></span><br><span class="line">$Page       = <span class="keyword">new</span> \Think\Page($count,<span class="number">25</span>);<span class="comment">// 实例化分页类 传入总记录数和每页显示的记录数</span></span><br><span class="line">$show       = $Page-&gt;show();<span class="comment">// 分页显示输出</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;assign(<span class="string">'page'</span>,$show);<span class="comment">// 赋值分页输出</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;display(); <span class="comment">// 输出模板</span></span><br></pre></td></tr></table></figure>
<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><ul>
<li><code>[Composer\Downloader\TransportException]</code></li>
</ul>
<blockquote>
<p>Your configuration does not allow connections to <a href="http://packagi" target="_blank" rel="noopener">http://packagi</a><br>  st.phpcomposer.com/packages.json. See <a href="https://getcomposer.org/d" target="_blank" rel="noopener">https://getcomposer.org/d</a><br>  oc/06-config.md#secure-http for details.</p>
</blockquote>
<p>解决：<a href="https://segmentfault.com/q/1010000004517793" target="_blank" rel="noopener">composer国内镜像不能使用</a></p>

        
      
    </div>

    <footer class="article-footer">
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>本文作者:  </strong>CAO XIAN LIANG</a>
          </li>
          <li class="post-copyright-link">
          <strong>本文链接:  </strong>
          <a href="/2018/10/16/Ancient-Frame-TP3-2-Notes/" target="_blank" title="远古框架 ThinkPHP3.2">http://blog.caoxl.com/2018/10/16/Ancient-Frame-TP3-2-Notes/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明:   </strong>
            本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            许可协议。转载请注明出处
          </li>
         
        </ul>
<div>

      
      
      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TP3-2/">TP3.2</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ThinkPHP3-2/">ThinkPHP3.2</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/10/20/MySQL-Index-OPT/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          MySQL 索引优化
        
      </div>
    </a>
  
  
    <a href="/2018/09/29/PHP-OPT-Redis/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">PHP操作Redis</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基础"><span class="nav-number">1.</span> <span class="nav-text">基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装ThinkPHP3-2"><span class="nav-number">1.1.</span> <span class="nav-text">安装ThinkPHP3.2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境要求"><span class="nav-number">1.2.</span> <span class="nav-text">环境要求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目录结构"><span class="nav-number">1.3.</span> <span class="nav-text">目录结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制器"><span class="nav-number">1.4.</span> <span class="nav-text">控制器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开发规范"><span class="nav-number">1.5.</span> <span class="nav-text">开发规范</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置"><span class="nav-number">2.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#读取配置"><span class="nav-number">2.1.</span> <span class="nav-text">读取配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态配置"><span class="nav-number">2.2.</span> <span class="nav-text">动态配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#架构"><span class="nav-number">3.</span> <span class="nav-text">架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#多层MVC"><span class="nav-number">3.1.</span> <span class="nav-text">多层MVC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#模型（Model）层"><span class="nav-number">3.1.1.</span> <span class="nav-text">模型（Model）层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视图（View）层"><span class="nav-number">3.1.2.</span> <span class="nav-text">视图（View）层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#控制器（Controller）层"><span class="nav-number">3.1.3.</span> <span class="nav-text">控制器（Controller）层</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CBD模式"><span class="nav-number">3.2.</span> <span class="nav-text">CBD模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Core（核心）"><span class="nav-number">3.2.1.</span> <span class="nav-text">Core（核心）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Behavior-行为"><span class="nav-number">3.2.2.</span> <span class="nav-text">Behavior (行为)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Driver（驱动）"><span class="nav-number">3.2.3.</span> <span class="nav-text">Driver（驱动）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自动加载"><span class="nav-number">3.3.</span> <span class="nav-text">自动加载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自动加载的优先级"><span class="nav-number">3.3.1.</span> <span class="nav-text">自动加载的优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手动加载第三方类库"><span class="nav-number">3.3.2.</span> <span class="nav-text">手动加载第三方类库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统流程"><span class="nav-number">3.4.</span> <span class="nav-text">系统流程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#路由"><span class="nav-number">4.</span> <span class="nav-text">路由</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#规则路由"><span class="nav-number">4.1.</span> <span class="nav-text">规则路由</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#规则表达式"><span class="nav-number">4.1.1.</span> <span class="nav-text">规则表达式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实例说明"><span class="nav-number">4.2.</span> <span class="nav-text">实例说明</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#控制器-1"><span class="nav-number">5.</span> <span class="nav-text">控制器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#前置和后置操作"><span class="nav-number">5.1.</span> <span class="nav-text">前置和后置操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#伪静态"><span class="nav-number">5.2.</span> <span class="nav-text">伪静态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#URL生成"><span class="nav-number">5.3.</span> <span class="nav-text">URL生成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AJAX返回"><span class="nav-number">5.4.</span> <span class="nav-text">AJAX返回</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#跳转和重定向"><span class="nav-number">5.5.</span> <span class="nav-text">跳转和重定向</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#页面跳转"><span class="nav-number">5.5.1.</span> <span class="nav-text">页面跳转</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重定向"><span class="nav-number">5.5.2.</span> <span class="nav-text">重定向</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#输入变量"><span class="nav-number">5.6.</span> <span class="nav-text">输入变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#获取变量"><span class="nav-number">5.6.1.</span> <span class="nav-text">获取变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变量修饰符"><span class="nav-number">5.6.2.</span> <span class="nav-text">变量修饰符</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#请求类型"><span class="nav-number">5.7.</span> <span class="nav-text">请求类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#空操作"><span class="nav-number">5.8.</span> <span class="nav-text">空操作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模型"><span class="nav-number">6.</span> <span class="nav-text">模型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#模型定义"><span class="nav-number">6.1.</span> <span class="nav-text">模型定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模型实例化"><span class="nav-number">6.2.</span> <span class="nav-text">模型实例化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#D方法实例化"><span class="nav-number">6.2.1.</span> <span class="nav-text">D方法实例化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#切换数据库"><span class="nav-number">6.3.</span> <span class="nav-text">切换数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#连贯操作"><span class="nav-number">6.4.</span> <span class="nav-text">连贯操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lock"><span class="nav-number">6.4.1.</span> <span class="nav-text">lock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fetchSql"><span class="nav-number">6.4.2.</span> <span class="nav-text">fetchSql</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#token"><span class="nav-number">6.4.3.</span> <span class="nav-text">token</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#strict"><span class="nav-number">6.4.4.</span> <span class="nav-text">strict</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#index"><span class="nav-number">6.4.5.</span> <span class="nav-text">index</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询语言"><span class="nav-number">6.5.</span> <span class="nav-text">查询语言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL查询"><span class="nav-number">6.5.1.</span> <span class="nav-text">SQL查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#QUERY方法"><span class="nav-number">6.5.1.1.</span> <span class="nav-text">QUERY方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EXECUTE方法"><span class="nav-number">6.5.1.2.</span> <span class="nav-text">EXECUTE方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态查询"><span class="nav-number">6.5.2.</span> <span class="nav-text">动态查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#getBy动态查询"><span class="nav-number">6.5.2.1.</span> <span class="nav-text">getBy动态查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getFieldBy动态查询"><span class="nav-number">6.5.2.2.</span> <span class="nav-text">getFieldBy动态查询</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#子查询"><span class="nav-number">6.5.3.</span> <span class="nav-text">子查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自动验证"><span class="nav-number">6.6.</span> <span class="nav-text">自动验证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#动态验证"><span class="nav-number">6.6.1.</span> <span class="nav-text">动态验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参数绑定"><span class="nav-number">6.7.</span> <span class="nav-text">参数绑定</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#手动绑定"><span class="nav-number">6.7.1.</span> <span class="nav-text">手动绑定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自动绑定"><span class="nav-number">6.7.2.</span> <span class="nav-text">自动绑定</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关联模型"><span class="nav-number">6.8.</span> <span class="nav-text">关联模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关联关系"><span class="nav-number">6.8.1.</span> <span class="nav-text">关联关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HAS-ONE"><span class="nav-number">6.8.2.</span> <span class="nav-text">HAS_ONE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BELONGS-TO"><span class="nav-number">6.8.3.</span> <span class="nav-text">BELONGS_TO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HAS-MANY"><span class="nav-number">6.8.4.</span> <span class="nav-text">HAS_MANY</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MANY-TO-MANY"><span class="nav-number">6.8.5.</span> <span class="nav-text">MANY_TO_MANY</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关联删除"><span class="nav-number">6.8.6.</span> <span class="nav-text">关联删除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高级模型"><span class="nav-number">6.9.</span> <span class="nav-text">高级模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#字段过滤"><span class="nav-number">6.9.1.</span> <span class="nav-text">字段过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化字段"><span class="nav-number">6.9.2.</span> <span class="nav-text">序列化字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文本字段"><span class="nav-number">6.9.3.</span> <span class="nav-text">文本字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#只读字段"><span class="nav-number">6.9.4.</span> <span class="nav-text">只读字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#悲观锁（-Pessimistic-Locking-）"><span class="nav-number">6.9.5.</span> <span class="nav-text">悲观锁（ Pessimistic Locking ）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#乐观锁（-Optimistic-Locking-）"><span class="nav-number">6.9.6.</span> <span class="nav-text">乐观锁（ Optimistic Locking ）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据分表"><span class="nav-number">6.9.7.</span> <span class="nav-text">数据分表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mongo模型"><span class="nav-number">6.10.</span> <span class="nav-text">Mongo模型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#视图"><span class="nav-number">7.</span> <span class="nav-text">视图</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#模板赋值"><span class="nav-number">7.1.</span> <span class="nav-text">模板赋值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模板渲染"><span class="nav-number">7.2.</span> <span class="nav-text">模板渲染</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取模板地址"><span class="nav-number">7.3.</span> <span class="nav-text">获取模板地址</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#调试"><span class="nav-number">8.</span> <span class="nav-text">调试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#调试模式"><span class="nav-number">8.1.</span> <span class="nav-text">调试模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#异常处理"><span class="nav-number">8.2.</span> <span class="nav-text">异常处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志记录"><span class="nav-number">8.3.</span> <span class="nav-text">日志记录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#日志级别"><span class="nav-number">8.3.1.</span> <span class="nav-text">日志级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手动记录"><span class="nav-number">8.3.2.</span> <span class="nav-text">手动记录</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面Trace"><span class="nav-number">8.4.</span> <span class="nav-text">页面Trace</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Trace方法"><span class="nav-number">8.5.</span> <span class="nav-text">Trace方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#断点调试"><span class="nav-number">8.5.1.</span> <span class="nav-text">断点调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#性能调试"><span class="nav-number">8.6.</span> <span class="nav-text">性能调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#错误调试"><span class="nav-number">8.7.</span> <span class="nav-text">错误调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模型调试"><span class="nav-number">8.8.</span> <span class="nav-text">模型调试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#调试执行的SQL语句"><span class="nav-number">8.8.1.</span> <span class="nav-text">调试执行的SQL语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调试数据库错误信息"><span class="nav-number">8.8.2.</span> <span class="nav-text">调试数据库错误信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#缓存"><span class="nav-number">9.</span> <span class="nav-text">缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据缓存"><span class="nav-number">9.1.</span> <span class="nav-text">数据缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存初始化"><span class="nav-number">9.1.1.</span> <span class="nav-text">缓存初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存设置"><span class="nav-number">9.1.2.</span> <span class="nav-text">缓存设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存读取"><span class="nav-number">9.1.3.</span> <span class="nav-text">缓存读取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存删除"><span class="nav-number">9.1.4.</span> <span class="nav-text">缓存删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对象方式操作缓存"><span class="nav-number">9.1.5.</span> <span class="nav-text">对象方式操作缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存队列"><span class="nav-number">9.1.6.</span> <span class="nav-text">缓存队列</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速缓存"><span class="nav-number">9.2.</span> <span class="nav-text">快速缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询缓存"><span class="nav-number">9.3.</span> <span class="nav-text">查询缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#静态缓存"><span class="nav-number">9.4.</span> <span class="nav-text">静态缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#静态规则定义"><span class="nav-number">9.4.1.</span> <span class="nav-text">静态规则定义</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安全"><span class="nav-number">10.</span> <span class="nav-text">安全</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#输入过滤"><span class="nav-number">10.1.</span> <span class="nav-text">输入过滤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用I函数过滤"><span class="nav-number">10.1.1.</span> <span class="nav-text">使用I函数过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#写入数据过滤"><span class="nav-number">10.1.2.</span> <span class="nav-text">写入数据过滤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表单合法性检测"><span class="nav-number">10.2.</span> <span class="nav-text">表单合法性检测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置insertFields-和-updateFields属性"><span class="nav-number">10.2.1.</span> <span class="nav-text">配置insertFields 和 updateFields属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#直接调用field方法"><span class="nav-number">10.2.2.</span> <span class="nav-text">直接调用field方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表单令牌"><span class="nav-number">10.3.</span> <span class="nav-text">表单令牌</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#防止SQL注入"><span class="nav-number">10.4.</span> <span class="nav-text">防止SQL注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查询条件预处理"><span class="nav-number">10.4.1.</span> <span class="nav-text">查询条件预处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目录安全文件"><span class="nav-number">10.5.</span> <span class="nav-text">目录安全文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#上传安全"><span class="nav-number">10.6.</span> <span class="nav-text">上传安全</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#防止XSS攻击"><span class="nav-number">10.7.</span> <span class="nav-text">防止XSS攻击</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署"><span class="nav-number">11.</span> <span class="nav-text">部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#PATH-INFO支持"><span class="nav-number">11.1.</span> <span class="nav-text">PATH_INFO支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#URL重写"><span class="nav-number">11.2.</span> <span class="nav-text">URL重写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Apache"><span class="nav-number">11.2.1.</span> <span class="nav-text">[ Apache ]</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx"><span class="nav-number">11.2.2.</span> <span class="nav-text">[ Nginx ]</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#替换入口"><span class="nav-number">11.3.</span> <span class="nav-text">替换入口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#生成Lite文件"><span class="nav-number">11.3.1.</span> <span class="nav-text">生成Lite文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#替换入口-1"><span class="nav-number">11.3.2.</span> <span class="nav-text">替换入口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#替换应用入口文件"><span class="nav-number">11.3.3.</span> <span class="nav-text">替换应用入口文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#专题"><span class="nav-number">12.</span> <span class="nav-text">专题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#session初始化设置"><span class="nav-number">12.1.</span> <span class="nav-text">session初始化设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cookie支持"><span class="nav-number">12.2.</span> <span class="nav-text">Cookie支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据分页"><span class="nav-number">12.3.</span> <span class="nav-text">数据分页</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#利用Page类和limit方法分页"><span class="nav-number">12.3.1.</span> <span class="nav-text">利用Page类和limit方法分页</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分页类和page方法的实现分页"><span class="nav-number">12.3.2.</span> <span class="nav-text">分页类和page方法的实现分页</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#常见问题"><span class="nav-number">13.</span> <span class="nav-text">常见问题</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2017 - 2019 Keep It Simple And Stupid All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



<script src="/js/scripts.js"></script>




  <script src="/js/dialog.js"></script>








	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Keep It Simple And Stupid
          </div>
          <div class="panel-body">
            Copyright © 2019 CAO XIAN LIANG All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>