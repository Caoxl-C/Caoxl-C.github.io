<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>基于laravel使用elasticsearch | Keep It Simple And Stupid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="LaravelElasticSearch" />
  
  
  
  
  <meta name="description" content="废话不多说,直接上代码 环境 PHP 7.2+ MySQL 5.7 ElasticSearch 6.7.2 Laravel 5.8">
<meta property="og:type" content="article">
<meta property="og:title" content="基于Laravel使用ElasticSearch">
<meta property="og:url" content="http://blog.caoxl.com/2019/07/09/Laravel-ElasticSearch/index.html">
<meta property="og:site_name" content="Keep It Simple And Stupid">
<meta property="og:description" content="废话不多说,直接上代码 环境 PHP 7.2+ MySQL 5.7 ElasticSearch 6.7.2 Laravel 5.8">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-07-09T08:54:33.000Z">
<meta property="article:modified_time" content="2019-09-02T07:28:46.000Z">
<meta property="article:author" content="CAO XIAN LIANG">
<meta property="article:tag" content="Laravel">
<meta property="article:tag" content="ElasticSearch">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Keep It Simple And Stupid" type="application/atom+xml">
  

  

  <link rel="icon" href="https://images.unsplash.com/photo-1643801026603-63d4f50be313?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=767&q=80">
  <link rel="apple-touch-icon" href="/https://images.unsplash.com/photo-1643801026603-63d4f50be313?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=767&q=80">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>

  
<script src="/js/bootstrap.js"></script>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    
<link rel="stylesheet" href="/css/dialog.css">

  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  

<style type="text/css">
.spoiler {
  display: inline-flex;
}
p.spoiler {
  display: flex;
}
.spoiler a {
  pointer-events: none;
}
.spoiler-blur, .spoiler-blur > * {
  transition: text-shadow .5s ease;
}
.spoiler .spoiler-blur, .spoiler .spoiler-blur > * {
  color: rgba(0, 0, 0, 0);
  background-color: rgba(0, 0, 0, 0);
  text-shadow: 0 0 10px grey;
  cursor: pointer;
}
.spoiler .spoiler-blur:hover, .spoiler .spoiler-blur:hover > * {
  text-shadow: 0 0 5px grey;
}
.spoiler-box, .spoiler-box > * {
  transition: color .5s ease,
  background-color .5s ease;
}
.spoiler .spoiler-box, .spoiler .spoiler-box > * {
  color: black;
  background-color: black;
  text-shadow: none;
}</style><meta name="generator" content="Hexo 6.3.0"></head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="https://images.unsplash.com/photo-1643801026603-63d4f50be313?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=767&q=80">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">分类</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-Laravel-ElasticSearch" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      基于Laravel使用ElasticSearch
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/07/09/Laravel-ElasticSearch/" class="article-date">
	  <time datetime="2019-07-09T08:54:33.000Z" itemprop="datePublished">2019-07-09</time>
	</a>

      
    <a class="article-category-link" href="/categories/%E5%8A%A0%E5%88%86%E6%8A%80%E8%83%BD/">加分技能</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>

    <div class="article-entry" itemprop="articleBody">
      
        
        
          <h2 id="废话不多说-直接上代码"><a href="#废话不多说-直接上代码" class="headerlink" title="废话不多说,直接上代码"></a>废话不多说,直接上代码</h2><ul>
<li>环境<ul>
<li><code>PHP 7.2+</code></li>
<li><code>MySQL 5.7</code></li>
<li><code>ElasticSearch 6.7.2</code></li>
<li><code>Laravel 5.8</code></li>
</ul>
</li>
</ul>
<span id="more"></span>

<h2 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h2><ul>
<li><code>App\Console\Commands</code></li>
</ul>
<h3 id="CreateIndex"><a href="#CreateIndex" class="headerlink" title="CreateIndex"></a>CreateIndex</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Console</span>\<span class="title class_">Commands</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Common</span>\<span class="title">ElasticSearchService</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Class CreateIndex</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span> App\Console\Commands</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateIndex</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$es</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name and signature of the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$signature</span> = <span class="string">&#x27;es:create &#123;index_name : The name of index which will be created&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The console command description.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$description</span> = <span class="string">&#x27;Create an ElasticSearch index&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * CreateIndex constructor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ElasticSearchService $elastic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">ElasticSearchService <span class="variable">$elastic</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;es = <span class="variable">$elastic</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$index_name</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">argument</span>(<span class="string">&#x27;index_name&#x27;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">info</span>(<span class="string">&quot;trying to create index <span class="subst">$index_name</span>&quot;</span>);</span><br><span class="line">        <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;es-&gt;<span class="title function_ invoke__">createIndex</span>(<span class="variable">$index_name</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$ret</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">info</span>(<span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;failed&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan es:create test_create</span><br><span class="line">trying to create index test_create</span><br><span class="line">success</span><br></pre></td></tr></table></figure>

<h3 id="UpdateIndex"><a href="#UpdateIndex" class="headerlink" title="UpdateIndex"></a>UpdateIndex</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Console</span>\<span class="title class_">Commands</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Common</span>\<span class="title">ElasticSearchService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateIndex</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$es</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name and signature of the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$signature</span> = <span class="string">&quot;es:update </span></span><br><span class="line"><span class="string">                            &#123;--index=_ : The names of index to be updated&#125;</span></span><br><span class="line"><span class="string">                            &#123;--type=_ : The type of the index&#125;</span></span><br><span class="line"><span class="string">                            &#123;--all : Update all indices&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The console command description.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$description</span> = <span class="string">&#x27;Update the ElasticSearch index&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * UpdateIndex constructor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ElasticSearchService $elastic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">ElasticSearchService <span class="variable">$elastic</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;es = <span class="variable">$elastic</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$index_name</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">option</span>(<span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">        <span class="variable">$type_name</span>  = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">option</span>(<span class="string">&#x27;type&#x27;</span>);</span><br><span class="line">        <span class="variable">$update_all</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">option</span>(<span class="string">&#x27;all&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$update_all</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">info</span>(<span class="string">&#x27;try to update all indices&#x27;</span>);</span><br><span class="line">            <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;es-&gt;<span class="title function_ invoke__">updateAllIndex</span>();</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$ret</span> === <span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">info</span>(<span class="string">&#x27;successfully updated&#x27;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$ret</span> <span class="keyword">as</span> <span class="variable">$item</span>) &#123;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&quot;fail to update index $&#123;item[&#x27;index&#x27;]&#125;:$&#123;item[&#x27;type&#x27;]&#125;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$index_name</span>) || <span class="keyword">empty</span>(<span class="variable">$type_name</span>) ||</span><br><span class="line">                <span class="string">&#x27;_&#x27;</span> == <span class="variable">$index_name</span> || <span class="string">&#x27;_&#x27;</span> == <span class="variable">$type_name</span></span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;run with --all to update all indices, or run with --index_name and --type_name to update one index&#x27;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">info</span>(<span class="string">&quot;try to update ElasticSearch index <span class="subst">$index_name</span>:<span class="subst">$type_name</span>&quot;</span>);</span><br><span class="line">                <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;es-&gt;<span class="title function_ invoke__">updateIndex</span>(<span class="variable">$index_name</span>, <span class="variable">$type_name</span>);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="variable">$ret</span>) &#123;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&quot;fail to update ElasticSearch index <span class="subst">$index_name</span>:<span class="subst">$type_name</span>&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">info</span>(<span class="string">&quot;<span class="subst">$index_name</span>:<span class="subst">$type_name</span> successful updated&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan <span class="keyword">e</span><span class="variable">s:update</span> --<span class="keyword">all</span></span><br><span class="line"><span class="keyword">try</span> <span class="keyword">to</span> <span class="keyword">update</span> <span class="keyword">all</span> indices</span><br><span class="line">successfully updated</span><br></pre></td></tr></table></figure>

<h3 id="ClearIndex"><a href="#ClearIndex" class="headerlink" title="ClearIndex"></a>ClearIndex</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Console</span>\<span class="title class_">Commands</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Common</span>\<span class="title">ElasticSearchService</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClearIndex</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$es</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name and signature of the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$signature</span> = <span class="string">&#x27;es:clear &#123;index_name : The name of index to be cleared&#125;</span></span><br><span class="line"><span class="string">                                     &#123;--yes : Confirm to clear the index&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The console command description.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$description</span> = <span class="string">&#x27;clear an ElasticSearch index&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ClearIndex constructor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ElasticSearchService $elastic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">ElasticSearchService <span class="variable">$elastic</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;es = <span class="variable">$elastic</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$index_name</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">argument</span>(<span class="string">&#x27;index_name&#x27;</span>);</span><br><span class="line">        <span class="variable">$yes</span>        = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">option</span>(<span class="string">&#x27;yes&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$yes</span>) &#123;</span><br><span class="line">            <span class="variable">$yes</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">confirm</span>(<span class="string">&quot;are you sure to clear the index <span class="subst">$index_name</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$yes</span>) &#123;</span><br><span class="line">            <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;es-&gt;<span class="title function_ invoke__">clearIndex</span>(<span class="variable">$index_name</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$ret</span>) &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">info</span>(<span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;failed&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">warn</span>(<span class="string">&#x27;aborted&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h4><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> php artisan es:clear test_index --<span class="keyword">yes</span></span><br><span class="line">success</span><br></pre></td></tr></table></figure>

<h3 id="DropIndex"><a href="#DropIndex" class="headerlink" title="DropIndex"></a>DropIndex</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Console</span>\<span class="title class_">Commands</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Common</span>\<span class="title">ElasticSearchService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DropIndex</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$es</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name and signature of the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$signature</span> = <span class="string">&quot;es:drop &#123;index_name : The name of index to be dropped&#125; </span></span><br><span class="line"><span class="string">                                    &#123;--yes : Confirm the drop&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The console command description.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$description</span> = <span class="string">&#x27;Drop/Delete an ElasticSearch index&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DropIndex constructor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ElasticSearchService $elastic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">ElasticSearchService <span class="variable">$elastic</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;es = <span class="variable">$elastic</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$index_name</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">argument</span>(<span class="string">&#x27;index_name&#x27;</span>);</span><br><span class="line">        <span class="variable">$yes</span>        = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">option</span>(<span class="string">&#x27;yes&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$yes</span>) &#123;</span><br><span class="line">            <span class="variable">$yes</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">confirm</span>(<span class="string">&quot;Are you sure to drop the index <span class="subst">$index_name</span> ?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$yes</span>) &#123;</span><br><span class="line">            <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;es-&gt;<span class="title function_ invoke__">dropIndex</span>(<span class="variable">$index_name</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$ret</span>) &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">info</span>(<span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;failed&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">warn</span>(<span class="string">&#x27;aborted&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-3"><a href="#使用-3" class="headerlink" title="使用"></a>使用</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan es:drop test_create</span><br><span class="line"></span><br><span class="line"> Are you sure to drop the index test_create ? (yes/no) [no]:</span><br><span class="line"> &gt; yes</span><br><span class="line"></span><br><span class="line">success</span><br></pre></td></tr></table></figure>

<h3 id="ListIndex"><a href="#ListIndex" class="headerlink" title="ListIndex"></a>ListIndex</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Console</span>\<span class="title class_">Commands</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Common</span>\<span class="title">ElasticSearchService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListIndex</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$es</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name and signature of the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$signature</span> = <span class="string">&#x27;es:list&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The console command description.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$description</span> = <span class="string">&#x27;List all indices&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ListIndex constructor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ElasticSearchService $elastic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">ElasticSearchService <span class="variable">$elastic</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;es = <span class="variable">$elastic</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ret</span>   = <span class="variable language_">$this</span>-&gt;es-&gt;<span class="title function_ invoke__">listIndex</span>();</span><br><span class="line">        <span class="variable">$count</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="string">&#x27;#:&lt;index_name&gt;, &lt;last updated time&gt;&#x27;</span> . PHP_EOL);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$ret</span>[<span class="string">&#x27;hits&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$ret</span>[<span class="string">&#x27;hits&#x27;</span>] <span class="keyword">as</span> <span class="variable">$hit</span>) &#123;</span><br><span class="line">                <span class="variable">$count</span>++;</span><br><span class="line">                <span class="variable">$updated_time</span> = <span class="title function_ invoke__">strftime</span>(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>, <span class="variable">$hit</span>[<span class="string">&#x27;_source&#x27;</span>][<span class="string">&#x27;last_updated&#x27;</span>]);</span><br><span class="line">                <span class="title function_ invoke__">print_r</span>(<span class="string">&quot;<span class="subst">$count</span> : <span class="subst">&#123;$hit[&#x27;_source&#x27;][&#x27;index_name&#x27;]&#125;</span>, <span class="subst">$updated_time</span>\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-4"><a href="#使用-4" class="headerlink" title="使用"></a>使用</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">php</span> <span class="string">artisan</span> <span class="string">es:list</span></span><br><span class="line"><span class="comment">#:&lt;index_name&gt;, &lt;last updated time&gt;</span></span><br><span class="line"><span class="attr">1 :</span> <span class="string">help_center,</span> <span class="number">1970-01-01 08:00:00</span></span><br><span class="line"><span class="attr">2 :</span> <span class="string">test_index_1,</span> <span class="number">1970-01-01 08:00:00</span></span><br></pre></td></tr></table></figure>

<h3 id="QueryIndex"><a href="#QueryIndex" class="headerlink" title="QueryIndex"></a>QueryIndex</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Console</span>\<span class="title class_">Commands</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Common</span>\<span class="title">ElasticSearchService</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueryIndex</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$es</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name and signature of the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$signature</span> = <span class="string">&quot;es:query</span></span><br><span class="line"><span class="string">                            &#123;--index= : The index to query in&#125;</span></span><br><span class="line"><span class="string">                            &#123;--type= : The type of index to query&#125;</span></span><br><span class="line"><span class="string">                            &#123;--page=1 : The page of results&#125;</span></span><br><span class="line"><span class="string">                            &#123;query : The query to execute&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The console command description.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$description</span> = <span class="string">&#x27;Query something of the specified index&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * QueryIndex constructor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ElasticSearchService $elastic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">ElasticSearchService <span class="variable">$elastic</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;es = <span class="variable">$elastic</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$index_name</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">option</span>(<span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">        <span class="variable">$type_name</span>  = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">option</span>(<span class="string">&#x27;type&#x27;</span>);</span><br><span class="line">        <span class="variable">$page_no</span>    = <span class="title function_ invoke__">intval</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">option</span>(<span class="string">&#x27;page&#x27;</span>));</span><br><span class="line">        <span class="variable">$query</span>      = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">argument</span>(<span class="string">&#x27;query&#x27;</span>);</span><br><span class="line">        <span class="variable">$ret</span>        = <span class="variable language_">$this</span>-&gt;es-&gt;<span class="title function_ invoke__">queryIndex</span>(<span class="variable">$index_name</span>, <span class="variable">$type_name</span>, <span class="variable">$query</span>, <span class="variable">$page_no</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="variable">$ret</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-5"><a href="#使用-5" class="headerlink" title="使用"></a>使用</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan es:query <span class="attribute">--index</span>=game_name <span class="attribute">--type</span>=text <span class="attribute">title</span>=聚宝盆</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [total] =&gt; 0</span><br><span class="line">    [hits] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><ul>
<li><code>App\Services\Common\ElasticSearchService</code></li>
</ul>
<pre><code>    &lt;?php
    
    namespace App\Services\Common;
    
    use Elasticsearch\ClientBuilder;
    use App\Concerns\Singleton;
    use App\Support\LogTool;
    use Illuminate\Support\Facades\DB;
    
    class ElasticSearchService
    &#123;
        use Singleton;
    
        const BGC_FUN_META    = &#39;bgc_fun_meta&#39;;
        const SEARCH_HOT_WORD = &#39;bgc_fun_hot_word&#39;;
    
        const DEFAULT_PAGE_SIZE = 10;
        const DEFAULT_BULK_SIZE = 10000;
    
        protected $config;
        protected $client;
    
        protected static $internal_indices = [
            self::BGC_FUN_META,
        ];
    
        /**
         * ElasticSearchService constructor.
         * @param array|null $config
         */
        public function __construct(array $config = null)
        &#123;
            // 获取ES主机信息
            if (is_null($config)) &#123;
                $this-&gt;config = config(&#39;search-engine.elastic&#39;);
            &#125; else &#123;
                $this-&gt;config = $config;
            &#125;
    
            // 构建ES客户端对象
            $this-&gt;client = ClientBuilder::create()
                -&gt;setHosts($this-&gt;config[&#39;hosts&#39;])
                -&gt;setRetries(3)
                -&gt;build();
        &#125;
    
        /**
         * 创建索引
         * @param string $index_name
         * @return bool
         */
        public function createIndex(string $index_name)
        &#123;
            // 创建ES节点
            $nodes = $this-&gt;client-&gt;nodes();
            // 节点信息
            $nodes_stat = $nodes-&gt;stats();
    
            // 判断ES节点是否创建成功
            if (!isset($nodes_stat[&#39;_nodes&#39;]) ||
                ($num_nodes = $nodes_stat[&#39;_nodes&#39;][&#39;successful&#39;]) &lt; 1) &#123;
                LogTool::error(&quot;try to create index $index_name without valid nodes.&quot;);
    
                return false;
            &#125;
    
            // 索引文档
            $param = [
                // 索引名称
                &#39;index&#39; =&gt; $index_name,
                &#39;body&#39; =&gt; [
                    // 包含有关索引（分片数量等）以及分析器的配置
                    &#39;settings&#39; =&gt; [
                        &#39;number_of_replicas&#39; =&gt; ($num_nodes &gt; 1 ? 1 : 0),
                        // 包含标记器，过滤器，字符过滤器和分析器
                        &#39;analysis&#39; =&gt; [
                            // 动态模板，应用于没有显式映射的所有字段
                            &#39;default&#39; =&gt; [
                                //&#39;type&#39; =&gt; &#39;ik_max_word&#39;, // 中文分词
                                &#39;type&#39; =&gt; &#39;standard&#39;,
                            ],
                        ],
                    ],
                ],
            ];
    
            $config = config(&quot;search-engine.elastic.db_mapping.&#123;$index_name&#125;&quot;);
            if (isset($config[&#39;mappings&#39;])) &#123;
                $param[&#39;body&#39;][&#39;mappings&#39;] = $config[&#39;mappings&#39;];
            &#125;
    
            // 创建一个索引
            $resp = $this-&gt;client-&gt;indices()-&gt;create($param);
    
            // 判断索引创建是否确认
            $success = $this-&gt;is_acknowledged($resp);
            if (!$success) &#123;
                LogTool::error(&quot;fail to create index $index_name&quot;);
            &#125;
            if (!in_array($index_name, static::$internal_indices)) &#123;
                // 更新索引文档
                $success = $this-&gt;updateIndexDoc(static::BGC_FUN_META, &#39;_doc&#39;, $index_name, [
                    &#39;index_name&#39; =&gt; $index_name,
                    &#39;last_updated&#39; =&gt; 0,
                ]);
            &#125;
    
            return $success;
        &#125;
    
        /**
         * 删除索引
         * @param string $index_name
         * @return bool
         */
        public function dropIndex(string $index_name)
        &#123;
            $param = [
                &#39;index&#39; =&gt; $index_name,
            ];
            $resp = $this-&gt;client-&gt;indices()-&gt;delete($param);
            $success = $this-&gt;is_acknowledged($resp);
            if (!$success) &#123;
                LogTool::error(&quot;fail to drop index $index_name&quot;);
            &#125; elseif (strcmp($index_name, static::BGC_FUN_META) != 0) &#123;
                LogTool::error(&quot;index $index_name dropped&quot;);
                $this-&gt;dropIndexDoc(static::BGC_FUN_META, &#39;_doc&#39;, $index_name);
            &#125;
    
            return $success;
        &#125;
    
        /**
         * 清除索引并删除索引中所有条目
         * @param string $index_name
         * @return bool
         */
        public function clearIndex(string $index_name)
        &#123;
            $param = [
                &#39;index&#39; =&gt; $index_name,
                &#39;body&#39;  =&gt; [
                    &#39;query&#39; =&gt; [
                        &#39;match_all&#39; =&gt; new \stdClass(),
                    ],
                ],
            ];
    
            $resp    = $this-&gt;client-&gt;deleteByQuery($param);
            $success = isset($resp[&#39;deleted&#39;]);
            if (!$success) &#123;
                LogTool::error(&quot;fail to clear index $index_name&quot;);
            &#125; else &#123;
                LogTool::info(&quot;index $index_name cleared.&quot;);
            &#125;
    
            return $success;
        &#125;
    
        /**
         * 根据数据库记录更新索引
         * @param string $index_name
         * @param string $type
         * @return bool
         */
        public function updateIndex(string $index_name, string $type = &#39;text&#39;)
        &#123;
            $config = config(&quot;search-engine.elastic.db_mapping&quot;);
    
            if (is_null($config)) &#123;
                LogTool::warning(&quot;try to update unregistered index $index_name, please make sure the index is configured.&quot;);
    
                return false;
            &#125;
    
            // 获取数据库映射
            list(, $sql) = $this-&gt;get_db_mapping($index_name);
            // 没有数据库映射,返回OK
            if (null === $sql) return true;
    
            // 获取索引的更新时间
            $update_time = $this-&gt;update_time4index($index_name);
            if (false === $update_time) &#123;
                LogTool::info(&quot;try to update index $index_name, it is up to date.&quot;);
    
                return true;
            &#125;
    
            $page_no = 1;
            $page_size = static::DEFAULT_BULK_SIZE;
            $binding = [
                &#39;count&#39; =&gt; $page_size
            ];
    
            $ret = true;
            $this-&gt;createIndex($index_name);
    
            do &#123;
                $binding[&#39;offset&#39;] = ($page_no - 1) * $page_size;
                $data = DB::select($sql, $binding);
                if (count($data) &gt; 0) &#123;
                    $ret = $this-&gt;bulk_update_index($index_name, $type, $data);
                &#125;
                $page_no++;
            &#125; while (count($data) &gt; 0 &amp;&amp; $ret);
    
            if ($ret) &#123;
                LogTool::info(&quot;index $index_name is updated.&quot;);
                $ret = $this-&gt;updateIndexDoc(static::BGC_FUN_META, &#39;_doc&#39;, $index_name, [
                    &#39;index_name&#39; =&gt; $index_name,
                    &#39;last_updated&#39; =&gt; $update_time,
                ]);
            &#125; else &#123;
                LogTool::error(&quot;fail to update $index_name&quot;);
            &#125;
    
            return $ret;
        &#125;
    
        /**
         * 更新所有索引
         * @return array|bool
         */
        public function updateAllIndex()
        &#123;
            $index_failed = [];
            $config = config(&quot;search-engine.elastic.db_mapping&quot;);
            foreach ($config as $index_name =&gt; $index_config) &#123;
                if (!isset($index_config[&#39;mappings&#39;])) &#123;
                    $mappings = [&#39;_doc&#39; =&gt; 0];
                &#125; else &#123;
                    $mappings = $index_config[&#39;mappings&#39;];
                &#125;
                foreach ($mappings as $type_name =&gt; $type_config) &#123;
                    if (!$this-&gt;updateIndex($index_name, $type_name)) &#123;
                        $index_failed[] = [&#39;index&#39; =&gt; $index_name, &#39;type&#39; =&gt; $type_name];
                    &#125;
                &#125;
            &#125;
    
            return count($index_failed) &gt; 0 ? $index_failed : true;
        &#125;
    
        /**
         * 查询索引中的内容
         * @param string $index_name
         * @param string $type
         * @param string $query
         * @param int $page
         * @param int $page_size
         * @param bool $exact
         * @param bool $collect_source
         * @param callable|null $cb
         * @return array|mixed
         */
        public function queryIndex(
            string $index_name,
            string $type,
            string $query,
            int $page = 1,
            int $page_size = self::DEFAULT_PAGE_SIZE,
            bool $exact = false,
            bool $collect_source = false,
            callable $cb = null
        ) &#123;
            if (strlen($query) &gt; 0) &#123;
                [$query_param, $query_words] = $this-&gt;parse_query($query, $exact);
            &#125; else &#123;
                [$query_param, $query_words] = [[&#39;match_all&#39; =&gt; new \stdClass()], [&#39;&#39;]];
            &#125;
            $query_body = [&#39;query&#39; =&gt; $query_param];
    
            $config = config(&quot;search-query.&#123;$index_name&#125;&quot;);
            if (null !== $config) &#123;
                $query_body = array_merge($query_body, $config[&#39;body&#39;]);
            &#125;
    
            return $this-&gt;queryIndexWithClause(
                $index_name, $type, $query_body, $query_words, $page, $page_size, $collect_source, $cb
            );
        &#125;
    
        /**
         * 列出所有指数
         * @return mixed
         */
        public function listIndex()
        &#123;
            $param = [
                &#39;index&#39; =&gt; static::BGC_FUN_META,
                &#39;type&#39;  =&gt; &#39;_doc&#39;,
                &#39;from&#39;  =&gt; 0,
                &#39;size&#39;  =&gt; 100,
                &#39;body&#39;  =&gt; [],
            ];
    
            $resp = $this-&gt;client-&gt;search($param);
            list($total, $hits) = $this-&gt;get_hits($resp);
            $ret  = $this-&gt;search_result($total, $hits, $resp);
    
            return $ret;
        &#125;
    
        /**
         * 使用提供的内容更新索引/文档
         * @param string $index_name
         * @param string $type
         * @param $id
         * @param array $content
         * @return mixed
         */
        public function updateIndexDoc(string $index_name, string $type, $id, array $content)
        &#123;
            $param = [
                &#39;index&#39; =&gt; $index_name,
                &#39;type&#39; =&gt; $type,
                &#39;id&#39; =&gt; $id,
                &#39;body&#39; =&gt; $content,
            ];
            $resp = $this-&gt;client-&gt;index($param);
            $success = $this-&gt;shards_successful($resp);
    
            return $success;
        &#125;
    
        /**
         * 根据索引删除文档
         * @param string $index_name
         * @param string $type
         * @param $id
         * @return bool
         */
        public function dropIndexDoc(string $index_name, string $type, $id)
        &#123;
            $param = [
                &#39;index&#39; =&gt; $index_name,
                &#39;type&#39;  =&gt; $type,
                &#39;id&#39;    =&gt; $id,
            ];
            $resp = $this-&gt;client-&gt;delete($param);
            $success = $this-&gt;shards_successful($resp);
    
            return $success;
        &#125;
    
        /**
         * 检查请求是否得到确认
         * @param array $resp
         * @return bool
         */
        protected function is_acknowledged(array &amp;$resp)
        &#123;
            return (isset($resp[&#39;acknowledged&#39;]) &amp;&amp; $resp[&#39;acknowledged&#39;]);
        &#125;
    
        /**
         * 检查插入/更新请求是否被接受
         * @param array $resp
         * @return bool
         */
        protected function shards_successful(array &amp;$resp)
        &#123;
            return (isset($resp[&#39;_shards&#39;]) &amp;&amp; $resp[&#39;_shards&#39;][&#39;successful&#39;] &gt; 0);
        &#125;
    
        /**
         * 获取提供的索引的数据库映射
         * @param string $index_name
         * @return array
         */
        protected function get_db_mapping(string $index_name)
        &#123;
            $config = config(&quot;search-engine.elastic.db_mapping.&#123;$index_name&#125;&quot;);
    
            if (is_null($config)) return [null, null];
            if (!isset($config[&#39;db_table&#39;]) || !isset($config[&#39;db_sql&#39;])) return [null, null];
    
            $table_name = $config[&#39;db_table&#39;];
            $sql        = $config[&#39;db_sql&#39;];
            $table_name = preg_replace(&#39;/\s/&#39;, &#39;&#39;, $table_name);
    
            return array($table_name, $sql);
        &#125;
    
        /**
         * 获取索引的更新时间
         * @param string $index_name
         * @return bool|int
         */
        protected function update_time4index(string $index_name)
        &#123;
            list($table_name) = $this-&gt;get_db_mapping($index_name);
            $db_update_name   = intval($this-&gt;get_db_last_update_time($table_name));
            $search_ret       = $this-&gt;searchSimpleMatch(static::BGC_FUN_META, &#39;_doc&#39;, &#39;index_name&#39;, $index_name);
    
            if (0 == count($search_ret[&#39;hits&#39;])) &#123;
                LogTool::warning(&quot;try to check should_update_index of $index_name, no meta hits.&quot;);
    
                return false;
            &#125;
            $se_update_time = $search_ret[&#39;hits&#39;][0][&#39;_source&#39;][&#39;last_updated&#39;];
            if (0 === $se_update_time) return 0;
    
            return ($se_update_time &lt; $db_update_name ? $db_update_name : false);
        &#125;
    
        /**
         * 获取表的最后更新时间
         * @param string $table_name
         * @return int|null
         */
        protected function get_db_last_update_time(string $table_name)
        &#123;
            $db_default = config(&#39;database.default&#39;);
            $db_name    = config(&quot;database.connections.&#123;$db_default&#125;.database&quot;);
            $conditions = [
                [&#39;table_schema&#39;, &#39;=&#39;, $db_name],
                [&#39;table_name&#39;, &#39;=&#39;, $table_name],
            ];
    
            $data = DB::table(&#39;information_schema.tables&#39;)
                -&gt;where($conditions)
                -&gt;selectSub(&#39;UNIX_TIMESTAMP(update_time)&#39;, &#39;update_time&#39;)
                -&gt;get();
    
            $ret = (isset($data[0]-&gt;update_time) ? intval($data[0]-&gt;update_time) : null);
    
            return $ret;
        &#125;
    
        /**
         * 检查搜索结果的命中总和和当前命中
         * @param array $resp
         * @return array
         */
        protected function get_hits(array &amp;$resp)
        &#123;
            // Laravel: $resp[&#39;hits&#39;][&#39;total&#39;][&#39;value&#39;] |BUT| Lumen:$resp[&#39;hits&#39;][&#39;total&#39;]
            $total = isset($resp[&#39;hits&#39;][&#39;total&#39;]) ? $resp[&#39;hits&#39;][&#39;total&#39;][&#39;value&#39;] : 0;
            if (isset($resp[&#39;hits&#39;][&#39;hits&#39;]) &amp;&amp; ($hit_count = count($resp[&#39;hits&#39;][&#39;hits&#39;])) &gt; 0) &#123;
                return array($total, $hit_count);
            &#125;
    
            return array($total, 0);
        &#125;
    
        /**
         * 返回搜索结果
         * @param int $total
         * @param int $hits
         * @param array $resp
         * @return mixed
         */
        protected function search_result(int $total, int $hits, array &amp;$resp)
        &#123;
            if ($hits &gt; 0) &#123;
                $ret = [
                    &#39;total&#39; =&gt; $total,
                    &#39;hits&#39;  =&gt; $resp[&#39;hits&#39;][&#39;hits&#39;],
                ];
            &#125; else &#123;
                $ret = [
                    &#39;total&#39; =&gt; $total,
                    &#39;hits&#39;  =&gt; [],
                ];
            &#125;
    
            return $ret;
        &#125;
    
        /**
         * 使用数据库的数据批量插入/更新索引
         * @param string $index_name
         * @param string $type
         * @param iterable $data
         * @return bool
         */
        protected function bulk_update_index(string $index_name, string $type, iterable &amp;$data)
        &#123;
            $param = [];
            foreach ($data as $datum) &#123;
                $index = [
                    &#39;_index&#39; =&gt; $index_name,
                    &#39;_type&#39;  =&gt; $type,
                ];
                if (isset($datum-&gt;id)) &#123;
                    $index[&#39;_id&#39;] = $datum-&gt;id;
                &#125;
                $param[&#39;body&#39;][] = [
                    &#39;index&#39; =&gt; $index,
                ];
                $d = (array)($datum);
                $param[&#39;body&#39;][] = $d;
            &#125;
            $resp = $this-&gt;client-&gt;bulk($param);
            $success = $this-&gt;bulk_succeed($resp);
    
            return $success;
        &#125;
    
        /**
         * 检查批量插入是否成功
         * @param array $resp
         * @return bool
         */
        protected function bulk_succeed(array &amp;$resp)
        &#123;
            return (isset($resp[&#39;errors&#39;]) &amp;&amp; !$resp[&#39;errors&#39;]);
        &#125;
    
        /**
         * 解析查询字符串,返回ElasticSearch查询子句
         * @param string $query
         * @param bool $exact
         * @return array
         */
        protected function parse_query(string $query, bool $exact = false)
        &#123;
            // term:精准查询 match:模糊匹配
            $method = $exact ? &#39;term&#39; : &#39;match&#39;;
            [$field, $value] = explode(&#39;=&#39;, $query);
            $param  = [
                $method =&gt; [
                    trim($field) =&gt; trim($value),
                ]
            ];
            $words  = [trim($value)];
    
            return [$param, $words];
        &#125;
    
        /**
         * 简单搜索具有精准匹配的字段
         * @param string $index_name
         * @param string $type
         * @param string $field
         * @param string $needle
         * @param bool $exact
         * @return mixed
         */
        public function searchSimpleMatch(
            string $index_name,
            string $type,
            string $field,
            string $needle,
            bool $exact = false
        ) &#123;
            $method = $exact ? &#39;term&#39; : &#39;match&#39;;
            $param  = [
                &#39;index&#39; =&gt; $index_name,
                &#39;type&#39;  =&gt; $type,
                &#39;body&#39;  =&gt; [
                    &#39;query&#39; =&gt; [
                        $method =&gt; [
                            $field =&gt; $needle,
                        ],
                    ],
                ],
            ];
            $resp = $this-&gt;client-&gt;search($param);
            list($total, $hits) = $this-&gt;get_hits($resp);
            $ret  = $this-&gt;search_result($total, $hits, $resp);
    
            return $ret;
        &#125;
    
        /**
         * 查询索引
         * @param string $index_name
         * @param string $type
         * @param array $query_body
         * @param array $search_words
         * @param int $page
         * @param int $page_size
         * @param bool $collect_source
         * @param callable|null $cb
         * @return array|mixed
         */
        public function queryIndexWithClause(
            string $index_name,
            string $type,
            array $query_body,
            array $search_words,
            int $page,
            int $page_size = self::DEFAULT_PAGE_SIZE,
            bool $collect_source = false,
            callable $cb = null
        ) &#123;
            if ($page &lt; 1) $page = 1;
            $param = [
                &#39;index&#39; =&gt; $index_name,
                &#39;type&#39;  =&gt; $type,
                &#39;body&#39;  =&gt; $query_body,
                &#39;from&#39;  =&gt; ($page - 1) * $page_size,
                &#39;size&#39;  =&gt; $page_size,
            ];
            $resp = $this-&gt;client-&gt;search($param);
            list($total, $hits) = $this-&gt;get_hits($resp);
            $ret  = $this-&gt;search_result($total, $hits, $resp);
            if (1 === $resp &amp;&amp; !in_array($index_name, [static::BGC_FUN_META, static::SEARCH_HOT_WORD]) &amp;&amp;
                $total &gt; 0
            ) &#123;
                foreach ($search_words as $word) &#123;
                    if (!empty($word)) &#123;
                        $this-&gt;updateHotWord($index_name, $word);
                    &#125;
                &#125;
            &#125;
            if ($collect_source) &#123;
                $ret = $this-&gt;collectSource($ret);
            &#125;
            if (is_callable($cb)) &#123;
                $ret = $cb($ret);
            &#125;
    
            return $ret;
        &#125;
    
        /**
         * 使用指定的模式查询索引
         * @param int $pattern_no
         * @param string $needle
         * @param int $page
         * @param int $page_size
         * @param bool $collect_source
         * @param callable|null $cb
         * @return array|mixed|null
         */
        public function queryWithPattern(
            int $pattern_no,
            string $needle,
            int $page,
            int $page_size = self::DEFAULT_PAGE_SIZE,
            bool $collect_source = false,
            callable $cb = null
        ) &#123;
            $config = config(&quot;search-query.&#123;$pattern_no&#125;&quot;);
            if (null === $config) &#123;
                return null;
            &#125;
            $config_txt = json_encode($config);
            $config_txt = str_replace(&#39;&quot;?&quot;&#39;, &#39;&quot;&#39; . $needle . &#39;&quot;&#39;, $config_txt);
            $config     = json_decode($config_txt, true);
            $type       = $config[&#39;type&#39;] ?? &#39;text&#39;;
            $data       = $this-&gt;queryIndexWithClause(
                $config[&#39;index&#39;], $type, $config[&#39;body&#39;], [$needle], $page, $page_size, $collect_source
            );
            if (is_callable($cb)) &#123;
                $data   = $cb($data);
            &#125;
    
            return $data;
        &#125;
    
        /**
         * 更新热词列表
         * @param string $index_name
         * @param string $word
         */
        public function updateHotWord(string $index_name, string $word)
        &#123;
            $entry = null;
            $id    = &quot;$index_name:$word&quot;;
    
            try &#123;
                if (null === $entry) &#123;
                    $this-&gt;updateIndexDoc(static::SEARCH_HOT_WORD, &#39;_doc&#39;, $id, [
                        &#39;count&#39;       =&gt; 1,
                        &#39;word&#39;        =&gt; $word,
                        &#39;index_name&#39;  =&gt; $index_name,
                        &#39;last_update&#39; =&gt; time(),
                    ]);
                &#125; else &#123;
                    $this-&gt;client-&gt;update([
                        &#39;index&#39; =&gt; static::SEARCH_HOT_WORD,
                        &#39;type&#39;  =&gt; &#39;_doc&#39;,
                        &#39;id&#39;    =&gt; $id,
                        &#39;body&#39;  =&gt; [
                            &#39;script&#39; =&gt; [
                                &#39;lang&#39;   =&gt; &#39;painless&#39;,
                                &#39;inline&#39; =&gt; &#39;ctx._source.count = ctx._source.count + 1&#39;,
                            ],
                            &#39;last_update&#39; =&gt; time(),
                        ],
                    ]);
                &#125;
    
            &#125; catch (\Exception $e) &#123;
                LogTool::warning(&quot;fail to update hot word for $word&quot;);
            &#125;
        &#125;
    
        /**
         * 移除热词
         * @param int $before
         * @return mixed
         */
        public function removeOldHotWord(int $before)
        &#123;
            $timestamp = $before;
            $resp = $this-&gt;client-&gt;deleteByQuery([
                &#39;index&#39; =&gt; static::SEARCH_HOT_WORD,
                &#39;type&#39;  =&gt; &#39;_doc&#39;,
                &#39;body&#39;  =&gt; [
                    &#39;query&#39; =&gt; [
                        &#39;range&#39; =&gt; [
                            &#39;last_update&#39; =&gt; [
                                &#39;lt&#39; =&gt; $timestamp,
                            ],
                        ],
                    ],
                ],
            ]);
    
            return $this-&gt;count_deleted($resp);
        &#125;
    
        /**
         * 返回已删除数量
         * @param array $resp
         * @return bool
         */
        protected function count_deleted(array &amp;$resp)
        &#123;
            if (!isset($resp[&#39;deleted&#39;])) return false;
    
            return $resp[&#39;deleted&#39;];
        &#125;
    
        /**
         * 从搜索结果中收集所有源数据
         * @param array $result
         * @return array
         */
        public static function collectSource(array $result)
        &#123;
            $ret       = [];
            $highlight = [];
            $hits      = isset($result[&#39;hits&#39;]) ? $result[&#39;hits&#39;] : $result;
            $count     = 0;
    
            foreach ($hits as $hit) &#123;
                if (isset($hit[&#39;_source&#39;])) &#123;
                    $ret[$count] = $hit[&#39;_source&#39;];
                    if (isset($hit[&#39;highlight&#39;])) &#123;
                        $h = [];
                        foreach ($hit[&#39;highlight&#39;] as $key =&gt; $value) &#123;
                            $h[$key] = str_replace(&#39;&lt;/em&gt;&lt;em&gt;&#39;, &#39;&#39;, $value[0]);
                        &#125;
                        $highlight[$count] = $h;
                    &#125;
                    $count++;
                &#125;
            &#125;
            foreach ($ret as $key =&gt; $value) &#123;
                if (isset($highlight[$key])) &#123;
                    $ret[$key] = array_merge($ret[$key], $highlight[$key]);
                &#125;
            &#125;
    
            return $ret;
        &#125;
    &#125;
</code></pre>

        
      
    </div>

    <footer class="article-footer">
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>本文作者:  </strong>CAO XIAN LIANG</a>
          </li>
          <li class="post-copyright-link">
          <strong>本文链接:  </strong>
          <a href="/2019/07/09/Laravel-ElasticSearch/" target="_blank" title="基于Laravel使用ElasticSearch">http://blog.caoxl.com/2019/07/09/Laravel-ElasticSearch/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明:   </strong>
            本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            许可协议。转载请注明出处
          </li>
         
        </ul>
<div>

      
      
      
      
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ElasticSearch/" rel="tag">ElasticSearch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Laravel/" rel="tag">Laravel</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/07/10/Laravel-Elasticsearch-Search/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          ElasticSearch 查询
        
      </div>
    </a>
  
  
    <a href="/2019/07/03/Elasticsearch-Go-MySQL-IK-Kibana/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">Elasticsearch 使用记录</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%9F%E8%AF%9D%E4%B8%8D%E5%A4%9A%E8%AF%B4-%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BB%A3%E7%A0%81"><span class="nav-number">1.</span> <span class="nav-text">废话不多说,直接上代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Commands"><span class="nav-number">2.</span> <span class="nav-text">Commands</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CreateIndex"><span class="nav-number">2.1.</span> <span class="nav-text">CreateIndex</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">2.1.1.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UpdateIndex"><span class="nav-number">2.2.</span> <span class="nav-text">UpdateIndex</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="nav-number">2.2.1.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ClearIndex"><span class="nav-number">2.3.</span> <span class="nav-text">ClearIndex</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-2"><span class="nav-number">2.3.1.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DropIndex"><span class="nav-number">2.4.</span> <span class="nav-text">DropIndex</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-3"><span class="nav-number">2.4.1.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ListIndex"><span class="nav-number">2.5.</span> <span class="nav-text">ListIndex</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-4"><span class="nav-number">2.5.1.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QueryIndex"><span class="nav-number">2.6.</span> <span class="nav-text">QueryIndex</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-5"><span class="nav-number">2.6.1.</span> <span class="nav-text">使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service"><span class="nav-number">3.</span> <span class="nav-text">Service</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2017 - 2023 Keep It Simple And Stupid All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>




<script src="/js/scripts.js"></script>





  
<script src="/js/dialog.js"></script>









	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Keep It Simple And Stupid
          </div>
          <div class="panel-body">
            Copyright © 2023 CAO XIAN LIANG All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>